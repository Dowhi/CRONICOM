<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chronicon - Calendario Medieval</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts: Tipograf칤a Medieval -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@400;600;700&family=Almendra:ital,wght@0,400;0,700;1,400;1,700&family=Marcellus&family=Spectral:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@400;700&family=Outfit:wght@400;700&family=Bangers&family=Roboto+Condensed:wght@400;700&family=Playfair+Display:wght@400;700;900&family=Arvo:wght@400;700&family=Special+Elite&display=swap"
        rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --app-font-size: 16px;

            /* Fonts */
            --font-main: 'Almendra', serif;
            --font-header: 'Cinzel', serif;
            --font-accent: 'MedievalSharp', cursive;

            /* Colors - Default (Medieval) */
            --bg-body: #F4EBD0;
            --bg-surface: #E6D5B8;
            --bg-surface-dark: #D8C7A8;
            --bg-header-gradient: linear-gradient(135deg, #E44D2E 0%, #6B1F2A 100%);
            --bg-nav-gradient: linear-gradient(to bottom, #7e4a1e 0%, #4a2c0d 100%);
            --bg-secondary-gradient: linear-gradient(135deg, #26619C 0%, #152A5E 100%);

            --text-main: #2B2621;
            --text-muted: #704214;
            --text-gold: #D4AF37;
            --text-light: #F4EBD0;
            --text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

            --accent-gold: #D4AF37;
            --accent-blue: #26619C;
            --accent-red: #E44D2E;
            --accent-dark: #191970;

            --border-style: double;
            --border-color: #D4AF37;
            --border-width: 3px;
            --border-radius: 4px;
            --border-radius-lg: 12px;

            --shadow-ui: 0 4px 12px rgba(0, 0, 0, 0.3);
            --body-mask: url("data:image/svg+xml,%3Csvg width='200' height='200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            --body-mask-opacity: 1;

            /* Old variables for compatibility during transition */
            --parchment: var(--bg-body);
            --parchment-dark: var(--bg-surface);
            --sepia: var(--text-muted);
            --midnight-blue: var(--accent-dark);
            --lapis-lazuli: var(--accent-blue);
            --cinnabar: var(--accent-red);
            --iron-gall: var(--text-main);
            --gold-leaf: var(--accent-gold);
        }

        /* --- THEME: CYBER-FAMILY --- */
        body.theme-cyber {
            --font-main: 'Inter', sans-serif;
            --font-header: 'Outfit', sans-serif;
            --font-accent: 'Outfit', sans-serif;

            --bg-body: #0F172A;
            --bg-surface: rgba(30, 41, 59, 0.7);
            --bg-surface-dark: rgba(15, 23, 42, 0.8);
            --bg-header-gradient: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            --bg-nav-gradient: linear-gradient(to bottom, #1E293B 0%, #0F172A 100%);
            --bg-secondary-gradient: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);

            --text-main: #F8FAFC;
            --text-muted: #94A3B8;
            --text-gold: #38BDF8;
            --text-light: #F8FAFC;
            --text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);

            --accent-gold: #38BDF8;
            --accent-blue: #818CF8;
            --accent-red: #F43F5E;
            --accent-dark: #0F172A;

            --border-style: solid;
            --border-color: rgba(56, 189, 248, 0.3);
            --border-width: 1px;
            --border-radius: 50px;
            --border-radius-lg: 20px;

            --shadow-ui: 0 8px 32px rgba(0, 0, 0, 0.4);
            --body-mask: none;
            --body-mask-opacity: 0;
            backdrop-filter: blur(10px);
        }

        /* --- THEME: POP-ART (COMIC) --- */
        body.theme-comic {
            --font-main: 'Roboto Condensed', sans-serif;
            --font-header: 'Bangers', cursive;
            --font-accent: 'Bangers', cursive;

            --bg-body: #FFFFFF;
            --bg-surface: #FFDE00;
            --bg-surface-dark: #EEEEEE;
            --bg-header-gradient: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);
            --bg-nav-gradient: linear-gradient(to bottom, #0055FF 0%, #0033AA 100%);
            --bg-secondary-gradient: linear-gradient(135deg, #FFDE00 0%, #FFCC00 100%);

            --text-main: #1A1A1A;
            --text-muted: #444444;
            --text-gold: #1A1A1A;
            --text-light: #FFFFFF;
            --text-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2);

            --accent-gold: #FFDE00;
            --accent-blue: #0055FF;
            --accent-red: #FF0000;
            --accent-dark: #1A1A1A;

            --border-style: solid;
            --border-color: #1A1A1A;
            --border-width: 3px;
            --border-radius: 4px;
            --border-radius-lg: 8px;

            --shadow-ui: 6px 6px 0px rgba(0, 0, 0, 1);
            --body-mask: radial-gradient(#ccc 10%, transparent 11%);
            --body-mask-opacity: 0.1;
        }

        /* --- THEME: WILD WEST --- */
        body.theme-wildwest {
            --font-main: 'Arvo', serif;
            --font-header: 'Playfair Display', serif;
            --font-accent: 'Special Elite', cursive;

            --bg-body: #D2B48C;
            --bg-surface: #A08060;
            --bg-surface-dark: #8B4513;
            --bg-header-gradient: linear-gradient(135deg, #5D4037 0%, #3E2723 100%);
            --bg-nav-gradient: linear-gradient(to bottom, #8B4513 0%, #5D4037 100%);
            --bg-secondary-gradient: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);

            --text-main: #3D2B1F;
            --text-muted: #5D4037;
            --text-gold: #FFD700;
            --text-light: #F5F5DC;
            --text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);

            --accent-gold: #FFD700;
            --accent-blue: #4E342E;
            --accent-red: #B22222;
            --accent-dark: #212121;

            --border-style: dashed;
            --border-color: rgba(61, 43, 31, 0.5);
            --border-width: 2px;
            --border-radius: 2px;
            --border-radius-lg: 4px;

            --shadow-ui: 2px 2px 5px rgba(0, 0, 0, 0.4);
            --body-mask: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            --body-mask-opacity: 0.2;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.5s, color 0.5s;
        }

        /* Textura de Fondo */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--body-mask);
            background-size: 200px 200px;
            opacity: var(--body-mask-opacity);
            pointer-events: none;
            z-index: 1;
        }

        /* Header - Escudo Real */
        .header {
            background: var(--bg-header-gradient);
            color: var(--text-gold);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-ui);
            border-bottom: var(--border-width) var(--border-style) var(--border-color);
            position: relative;
            z-index: 100;
            font-family: var(--font-header);
            font-weight: 700;
            text-shadow: var(--text-shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .header-title {
            font-size: 20px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: var(--border-width) var(--border-style) var(--border-color);
            color: var(--text-gold);
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-family: var(--font-accent);
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Navegaci칩n por Pesta침as */
        .tab-nav {
            background: var(--bg-nav-gradient);
            display: flex;
            border-bottom: var(--border-width) var(--border-style) var(--border-color);
            box-shadow: var(--shadow-ui);
            position: relative;
            z-index: 99;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 14px 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: var(--font-header);
            position: relative;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            box-shadow: inset 0 -4px 0 var(--accent-gold);
            text-shadow: var(--text-shadow);
        }

        .tab-btn::before {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: var(--accent-gold);
            transition: height 0.3s;
        }

        .tab-btn.active::before {
            height: 3px;
        }

        .tab-btn:hover {
            background: rgba(212, 175, 55, 0.15);
        }

        /* Navegaci칩n de Mes */
        .month-nav {
            background: var(--bg-secondary-gradient);
            padding: 4px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: var(--border-width) var(--border-style) var(--border-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 98;
            min-height: 36px;
        }

        .month-nav button {
            background: rgba(255, 255, 255, 0.1);
            border: var(--border-width) var(--border-style) var(--border-color);
            color: var(--text-gold);
            padding: 8px 12px;
            font-size: 20px;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-family: var(--font-header);
            font-weight: 700;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .month-nav button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .month-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-gold);
            font-family: var(--font-header);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: var(--text-shadow);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            padding: 0;
            overflow: hidden;
        }

        /* Calendario - Ocupar todo el espacio disponible */
        .calendar-view.active {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        /* Vista de Inicio */
        .home-view {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .home-view.active {
            display: flex;
        }

        .greeting-card {
            background: var(--bg-surface);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 8px 15px;
            box-shadow: var(--shadow-ui);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 10px;
        }

        .greeting-text {
            text-align: left;
            flex: 1;
        }

        .greeting-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--gold-leaf);
            background: var(--parchment);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .greeting-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .greeting-title {
            font-family: var(--font-header);
            font-size: 1.4em;
            color: var(--accent-red);
            margin-bottom: 2px;
            font-weight: bold;
        }

        .date-display {
            font-family: var(--font-main);
            font-size: 0.9em;
            color: var(--text-muted);
            opacity: 0.8;
        }

        .summary-cards {
            display: flex !important;
            flex-direction: row !important;
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            flex: 1;
            background: var(--bg-surface);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 8px;
            text-align: center;
            box-shadow: var(--shadow-ui);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 50px;
        }

        .summary-card .count {
            font-family: var(--font-header);
            font-size: 2em;
            color: var(--accent-red);
            font-weight: bold;
            line-height: 1;
        }

        .summary-card .label {
            font-family: var(--font-main);
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .home-section-title {
            font-family: var(--font-header);
            font-size: 1em;
            color: var(--accent-red);
            text-transform: uppercase;
            border-bottom: var(--border-width) var(--border-style) var(--border-color);
            padding-bottom: 3px;
            margin: 10px 0 6px 0;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .home-events-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .home-event-item {
            background: var(--bg-surface);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-ui);
            transition: all 0.3s;
        }

        .home-event-item:hover {
            transform: translateY(-2px);
            filter: brightness(1.05);
        }

        .home-event-time {
            font-family: 'Cinzel', serif;
            font-weight: bold;
            color: var(--lapis-lazuli);
            font-size: 0.95em;
            min-width: 50px;
        }

        .home-event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
        }

        .home-event-title {
            font-family: 'Almendra', serif;
            font-size: 1em;
            color: var(--iron-gall);
            flex: 1;
        }

        .home-mini-calendar {
            background: white;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .mini-header-day {
            text-align: center;
            font-size: 0.7em;
            font-family: 'Cinzel', serif;
            color: #777;
            padding-bottom: 5px;
        }

        .mini-day {
            min-height: 70px;
            max-height: 70px;
            overflow: hidden;
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            padding: 2px;
            font-size: 0.7em;
            position: relative;
            background: #fafafa;
            display: flex;
            flex-direction: column;
        }

        .mini-day.today {
            border: 2px solid var(--cinnabar);
            background: white;
        }

        .mini-day.other-month {
            opacity: 0.3;
        }

        .mini-day:hover {
            border-color: var(--gold-leaf);
            z-index: 10;
        }

        .mini-day-num {
            font-weight: bold;
            text-align: center;
            margin-bottom: 2px;
            font-family: 'MedievalSharp', cursive;
        }

        .mini-event-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
            justify-content: center;
        }

        .mini-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--lapis-lazuli);
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }

        .summary-card .label {
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            color: var(--sepia);
            margin-top: 4px;
        }

        /* Calendario Mensual */
        .calendar-view {
            display: none;
        }

        .calendar-view.active {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
            overflow: hidden;
            height: 100%;
        }

        .calendar-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            grid-template-rows: auto repeat(6, 1fr);
            gap: 1px;
            background: var(--border-color);
            padding: 0;
            border: none;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }

        .weekday-header {
            background: var(--accent-blue);
            color: var(--text-gold);
            padding: 1px 2px;
            text-align: center;
            font-family: var(--font-accent);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            border: 1px solid var(--border-color);
            border-radius: 2px;
        }

        .calendar-day {
            background: var(--bg-body);
            border: 0.5px solid var(--border-color);
            min-height: 0;
            height: 100%;
            padding: 4px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-day:hover {
            background: var(--bg-surface);
            transform: scale(1.02);
            box-shadow: var(--shadow-ui);
        }

        .calendar-day.today {
            border: 4px solid var(--accent-red) !important;
            box-shadow: 0 0 15px var(--accent-red), inset 0 0 10px rgba(0, 0, 0, 0.1) !important;
            position: relative;
            z-index: 5;
        }

        /* Indicador de Sello Real para Hoy */
        .calendar-day.today::after {
            content: "游늸";
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            filter: drop-shadow(0 0 2px white);
        }

        .calendar-day.other-month {
            opacity: 0.4;
            background: rgba(244, 228, 188, 0.5);
        }

        .day-number {
            font-family: var(--font-header);
            font-size: 12px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 2px;
            line-height: 1;
        }

        .day-events {
            flex: 1;
            font-size: 10px;
            color: var(--text-muted);
            font-family: var(--font-main);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        /* Vista Anual */
        .year-view {
            display: none;
        }

        .year-view.active {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            overflow: hidden;
            max-width: 100vw;
        }

        .year-nav {
            background: var(--bg-surface-dark);
            padding: 2px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: var(--border-width) var(--border-style) var(--border-color);
            margin-bottom: 0;
            border-radius: 0;
            min-height: 42px;
            box-sizing: border-box;
            box-shadow: var(--shadow-ui);
        }

        .year-nav button {
            background: var(--bg-surface);
            border: calc(var(--border-width)/1.5) var(--border-style) var(--border-color);
            color: var(--text-main);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .year-nav button:hover {
            background: rgba(212, 175, 55, 0.4);
            transform: scale(1.1);
        }

        .year-title {
            font-family: var(--font-header);
            font-size: 20px;
            color: var(--accent-red);
            font-weight: 700;
            text-shadow: none;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .year-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            padding: 5px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            box-sizing: border-box;
            background: transparent;
        }

        .year-grid::-webkit-scrollbar {
            display: none;
        }

        .year-month {
            background: var(--bg-surface);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius);
            padding: 4px;
            box-shadow: var(--shadow-ui);
            width: 100%;
            box-sizing: border-box;
        }

        .year-month-header {
            font-family: var(--font-header);
            font-size: 14px;
            color: var(--accent-red);
            text-align: center;
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .year-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .year-day {
            aspect-ratio: 1;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            background: var(--bg-body);
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .year-day:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }

        .year-day-number {
            font-family: var(--font-main);
            font-weight: 600;
            color: var(--text-main);
        }

        /* Modal de D칤a */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--parchment);
            border: 6px double var(--gold-leaf);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--cinnabar) 0%, #6B1F2A 100%);
            color: var(--gold-leaf);
            padding: 16px;
            border-bottom: 3px double var(--gold-leaf);
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .modal-body {
            padding: 20px;
        }

        .notes-list {
            margin-bottom: 16px;
        }

        .note-item {
            background: var(--parchment-dark);
            border: 2px solid var(--gold-leaf);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-family: 'Almendra', serif;
            position: relative;
        }

        .note-time {
            font-size: 12px;
            color: var(--sepia);
            font-style: italic;
            margin-bottom: 4px;
        }

        .note-text {
            color: var(--iron-gall);
            font-size: 14px;
        }

        .btn-new-note {
            width: 100%;
            background: linear-gradient(135deg, var(--lapis-lazuli) 0%, #152A5E 100%);
            border: 3px solid var(--gold-leaf);
            color: var(--gold-leaf);
            padding: 12px;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-new-note:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: 3px solid;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-accept {
            background: var(--lapis-lazuli);
            border-color: var(--gold-leaf);
            color: var(--gold-leaf);
        }

        .btn-cancel {
            background: var(--parchment-dark);
            border-color: var(--sepia);
            color: var(--sepia);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Modal de Notas */
        .notes-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .notes-modal.show {
            display: flex;
        }

        .notes-modal-content {
            background: var(--parchment);
            border: 6px double var(--gold-leaf);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 768px) {
            .notes-modal-content {
                width: calc(100vw - 24px);
            }

            .notes-controls,
            .modal-actions {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .modal-actions .btn,
            .notes-controls .btn {
                flex: 1;
                min-width: 140px;
            }
        }

        .notes-header {
            background: linear-gradient(135deg, var(--cinnabar) 0%, #6B1F2A 100%);
            color: var(--gold-leaf);
            padding: 16px;
            border-bottom: 3px double var(--gold-leaf);
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-body {
            padding: 20px;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            background: var(--bg-surface-dark);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            font-family: var(--font-main);
            font-size: 16px;
            color: var(--text-main);
            resize: vertical;
        }

        .notes-controls {
            margin-top: 16px;
        }

        .notes-control-group {
            margin-bottom: 12px;
        }

        .notes-label {
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            color: var(--sepia);
            margin-bottom: 6px;
            display: block;
        }

        .notes-input {
            width: 100%;
            padding: 8px;
            background: var(--bg-surface-dark);
            border: calc(var(--border-width)/1.5) var(--border-style) var(--border-color);
            border-radius: var(--border-radius);
            font-family: var(--font-main);
            font-size: 14px;
            color: var(--text-main);
        }

        .notes-select {
            width: 100%;
            padding: 8px;
            background: var(--bg-surface-dark);
            border: calc(var(--border-width)/1.5) var(--border-style) var(--border-color);
            border-radius: var(--border-radius);
            font-family: var(--font-main);
            font-size: 14px;
            color: var(--text-main);
        }

        /* Botones de Acci칩n Inferiores */
        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--sepia) 0%, var(--ocher) 100%);
            border-top: 3px double var(--gold-leaf);
            padding: 12px;
            display: flex;
            gap: 12px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* Modal de Turnos para Pintar */
        .shifts-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--parchment);
            border-top: 3px solid var(--gold-leaf);
            display: none;
            flex-direction: row;
            align-items: center;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            padding: 0 8px;
            gap: 2px;
            height: 48px;
            /* Reducido de 56px */
        }

        .shifts-popup.show {
            display: flex;
        }

        .shifts-popup-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: var(--cinnabar);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .shifts-popup-close {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid var(--gold-leaf);
            color: var(--gold-leaf);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'MedievalSharp', cursive;
            transition: all 0.3s;
        }

        .shifts-popup-close:hover {
            background: rgba(212, 175, 55, 0.4);
            transform: rotate(90deg);
        }

        .shifts-scroll {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 8px;
            align-items: center;
        }

        .shifts-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .shift-button-paint {
            background: var(--lapis-lazuli);
            border: 2px solid var(--gold-leaf);
            color: var(--gold-leaf);
            padding: 4px 8px;
            /* Reducido */
            border-radius: 4px;
            font-family: 'MedievalSharp', cursive;
            font-size: 11px;
            /* Reducido */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            min-width: 70px;
            /* Reducido de 100px */
            white-space: nowrap;
        }

        .shift-button-paint:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .shift-button-delete {
            background: var(--cinnabar);
            border: 2px solid var(--gold-leaf);
            color: var(--gold-leaf);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'MedievalSharp', cursive;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .shift-button-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .shift-button-paint.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .action-btn {
            flex: 1;
            background: rgba(212, 175, 55, 0.2);
            border: 3px solid var(--gold-leaf);
            color: var(--gold-leaf);
            padding: 12px;
            border-radius: 6px;
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            background: rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        /* Sistema de Mensajes (sin alert) */
        .message-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: none;
        }

        .message-container.show {
            display: block;
        }

        .message-box {
            background: var(--parchment);
            border: 4px double var(--gold-leaf);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            min-width: 300px;
            max-width: 90vw;
            font-family: 'Almendra', serif;
            text-align: center;
        }

        .message-title {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            color: var(--cinnabar);
            margin-bottom: 12px;
            font-weight: 700;
        }

        .message-text {
            font-size: 16px;
            color: var(--iron-gall);
            margin-bottom: 16px;
        }

        .message-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--parchment);
            border: 3px solid var(--gold-leaf);
            color: var(--iron-gall);
            padding: 12px 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', cursive;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: toast-in 0.3s ease-out, toast-out 0.3s ease-in 2.7s forwards;
        }

        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toast-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {

            html,
            body {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .header,
            .tab-nav,
            .month-nav,
            .main-content,
            .calendar-view,
            .year-view,
            #summaryView {
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }

            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }

            .day-number {
                font-size: 12px;
            }

            .day-events {
                font-size: 9px;
            }

            .summary-cards {
                grid-template-columns: 1fr !important;
            }

            .home-events-list {
                grid-template-columns: 1fr 1fr !important;
            }

            #summaryView>div {
                grid-template-columns: 1fr !important;
            }

            .modal-content,
            .notes-modal-content {
                max-width: 94vw;
            }

            .notes-body,
            .modal-body {
                padding: 12px;
            }

            .btn,
            .action-btn,
            .header-btn {
                min-height: 44px;
            }

            .tab-btn {
                padding: 10px 6px;
                font-size: 11px;
            }

            .month-nav button {
                padding: 6px 10px;
                font-size: 18px;
            }

            .month-title {
                font-size: 14px;
            }

            .calendar-grid {
                gap: 1px;
                padding: 2px;
            }

            .weekday-header {
                padding: 1px 2px;
                font-size: 10px;
            }

            #monthFilters {
                flex-wrap: wrap;
            }

            #monthFilters select {
                min-width: 120px !important;
                width: auto;
            }

            .modal-content,
            .notes-modal-content {
                width: calc(100vw - 24px);
            }

            #quickMenu {
                min-width: 160px;
            }

            #quickMenu button {
                padding: 10px;
            }
        }

        @media (max-width: 600px) {
            .header {
                padding: 10px 12px;
            }

            .header-title {
                font-size: 16px;
            }

            .header-actions {
                gap: 6px;
            }

            .header-btn {
                padding: 4px 8px;
                font-size: 14px;
            }

            .greeting-title {
                font-size: 20px;
            }

            .summary-card .count {
                font-size: 28px;
            }

            .summary-card .label {
                font-size: 12px;
            }

            .notes-textarea {
                min-height: 160px;
                font-size: 14px;
            }

            .notes-input,
            .notes-select {
                font-size: 13px;
                padding: 6px;
            }

            .btn {
                padding: 10px;
                font-size: 13px;
            }

            .action-btn {
                padding: 10px;
                font-size: 13px;
            }

            .year-title {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .tab-btn {
                font-size: 10px;
                letter-spacing: 0;
            }

            .calendar-day {
                padding: 3px;
            }

            .day-number {
                font-size: 11px;
            }

            .day-events {
                font-size: 8px;
            }

            .modal-header,
            .notes-header {
                font-size: 18px;
                padding: 12px;
            }

            .bottom-actions {
                padding: 10px;
                gap: 10px;
            }

            .shifts-popup {
                max-height: 70vh;
            }

            .shifts-scroll {
                gap: 6px;
                padding: 10px;
            }

            .shift-button-paint,
            .shift-button-delete {
                padding: 10px 14px;
                font-size: 13px;
            }

            .message-box {
                min-width: 240px;
                padding: 16px;
            }

            #quickMenu {
                top: 34px;
            }
        }

        /* Scrollbar Medieval */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--parchment-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gold-leaf);
            border: 2px solid var(--parchment-dark);
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ocher);
        }

        /* Estilos para el Editor de Notas Medieval */
        .notes-editor-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 2px;
        }

        .medieval-textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-surface-dark);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            font-family: var(--font-main);
            font-size: 1.1em;
            color: var(--text-main);
            outline: none;
            overflow-y: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .medieval-format-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 2px 0;
        }

        .format-btn-medieval {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: calc(var(--border-width)/1.5) var(--border-style) var(--border-color);
            background: var(--bg-surface);
            color: var(--accent-red);
            font-family: var(--font-header);
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .format-btn-medieval:hover {
            transform: translateY(-2px);
            background: var(--accent-gold);
            color: var(--text-light);
        }

        .format-btn-medieval.active {
            background: var(--cinnabar);
            color: var(--gold-leaf);
            border-color: var(--parchment);
        }

        .btn.active {
            background: var(--gold-leaf) !important;
            color: var(--midnight-blue) !important;
            border-color: var(--midnight-blue) !important;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .medieval-control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            opacity: 0.9;
        }

        .medieval-label {
            font-family: var(--font-header);
            font-weight: 700;
            font-size: 0.85em;
            color: var(--accent-red);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .medieval-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .medieval-range {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--parchment-dark);
            border-radius: 3px;
            outline: none;
        }

        .medieval-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-red);
            border: 1.5px solid var(--accent-gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .visibility-list {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
            margin-top: 5px;
        }

        .visibility-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Almendra', serif;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .visibility-item:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .visibility-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--cinnabar);
            cursor: pointer;
        }

        .user-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid var(--gold-leaf);
        }

        .shift-chip {
            margin: 1px 0;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid var(--gold-leaf);
        }

        .shift-line {
            font-weight: 700;
            font-size: 0.95em;
            margin-top: 2px;
        }

        /* MODO ZEN - VIGILIA DEL ESCRIBA */
        body.zen-mode .header,
        body.zen-mode .tab-nav,
        body.zen-mode .month-nav,
        body.zen-mode #monthFilters,
        body.zen-mode .bottom-actions,
        body.zen-mode .quick-menu {
            display: none !important;
        }

        body.zen-mode .main-content {
            padding: 20px !important;
            height: 100vh !important;
        }

        body.zen-mode .calendar-grid {
            height: calc(100vh - 40px) !important;
        }

        #zenExitBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10002;
            background: var(--parchment-dark);
            border: 2px solid var(--gold-leaf);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        body.zen-mode #zenExitBtn {
            display: flex;
        }

        /* Compactar modal de eventos recurrentes */
        #recurringModal .modal-body {
            padding: 10px 15px !important;
        }

        #recurringModal .notes-control-group {
            margin-bottom: 6px !important;
        }

        #recurringModal .notes-label {
            margin-bottom: 2px !important;
            font-size: 13px !important;
        }

        #recurringModal .medieval-section {
            margin-bottom: 12px !important;
        }

        #recurringModal .notes-input,
        #recurringModal .notes-select,
        #recurringModal .notes-textarea {
            padding: 4px 8px !important;
            min-height: auto !important;
        }

        #recurringModal #recDesc {
            height: 60px !important;
        }

        #recurringModal .btn-accept {
            padding: 8px !important;
            margin-top: 5px !important;
        }

        /* Estilos para Selecci칩n de Usuario */
        .user-selection-view {
            z-index: 20000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #2e7d32;
            padding: 40px 15px 20px;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .user-card-switch {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .user-card-switch.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .user-card-switch .avatar-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #2e7d32;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            border: 2px solid white;
        }

        .user-card-switch .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-card-switch .name {
            font-family: 'Almendra', serif;
            font-size: 16px;
            color: white;
            text-align: center;
        }

        .user-card-switch .check {
            font-size: 12px;
            opacity: 0.8;
            color: white;
        }

        .user-row-switch {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
            color: white;
        }

        .user-row-switch .avatar-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: black;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-row-switch .info {
            text-align: left;
            flex: 1;
        }

        .user-row-switch .info .name {
            font-weight: bold;
            font-size: 18px;
            font-family: 'Cinzel', serif;
        }

        .user-row-switch .info .sub {
            font-size: 12px;
            opacity: 0.7;
            font-family: 'Almendra', serif;
        }

        .medieval-section {
            border: calc(var(--border-width)/1.5) var(--border-style) var(--border-color);
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        body.theme-cyber .medieval-textarea,
        body.theme-cyber .medieval-section,
        body.theme-cyber .medieval-control-group {
            background: rgba(30, 41, 59, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
        }

        body.theme-comic .medieval-textarea,
        body.theme-comic .medieval-section,
        body.theme-comic .medieval-control-group {
            background: #EEEEEE;
            border: 3px solid #1A1A1A;
        }

        body.theme-wildwest .medieval-textarea,
        body.theme-wildwest .medieval-section,
        body.theme-wildwest .medieval-control-group {
            background: rgba(160, 128, 96, 0.2);
            border: 1.5px dashed #5D4037;
        }

        /* Menu de Configuraci칩n R치pida */
        .quick-menu {
            display: none;
            position: fixed;
            right: 8px;
            top: 48px;
            background: var(--bg-body);
            border: var(--border-width) var(--border-style) var(--border-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-ui);
            min-width: 180px;
            z-index: 10001;
            overflow: hidden;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-menu-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: var(--font-header);
            color: var(--accent-red);
            font-weight: bold;
            background: rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
        }

        .quick-menu-item {
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            font-family: var(--font-main);
            color: var(--text-main);
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
        }

        .quick-menu-item:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .quick-menu-divider {
            height: 1px;
            background: var(--border-color);
            opacity: 0.2;
            margin: 4px 0;
        }

        .quick-menu-subtitle {
            padding: 6px 12px;
            font-family: var(--font-header);
            color: var(--text-muted);
            font-size: 0.75em;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.02);
        }

        /* --- OVERRIDES ESPECIFICOS PARA TEMAS EN MODALES --- */
        body.theme-cyber .modal-content,
        body.theme-cyber .quick-menu,
        body.theme-cyber .message-box,
        body.theme-cyber .toast {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }

        body.theme-comic .modal-content,
        body.theme-comic .quick-menu,
        body.theme-comic .message-box,
        body.theme-comic .toast {
            background: #FFDE00;
            border: 4px solid #1A1A1A;
            box-shadow: 8px 8px 0px #1A1A1A;
        }

        body.theme-wildwest .modal-content,
        body.theme-wildwest .quick-menu,
        body.theme-wildwest .message-box,
        body.theme-wildwest .toast {
            background: #E1C16E;
            border: 2px dashed #5D4037;
            background-image: var(--body-mask);
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="header-title">游닆 Chronicon</div>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="showTab('theme')" title="Estilo Visual">游꿠</button>
            <button class="header-btn" onclick="toggleZenMode()" title="Activar Modo Zen">九</button>
            <div style="position:relative;">
                <button class="header-btn" onclick="toggleQuickMenu(event)" title="Configuraci칩n">丘뙖잺</button>
                <div id="quickMenu" class="quick-menu">
                    <div class="quick-menu-header">Configuraci칩n</div>

                    <!-- Secci칩n de Acciones de Edici칩n -->
                    <button class="quick-menu-item" onclick="activatePaintMode()">游꿛 Pintar</button>
                    <button class="quick-menu-item" onclick="showShifts()">游돓勇 Turno</button>

                    <div class="quick-menu-divider"></div>

                    <!-- Secci칩n de Historial -->
                    <button class="quick-menu-item" onclick="undoLastAction()">뾆잺 Deshacer</button>
                    <button class="quick-menu-item" onclick="redoLastUndo()">쀮잺 Rehacer</button>

                    <div class="quick-menu-divider"></div>

                    <!-- Secci칩n de Sistema -->
                    <button class="quick-menu-item" onclick="openTools()">游닆 Archivo Real</button>
                    <button class="quick-menu-item" onclick="openWeeklyView()">游늰 Vista Semanal</button>
                    <button class="quick-menu-item" onclick="openRecurringModal()">游댂 Recurrentes</button>

                    <div class="quick-menu-divider"></div>

                    <div class="quick-menu-subtitle">游논 Usuarios</div>
                    <button class="quick-menu-item" style="padding-left: 18px;" onclick="openUsersManagement()">九勇
                        Editar Usuarios</button>
                    <button class="quick-menu-item" style="padding-left: 18px;" onclick="showTab('userSelection')">游댂
                        Cambiar de Usuario</button>
                    <button class="quick-menu-item" onclick="openSettings()">丘뙖잺 Ajustes de App</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot칩n de Salida Modo Zen -->
    <button id="zenExitBtn" onclick="toggleZenMode()" title="Salir de la Vigilia">游돒勇</button>

    <!-- Navegaci칩n por Pesta침as -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('home')">Inicio</button>
        <button class="tab-btn" onclick="showTab('calendar')">Mes</button>
        <button class="tab-btn" onclick="showTab('year')">A침o</button>
        <button class="tab-btn" onclick="showTab('summary')">Resumen</button>
    </div>

    <!-- Navegaci칩n de Mes -->
    <div class="month-nav" id="monthNav" style="display: none;">
        <button onclick="changeMonth(-1)"></button>
        <div class="month-title" id="monthTitle"></div>
        <button onclick="changeMonth(1)"></button>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
        <!-- Vista de Inicio -->
        <div class="home-view active" id="homeView" style="padding: 15px; overflow-y: auto; height: 100%;">
            <div class="greeting-card">
                <div class="greeting-text">
                    <div class="greeting-title" id="greetingTitle">Bienvenido, Escriba</div>
                    <div class="date-display" id="dateDisplay"></div>
                </div>
                <div class="greeting-avatar" id="homeAvatar">游녻</div>
            </div>

            <div class="summary-cards">
                <div class="summary-card" onclick="showTab('calendar')">
                    <div class="count" id="eventsCount">0</div>
                    <div class="label">Eventos Hoy</div>
                </div>
                <div class="summary-card">
                    <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span style="font-size: 2em; color: var(--cinnabar);">丘</span>
                        <span class="count">13춿</span>
                    </div>
                    <div class="label">Sevilla | 98% 游눦</div>
                </div>
            </div>

            <div class="home-section-title">Eventos de Hoy</div>
            <div id="homeEventsList" class="home-events-list">
                <div style="text-align:center; padding: 20px; color: #999; font-style: italic;">Cargando cr칩nicas...
                </div>
            </div>

            <div class="home-section-title">Vista Semana Actual</div>
            <div id="homeMiniCalendar" class="home-mini-calendar">
                <div class="mini-grid" id="miniCalendarGrid"></div>
            </div>
        </div>

        <div class="calendar-view" id="calendarView">
            <div id="monthFilters"
                style="display:none; margin:4px 0; display:flex; gap:8px; align-items:center; justify-content: center;">
                <select id="monthViewMode" class="notes-select" style="min-width:130px; padding: 4px;">
                    <option value="all">Ver: Todos</option>
                    <option value="shifts">Ver: Turnos</option>
                    <option value="notes">Ver: Notas</option>
                    <option value="recurring">Ver: Recurrentes</option>
                </select>
                <select id="monthShiftFilter" class="notes-select" style="min-width:150px; padding: 4px;">
                    <option value="">Filtrar: Turnos</option>
                </select>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <!-- Vista Anual -->
        <div class="year-view" id="yearView">
            <div class="year-nav">
                <button onclick="changeYear(-1)"></button>
                <div class="year-title" id="yearTitle"></div>
                <button onclick="changeYear(1)"></button>
            </div>
            <div class="year-grid" id="yearGrid"></div>
        </div>

        <!-- Vista de Resumen -->
        <div class="calendar-view" id="summaryView" style="display:none; padding: 12px;">
            <div style="display: grid; grid-template-columns: 280px 1fr; gap: 12px;">
                <div>
                    <div class="notes-header" style="margin-bottom:8px;">
                        <div>Filtros</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div>
                            <label class="notes-label">Icono</label>
                            <select id="iconPicker" class="notes-select">
                                <option value="">(Elegir icono...)</option>
                                <option value="Recordatorio">游댒 Recordatorio</option>
                                <option value="Personal">游녻 Personal</option>
                                <option value="Familia">游녿꽳릠뽹꽳릠꽳릠 Familia</option>
                                <option value="Salud">游눍 Salud</option>
                                <option value="Estudio">游닄 Estudio</option>
                                <option value="Deporte">丘 Deporte</option>
                                <option value="Viaje">九걾잺 Viaje</option>
                                <option value="Reuni칩n">游뱋 Reuni칩n</option>
                                <option value="Compras">游 Compras</option>
                                <option value="Evento">游꿀 Evento</option>
                                <option value="Autom칩vil">游뚱 Autom칩vil</option>
                                <option value="Mec치nico">游댢 Mec치nico</option>
                                <option value="Gesti칩n">游닇 Gesti칩n</option>
                                <option value="Veterinario">游 Veterinario</option>
                                <option value="Gimnasio">游끪勇 Gimnasio</option>
                                <option value="Clases">游놀꽳릞 Clases</option>
                                <option value="Cita">游늰 Cita</option>
                            </select>
                        </div>
                        <div>
                            <label class="notes-label">Turno</label>
                            <select id="shiftFilter" class="notes-select"></select>
                        </div>
                        <div>
                            <label class="notes-label">Autor</label>
                            <select id="userFilter" class="notes-select"></select>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-accept" id="iconSearchBtn">Buscar</button>
                            <button class="btn btn-cancel" id="clearFiltersBtn">Limpiar</button>
                        </div>
                        <div id="iconSearchResultEmpty" style="text-align:center; color: var(--sepia); padding:8px;">
                            Selecciona un icono para buscar</div>
                        <div id="iconSearchResult"></div>
                        <div style="margin-top:8px;">
                            <label class="notes-label">Texto</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="textSearchInput" class="notes-input"
                                    placeholder="Buscar en notas por texto">
                                <button class="btn btn-accept" id="textSearchBtn">Buscar Texto</button>
                            </div>
                            <div id="textSearchResultEmpty"
                                style="text-align:center; color: var(--sepia); padding:8px; display:none;">Escribe texto
                                para buscar</div>
                            <div id="textSearchResult"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="notes-header" style="margin-bottom:8px;">
                        <div>Estad칤sticas</div>
                    </div>
                    <div style="display:flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                        <div style="display:flex; gap:8px;">
                            <button id="tabMonth" class="btn btn-accept" style="flex:1;">Mes</button>
                            <button id="tabYear" class="btn btn-accept" style="flex:1;">A침o</button>
                            <button id="tabRange" class="btn btn-accept" style="flex:1;">Rango</button>
                        </div>
                        <div id="rangeControls"
                            style="display:none; align-items:center; justify-content: center; gap:8px; padding: 10px; background: rgba(212, 175, 55, 0.08); border-radius: 8px; border: 1px dashed var(--gold-leaf);">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="date" id="fromInput" class="notes-input"
                                    style="width: 125px; border: 1px solid var(--gold-leaf); border-radius: 6px; font-size: 11px; padding: 4px; height: 32px; background: white; color: var(--iron-gall); font-family: 'Cinzel'; text-align: center;">
                                <span style="font-family:'Cinzel'; color:var(--sepia); font-weight:bold;"></span>
                                <input type="date" id="toInput" class="notes-input"
                                    style="width: 125px; border: 1px solid var(--gold-leaf); border-radius: 6px; font-size: 11px; padding: 4px; height: 32px; background: white; color: var(--iron-gall); font-family: 'Cinzel'; text-align: center;">
                            </div>
                        </div>
                    </div>
                    <div style="border: 1px solid var(--gold-leaf); border-radius:6px; overflow:hidden;">
                        <table id="statsTable" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th
                                        style="text-align:left; padding:8px; font-family:'Cinzel'; font-size: 12px; color: var(--sepia);">
                                        Turno</th>
                                    <th
                                        style="text-align:center; padding:8px; font-family:'Cinzel'; font-size: 12px; color: var(--sepia);">
                                        Cantidad</th>
                                    <th
                                        style="text-align:center; padding:8px; font-family:'Cinzel'; font-size: 12px; color: var(--sepia);">
                                        Tiempo</th>
                                    <th
                                        style="text-align:center; padding:8px; font-family:'Cinzel'; font-size: 10px; color: var(--sepia);">
                                        Global</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="statsGlobal" style="margin-top:8px; font-family:'Cinzel'; color: var(--cinnabar);"></div>
                </div>
            </div>
        </div>
        <!-- Vista de Temas -->
        <div class="theme-view" id="themeView" style="display:none; padding: 20px; overflow-y: auto; height: 100%;">
            <div class="home-section-title" style="text-align: center; font-size: 24px;">Elige tu Mundo</div>
            <p style="text-align: center; color: var(--sepia); margin-bottom: 30px; font-family: var(--font-main);">
                Selecciona la est칠tica que m치s te guste para tu calendario familiar.</p>

            <div class="theme-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1000px; margin: 0 auto;">
                <!-- Medieval -->
                <div class="theme-card medieval active" onclick="setTheme('medieval')"
                    style="background: var(--bg-surface); border: var(--border-width) var(--border-style) var(--border-color); border-radius: var(--border-radius-lg); padding: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <div style="font-size: 50px;">游낋</div>
                    <div
                        style="font-family: var(--font-header); font-size: 20px; color: var(--accent-red); font-weight: bold;">
                        Reino
                        Medieval</div>
                    <p
                        style="text-align: center; font-size: 14px; color: var(--text-muted); font-family: var(--font-main);">
                        Nuestra est칠tica cl치sica. Pergaminos, oro y elegancia hist칩rica.</p>
                    <div class="theme-check"
                        style="position: absolute; top: 10px; right: 10px; font-size: 20px; color: var(--accent-gold);">
                        九</div>
                </div>

                <!-- Futurist -->
                <div class="theme-card cyber" onclick="setTheme('cyber')"
                    style="background: #0f172a; border: 2px solid #38bdf8; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <div style="font-size: 50px;">游</div>
                    <div style="font-family: 'Outfit', sans-serif; font-size: 20px; color: #38bdf8; font-weight: bold;">
                        Cyber-Familia</div>
                    <p style="text-align: center; font-size: 14px; color: #94a3b8; font-family: 'Inter', sans-serif;">Un
                        futuro optimista. Neones suaves, cristal y tecnolog칤a avanzada.</p>
                    <div class="theme-check"
                        style="position: absolute; top: 10px; right: 10px; font-size: 20px; color: #38bdf8; display: none;">
                        九</div>
                </div>

                <!-- Comic -->
                <div class="theme-card comic" onclick="setTheme('comic')"
                    style="background: #ffde00; border: 4px solid #1a1a1a; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                    <div style="font-size: 50px;">游눤</div>
                    <div style="font-family: 'Bangers', cursive; font-size: 22px; color: #1a1a1a; letter-spacing: 1px;">
                        Pop-Art / Comic</div>
                    <p
                        style="text-align: center; font-size: 14px; color: #1a1a1a; font-family: 'Roboto Condensed', sans-serif; font-weight: bold;">
                        춰Acci칩n pura! Colores vibrantes, trazos negros y mucha energ칤a.</p>
                    <div class="theme-check"
                        style="position: absolute; top: 10px; right: 10px; font-size: 20px; color: #ff0000; display: none;">
                        九</div>
                </div>

                <!-- Wild West -->
                <div class="theme-card wildwest" onclick="setTheme('wildwest')"
                    style="background: #e1c16e; border: 2px solid #5d4037; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; gap: 15px; border-style: dashed;">
                    <div style="font-size: 50px;">救</div>
                    <div style="font-family: 'Arvo', serif; font-size: 20px; color: #5d4037; font-weight: bold;">Lejano
                        Oeste</div>
                    <p
                        style="text-align: center; font-size: 14px; color: #3d2b1f; font-family: 'Playfair Display', serif;">
                        Aventura r칰stica. Madera, cuero y el esp칤ritu de la frontera.</p>
                    <div class="theme-check"
                        style="position: absolute; top: 10px; right: 10px; font-size: 20px; color: #824100; display: none;">
                        九</div>
                </div>
            </div>
        </div>
    </div>
    <!-- Vista de Selecci칩n de Usuario (Overlay) -->
    <div id="userSelectionView" class="user-selection-view">
        <div style="max-width: 500px; width: 100%; margin: 0 auto; text-align: center; color: white;">
            <div
                style="background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 12px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                游늰</div>
            <h1
                style="font-family: 'Cinzel', serif; font-size: 22px; margin-bottom: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); text-transform: uppercase;">
                Calendario Familiar</h1>
            <p style="font-family: 'Almendra', serif; font-size: 16px; margin-bottom: 20px; opacity: 0.9;">Selecciona tu
                usuario</p>

            <div id="userSelectionGrid"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                <!-- Cargando... -->
            </div>

            <button class="btn btn-accept" onclick="showTab('home')"
                style="width: 100%; padding: 14px; font-size: 18px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-ui); font-weight: bold; cursor: pointer; font-family: var(--font-header);">
                IR AL CALENDARIO 
            </button>

            <div style="margin-top: 20px; font-family: 'Almendra', serif; font-size: 13px; opacity: 0.7;">
                Todos los eventos son compartidos entre usuarios
            </div>
        </div>
    </div>

    <!-- Botones de Acci칩n -->
    <div class="bottom-actions" id="bottomActions" style="display: none;">
        <button class="action-btn" onclick="activatePaintMode()">Pintar</button>
        <button class="action-btn" onclick="activateEditMode()">Editar</button>
        <button class="action-btn" onclick="showShifts()">Turnos</button>
        <button class="action-btn" onclick="openMonthPdfPreview()">PDF Mes</button>
    </div>

    <!-- Modal de Turnos para Pintar -->
    <div class="shifts-popup" id="shiftsPopup">
        <div class="shifts-popup-header" style="display:none;">
            <div style="font-size: 14px;">TURNO:</div>
        </div>
        <div class="shifts-scroll" id="shiftsScroll">
            <!-- Se carga din치micamente -->
        </div>
        <button class="shifts-popup-close" onclick="closeShiftsPopup()" title="Cerrar"
            style="font-size: 20px; margin-left: 8px;">九</button>
    </div>

    <!-- Modal de D칤a (Editor Unificado) -->
    <div class="modal" id="dayModal">
        <div class="modal-content"
            style="max-width: 500px; height: 700px; border-width: 4px; display: flex; flex-direction: column;">
            <div class="modal-header"
                style="display: flex; justify-content: space-between; align-items: center; padding: 6px 14px; font-size: 0.9em;">
                <div id="modalDate">Fecha</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="cursor: pointer;" onclick="closeModal()">游닆</div>
                </div>
            </div>
            <div class="modal-body"
                style="padding: 10px; flex: 1; display: flex; flex-direction: column; overflow-y: auto;">

                <!-- VISTA 1: DASHBOARD (Resumen del D칤a) -->
                <div id="modalDashboardView" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Bot칩n Nueva Cita / Nota -->
                    <button class="btn btn-accept" onclick="prepareNewNote()"
                        style="width: 100%; border-style: dashed; background: rgba(0,0,0,0.05); color: var(--text-main); padding: 10px;">
                        九 NUEVA NOTA / CR칍NICA
                    </button>

                    <!-- Listado de Cr칩nicas -->
                    <div id="dashboardNotesList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Din치mico: Notas existentes -->
                    </div>

                    <!-- Secci칩n Aviso de Alarma -->
                    <div class="medieval-section"
                        style="padding: 10px; border-color: var(--cinnabar); background: rgba(139,38,53,0.02);">
                        <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;"
                            onclick="toggleAlarmVisibility()">
                            <div
                                style="display: flex; align-items: center; gap: 8px; color: var(--cinnabar); font-family: 'Cinzel'; font-weight: bold;">
                                游댒 AVISO DE ALARMA
                            </div>
                            <div id="alarmCounter"
                                style="background: var(--accent-red); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                0</div>
                        </div>
                        <div id="dashboardAlarmsList"
                            style="margin-top: 10px; display: flex; flex-direction: column; gap: 6px;">
                            <!-- Din치mico: Alamas -->
                        </div>
                    </div>

                    <!-- Secci칩n Turnos del D칤a -->
                    <div class="medieval-section" style="padding: 10px;">
                        <div
                            style="font-family: 'Cinzel'; font-weight: bold; color: var(--sepia); margin-bottom: 8px; font-size: 14px;">
                            TURNOS DEL D칈A</div>
                        <div id="dashboardShiftsList" style="display: flex; flex-direction: column; gap: 6px;">
                            <!-- Din치mico: Turnos -->
                        </div>
                    </div>
                </div>

                <!-- VISTA 2: EDITOR (Edici칩n de Cr칩nica) -->
                <div id="modalEditorView" style="display: none; flex-direction: column; gap: 6px;">
                    <button class="btn btn-cancel" onclick="showModalDashboard()"
                        style="width: auto; height: 30px; padding: 4px 10px; font-size: 11px; align-self: flex-start;">
                        Volver al Resumen</button>

                    <div class="notes-editor-container" style="gap: 6px; display: flex; flex-direction: column;">
                        <div id="medievalEditor" class="medieval-textarea" contenteditable="true"
                            style="min-height: 100px; padding: 8px; font-size: 1.05em;"
                            data-placeholder="Escribe la cr칩nica..."></div>

                        <!-- Herramientas de Formato -->
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; background: rgba(0, 0, 0, 0.05); padding: 8px 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            <div class="medieval-format-row" style="margin: 0; gap: 10px;">
                                <button id="boldBtn" class="format-btn-medieval" onmousedown="event.preventDefault()"
                                    onclick="execCmd('bold')">B</button>
                                <button id="italicBtn" class="format-btn-medieval" onmousedown="event.preventDefault()"
                                    onclick="execCmd('italic')">I</button>
                                <button id="underlineBtn" class="format-btn-medieval"
                                    onmousedown="event.preventDefault()" onclick="execCmd('underline')">U</button>
                            </div>
                            <select id="editorFontFamily" class="notes-select" style="width: 110px; font-size: 12px;"
                                onchange="execCmd('fontName', this.value)">
                                <option value="'Almendra', serif">Almendra</option>
                                <option value="'Cinzel', serif">Cinzel</option>
                                <option value="'Spectral', serif">Spectral</option>
                                <option value="'Marcellus', serif">Marcellus</option>
                                <option value="'Arial', sans-serif">Arial</option>
                            </select>
                        </div>

                        <!-- Tama침o y Hora -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="medieval-section"
                                style="padding: 4px 8px; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <span style="font-family: Cinzel; font-size: 9px; color: var(--sepia);">HORA</span>
                                <input type="time" id="editorTime" class="notes-input"
                                    style="height: 36px; border: none; background: transparent; font-size: 1.5em; font-weight: bold; width: 100%; text-align: center;">
                            </div>
                            <div class="medieval-section"
                                style="padding: 4px 8px; margin: 0; display: flex; flex-direction: column; justify-content: center;">
                                <span style="font-family: Cinzel; font-size: 9px; color: var(--sepia);">TAMA칌O: <span
                                        id="cellSizeValue">11</span></span>
                                <input type="range" id="cellSizeSlider" class="medieval-range" min="8" max="22"
                                    value="11" oninput="updateCellSize(this.value)">
                            </div>
                        </div>

                        <!-- Categor칤a y Alarma -->
                        <div style="display: grid; grid-template-columns: 1fr 60px; gap: 6px;">
                            <div class="medieval-section" style="padding: 4px 8px; margin: 0;">
                                <span style="font-family: Cinzel; font-size: 9px; color: var(--sepia);">CATEGOR칈A</span>
                                <select id="editorCategory" class="notes-select"
                                    style="height: 24px; border: none; background: transparent; width: 100%;">
                                    <option value="">Sin tipo...</option>
                                    <option value="Recordatorio">游댒 Recordatorio</option>
                                    <option value="Personal">游녻 Personal</option>
                                    <option value="Familia">游녿꽳릠뽹꽳릠꽳릠 Familia</option>
                                    <option value="Salud">游눍 Salud</option>
                                    <option value="Estudio">游닄 Estudio</option>
                                    <option value="Deporte">丘 Deporte</option>
                                    <option value="Viaje">九걾잺 Viaje</option>
                                    <option value="Reuni칩n">游뱋 Reuni칩n</option>
                                    <option value="Compras">游 Compras</option>
                                    <option value="Evento">游꿀 Evento</option>
                                    <option value="Recordatorio">낋 Recordatorio</option>
                                    <option value="Autom칩vil">游뚱 Autom칩vil</option>
                                    <option value="Mec치nico">游댢 Mec치nico</option>
                                    <option value="Gesti칩n">游닇 Gesti칩n</option>
                                    <option value="Veterinario">游 Veterinario</option>
                                    <option value="Gimnasio">游끪勇 Gimnasio</option>
                                    <option value="Clases">游놀꽳릞 Clases</option>
                                    <option value="Cita">游늰 Cita</option>
                                </select>
                            </div>
                            <div class="medieval-section"
                                style="padding: 4px 8px; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; border-color: var(--cinnabar);">
                                <span style="font-family: Cinzel; font-size: 9px; color: var(--cinnabar);">AVISO</span>
                                <label class="switch-medieval" style="cursor: pointer;">
                                    <input type="checkbox" id="editorAlarm" style="display: none;">
                                    <span id="alarmIcon" style="font-size: 1.2em; opacity: 0.3;">游댒</span>
                                </label>
                            </div>
                        </div>

                        <!-- Visibilidad -->
                        <div class="medieval-section" style="padding: 8px; margin: 0;">
                            <div class="medieval-label" style="font-size: 9px; color: var(--cinnabar);">游논 VISIBILIDAD:
                            </div>
                            <div id="visibilityList" class="visibility-list" style="margin-top: 5px; gap: 8px;"></div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                        <button class="btn btn-cancel" style="background: var(--cinnabar); color: white;"
                            onclick="deleteDayNote()">BORRAR</button>
                        <button class="btn btn-accept" onclick="saveDayNote()">GUARDAR CR칍NICA</button>
                    </div>
                </div>
            </div>

            <!-- Footer fijo para el Dashboard -->
            <div id="dashboardFooter"
                style="padding: 10px; border-top: 2px solid var(--gold-leaf); display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-cancel" onclick="closeModal()">CANCELAR</button>
                <button class="btn btn-accept" onclick="closeModal()">ACEPTAR</button>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal de Notas -->
    <div class="notes-modal" id="notesModal">
        <div class="notes-modal-content">
            <div class="notes-header">
                <div>Nueva Nota</div>
                <button class="header-btn" onclick="closeNotesModal()" style="padding: 4px 8px;">九</button>
            </div>
            <div class="notes-body">
                <textarea class="notes-textarea" id="notesTextarea" placeholder="Escribe tu nota aqu칤..."></textarea>
                <div class="notes-controls">
                    <div class="notes-control-group">
                        <label class="notes-label">游뎷 Hora (opcional)</label>
                        <input type="time" class="notes-input" id="notesTimeInput">
                    </div>
                    <div class="notes-control-group">
                        <label class="notes-label">游낑勇 Categor칤a</label>
                        <select class="notes-select" id="notesCategorySelect">
                            <option value="">Ninguna</option>
                            <option value="Cumplea침os">游꾹 Cumplea침os</option>
                            <option value="Trabajo">游눺 Trabajo</option>
                            <option value="Personal">游녻 Personal</option>
                            <option value="Familia">游녿꽳릠뽹꽳릠꽳릠 Familia</option>
                            <option value="Salud">游눍 Salud</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeNotesModal()">Cancelar</button>
                    <button class="btn btn-accept" onclick="saveNote()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci칩n -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">Configuraci칩n</div>
            <div class="modal-body">
                <div class="notes-control-group">
                    <label class="notes-label">Inicio de semana</label>
                    <select class="notes-select" id="weekStartSelect">
                        <option value="1">Lunes</option>
                        <option value="0">Domingo</option>
                    </select>
                </div>
                <div class="notes-control-group">
                    <label class="notes-label">Destacar hoy</label>
                    <select class="notes-select" id="highlightTodaySelect">
                        <option value="false">No</option>
                        <option value="true">S칤</option>
                    </select>
                </div>
                <div class="notes-control-group">
                    <label class="notes-label">Tama침o de Fuente</label>
                    <select class="notes-select" id="fontSizeSelect">
                        <option value="12px">Peque침o</option>
                        <option value="16px" selected>Normal</option>
                        <option value="20px">Grande</option>
                        <option value="24px">Gigante</option>
                        <option value="32px">Colosal</option>
                    </select>
                </div>
                <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                    <button class="btn btn-accept" style="flex:1; min-width:140px;" onclick="openReminders()">游댒
                        Recordatorios</button>
                </div>
                <div class="modal-actions" style="margin-top:12px;">
                    <button class="btn btn-cancel" onclick="closeSettingsModal()">Cerrar</button>
                    <button class="btn btn-accept" onclick="saveSettings()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recordatorios -->
    <div class="modal" id="remindersModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">Recordatorios</div>
            <div class="modal-body">
                <div id="remindersList"></div>
                <div class="modal-actions">
                    <button class="btn btn-cancel"
                        onclick="document.getElementById('remindersModal').style.display='none'">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Recurrentes -->
    <div class="modal" id="recurringModal">
        <div class="modal-content" style="max-width: 600px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <button class="header-btn" onclick="document.getElementById('recurringModal').classList.remove('show')"
                    style="padding: 2px 8px;">九</button>
                <span>Eventos Recurrentes</span>
                <div style="width: 32px;"></div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 10px;">

                <!-- Formulario de Creaci칩n -->
                <div class="medieval-section" style="margin-bottom: 10px; padding: 12px;">
                    <div
                        style="font-family: var(--font-header); color: var(--accent-red); font-weight: bold; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 3px;">
                        Agregar Evento Recurrente
                    </div>

                    <div class="notes-control-group">
                        <label class="notes-label">T칤tulo</label>
                        <input type="text" id="recTitle" class="notes-input"
                            placeholder="Ej: Cr칩nica Semanal del Reino">
                    </div>

                    <div class="notes-control-group">
                        <label class="notes-label">Descripci칩n</label>
                        <textarea id="recDesc" class="notes-textarea" style="height: 30px;"
                            placeholder="Detalles de la recurrencia..."></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="notes-control-group">
                            <label class="notes-label">Fecha de Inicio</label>
                            <input type="date" id="recStartDate" class="notes-input">
                        </div>
                        <div class="notes-control-group">
                            <label class="notes-label">Fecha de Fin</label>
                            <input type="date" id="recEndDate" class="notes-input">
                        </div>
                    </div>

                    <div class="notes-control-group">
                        <label class="notes-label">Hora</label>
                        <input type="time" id="recTime" class="notes-input">
                    </div>

                    <div class="notes-control-group">
                        <label class="notes-label">Frecuencia</label>
                        <select id="recFrequency" class="notes-select" onchange="updateRecUI()">
                            <option value="daily">Diaria</option>
                            <option value="weekly">Semanal</option>
                            <option value="monthly">Mensual</option>
                            <option value="yearly">Anual</option>
                            <option value="custom">Personalizada</option>
                        </select>
                    </div>

                    <div id="recCustomSettings"
                        style="display: none; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <label class="notes-label" style="margin:0;">Repetir cada:</label>
                            <input type="number" id="recInterval" class="notes-input" value="1" min="1"
                                style="width: 60px;">
                            <select id="recUnit" class="notes-select" style="flex: 1;">
                                <option value="day">d칤a(s)</option>
                                <option value="week">semana(s)</option>
                                <option value="month">mes(es)</option>
                            </select>
                        </div>

                        <div id="recWeekDays" style="display: none;">
                            <label class="notes-label">D칤as de la semana:</label>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="0"> Dom</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="1"> Lun</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="2"> Mar</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="3"> Mi칠</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="4"> Jue</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="5"> Vie</label>
                                <label style="font-size: 11px; display: flex; align-items: center; gap: 3px;"><input
                                        type="checkbox" name="recDay" value="6"> S치b</label>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-accept" onclick="addRecurringEvent()"
                        style="width: 100%; margin-top: 5px; font-size: 15px;">
                        + CREAR EVENTO
                    </button>
                </div>

                <!-- Lista de Recurrentes -->
                <div class="medieval-section" style="margin-bottom: 5px; padding: 10px;">
                    <div
                        style="font-family: var(--font-header); color: var(--accent-red); font-weight: bold; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 3px;">
                        Eventos Recurrentes Activos
                    </div>
                    <div id="activeRecurringList" style="max-height: 180px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Archivo Real (Consolidado) -->
    <div class="modal" id="toolsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">游닆 ARCHIVO REAL</div>
            <div class="modal-body" style="padding: 15px;">


                <!-- Secci칩n Exportar -->
                <div class="medieval-section" style="margin-bottom: 15px; padding: 12px;">
                    <div
                        style="font-family: var(--font-header); color: var(--accent-red); font-weight: bold; margin-bottom: 8px;">
                        游둚勇 EXPORTAR CR칍NICA</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px;">
                        <div>
                            <label class="notes-label" style="font-size: 10px;">DESDE</label>
                            <input type="date" id="exportFrom" class="notes-input">
                        </div>
                        <div>
                            <label class="notes-label" style="font-size: 10px;">HASTA</label>
                            <input type="date" id="exportTo" class="notes-input">
                        </div>
                    </div>
                    <button class="btn btn-accept" style="width: 100%;" onclick="exportCalendar()">Generar Pergamino
                        (JSON)</button>
                    <div id="exportStatus" style="margin-top:4px; font-size: 11px; text-align: center;"></div>
                </div>

                <!-- Secci칩n Google Sheets / CSV -->
                <div class="medieval-section" style="margin-bottom: 15px; padding: 12px;">
                    <div
                        style="font-family: var(--font-header); color: var(--accent-gold); font-weight: bold; margin-bottom: 8px;">
                        游늵 LIBRO DE CUENTAS (SHEETS/CSV)</div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-accept" onclick="exportToCSV()">Exportar
                            para Google Sheets (CSV)</button>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                            <button class="btn btn-accept" onclick="toggleImportArea()"
                                style="background: #1565c0;">Importar Pegando</button>
                            <button class="btn btn-accept" onclick="document.getElementById('csvFileInput').click()"
                                style="background: #6a1b9a;">Subir Archivo CSV</button>
                            <input type="file" id="csvFileInput" style="display:none;" accept=".csv,.txt"
                                onchange="handleCSVFile(event)">
                        </div>

                        <div id="importArea" style="display:none; flex-direction:column; gap:8px; margin-top:8px;">
                            <textarea id="sheetsPasteArea" class="notes-input"
                                style="height:120px; font-size:10px; border: 2px dashed var(--gold-leaf); transition: all 0.3s;"
                                placeholder="Pegue aqu칤 las celdas o arrastre su archivo .csv..."></textarea>
                            <button class="btn btn-accept" onclick="importFromSheets()" style="width:100%;">Procesar
                                Importaci칩n</button>
                            <div style="font-size:9px; color:var(--sepia); font-style:italic;">Formatos: Arrastrar .csv
                                | Pegar desde Excel/Sheets (Fecha, Tipo, Texto, Autor...)</div>
                        </div>
                    </div>
                </div>

                <!-- Secci칩n Backup -->
                <div class="medieval-section" style="padding: 12px;">
                    <div
                        style="font-family: var(--font-header); color: var(--text-muted); font-weight: bold; margin-bottom: 8px;">
                        游낔 EL
                        SALVOCONDUCTO (BACKUP)</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-accept" onclick="backupData()">Crear Copia de Seguridad</button>
                        <div style="height: 1px; background: var(--border-color); opacity: 0.3;"></div>
                        <label class="notes-label" style="font-size: 10px;">IMPORTAR COPIA:</label>
                        <input type="file" id="backupInput" class="notes-input" onchange="importBackup(event)"
                            style="font-size: 11px;">
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 15px;">
                    <button class="btn btn-cancel" style="width: 100%;"
                        onclick="document.getElementById('toolsModal').classList.remove('show')">CERRAR ARCHIVO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gesti칩n de Turnos -->
    <div class="modal" id="shiftsManageModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">Gesti칩n de Turnos</div>
            <div class="modal-body">
                <div class="medieval-section" style="margin-bottom:12px;">
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div style="display:flex; gap:8px;">
                            <input type="text" id="shiftNameInput" class="notes-input" placeholder="Nombre del Turno"
                                style="flex:2;">
                            <input type="text" id="shiftAbbrevInput" class="notes-input" placeholder="Abrev."
                                style="flex:1;">
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <label class="notes-label" style="margin:0; white-space:nowrap;">Color del Blas칩n:</label>
                            <input type="color" id="shiftColorInput" class="notes-input"
                                style="width:60px; height:38px; padding:2px;">
                        </div>
                        <div style="display:flex; gap:8px;">
                            <div style="flex:1;">
                                <label class="notes-label">Hora Inicio</label>
                                <input type="time" id="shiftStartInput" class="notes-input">
                            </div>
                            <div style="flex:1;">
                                <label class="notes-label">Hora Fin</label>
                                <input type="time" id="shiftEndInput" class="notes-input">
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn btn-accept" onclick="saveShiftTemplate()">Guardar</button>
                        <button class="btn btn-cancel" onclick="resetShiftForm()">Limpiar</button>
                    </div>
                </div>
                <div id="shiftTemplatesList" class="medieval-section"></div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeShiftsManage()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Turno del D칤a -->
    <div class="modal" id="shiftEditModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">Editar Turno</div>
            <div class="modal-body">
                <div class="notes-control-group">
                    <label class="notes-label">Nombre</label>
                    <input type="text" id="shiftEditName" class="notes-input">
                </div>
                <div class="notes-control-group">
                    <label class="notes-label">Color</label>
                    <input type="color" id="shiftEditColor" class="notes-input">
                </div>
                <div class="notes-control-group" style="display:flex; gap:8px;">
                    <div style="flex:1;">
                        <label class="notes-label">Inicio</label>
                        <input type="time" id="shiftEditStart" class="notes-input">
                    </div>
                    <div style="flex:1;">
                        <label class="notes-label">Fin</label>
                        <input type="time" id="shiftEditEnd" class="notes-input">
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeShiftEditModal()">Cancelar</button>
                    <button class="btn btn-accept" onclick="saveShiftEdit()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Duplicar Turno -->
    <div class="modal" id="shiftDuplicateModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">Duplicar Turno</div>
            <div class="modal-body">
                <div class="notes-control-group">
                    <label class="notes-label">Fecha destino</label>
                    <input type="date" id="shiftDupDate" class="notes-input">
                </div>
                <div class="notes-control-group">
                    <label class="notes-label">Modo</label>
                    <select id="shiftDupMode" class="notes-input" onchange="updateShiftDupModeUI()">
                        <option value="single">Un d칤a</option>
                        <option value="daily_count">Diario por N d칤as</option>
                        <option value="every_x_repeats">Cada X d칤as por N repeticiones</option>
                        <option value="weekly_until">Semanal hasta fecha fin</option>
                    </select>
                </div>
                <div id="dupDailyCount" style="display:none;">
                    <div class="notes-control-group">
                        <label class="notes-label">Cantidad de d칤as</label>
                        <input type="number" id="shiftDupCountDays" class="notes-input" min="1" value="5">
                    </div>
                </div>
                <div id="dupEveryX" style="display:none;">
                    <div class="notes-control-group">
                        <label class="notes-label">Intervalo (d칤as)</label>
                        <input type="number" id="shiftDupIntervalDays" class="notes-input" min="1" value="2">
                    </div>
                    <div class="notes-control-group">
                        <label class="notes-label">Repeticiones</label>
                        <input type="number" id="shiftDupRepeats" class="notes-input" min="1" value="5">
                    </div>
                </div>
                <div id="dupWeekly" style="display:none;">
                    <div class="notes-control-group">
                        <label class="notes-label">D칤as de la semana</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <label><input type="checkbox" class="notes-input" id="wd0"> D</label>
                            <label><input type="checkbox" class="notes-input" id="wd1"> L</label>
                            <label><input type="checkbox" class="notes-input" id="wd2"> M</label>
                            <label><input type="checkbox" class="notes-input" id="wd3"> X</label>
                            <label><input type="checkbox" class="notes-input" id="wd4"> J</label>
                            <label><input type="checkbox" class="notes-input" id="wd5"> V</label>
                            <label><input type="checkbox" class="notes-input" id="wd6"> S</label>
                        </div>
                    </div>
                    <div class="notes-control-group">
                        <label class="notes-label">Fecha fin</label>
                        <input type="date" id="shiftDupEndDate" class="notes-input">
                    </div>
                </div>
                <div class="notes-control-group">
                    <label class="notes-label" style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="shiftDupAvoidDup" class="notes-input" checked>
                        Evitar duplicados en el mismo d칤a
                    </label>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeShiftDuplicateModal()">Cancelar</button>
                    <button class="btn btn-accept" onclick="performShiftDuplicate()">Duplicar</button>
                </div>
                <div id="shiftDupStatus" style="margin-top:8px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Vista Semanal -->
    <div class="modal" id="weeklyViewModal">
        <div class="modal-content"
            style="max-width: 95vw; width: 95vw; height: 95vh; max-height: 95vh; overflow-y: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
                <span>Vista Semanal</span>
                <button class="header-btn" onclick="closeWeeklyView()"
                    style="padding: 2px 8px; font-size: 14px;">九</button>
            </div>
            <div class="modal-body">
                <div
                    style="display:flex; align-items:center; gap:12px; margin-bottom:12px; padding: 8px; background: rgba(0, 0, 0, 0.05); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                    <div style="font-size: 13px; color: var(--text-muted); flex: 1;">Total: <strong
                            id="totalEvents">0</strong> cr칩nicas</div>
                    <button class="btn btn-accept" onclick="openWeeklyPdfPreview()"
                        style="padding: 4px 12px; font-size: 12px;">游늯 PDF</button>
                    <div id="weeklyRange"
                        style="font-family:'Cinzel', serif; color: var(--cinnabar); font-weight: bold;"></div>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:12px; align-items: center;">
                    <button class="btn btn-cancel" style="padding: 6px 15px;" onclick="changeWeek(-1)"></button>
                    <div style="flex:1; display: flex; gap: 8px; justify-content: center;">
                        <button id="weeklyGridBtn" class="btn btn-accept" style="min-width: 100px;"
                            onclick="setWeeklyViewMode('grid')">游늰 Grilla</button>
                        <button id="weeklyAgendaBtn" class="btn btn-accept" style="min-width: 100px;"
                            onclick="setWeeklyViewMode('agenda')">游늶 Agenda</button>
                    </div>
                    <button class="btn btn-cancel" style="padding: 6px 15px;" onclick="changeWeek(1)"></button>
                </div>
                <div id="weeklyGrid"
                    style="display:none; overflow-y:auto; flex: 1; max-height: 85vh; border: 1px solid var(--gold-leaf); border-radius: 4px;">
                </div>
                <div id="weeklyAgenda"
                    style="display:none; overflow-y:auto; flex: 1; max-height: 85vh; border: 1px solid var(--gold-leaf); border-radius: 4px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Usuarios -->
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 720px;">
            <div class="modal-header">Usuarios</div>
            <div class="modal-body">
                <div id="usersContainer"></div>
                <div class="modal-actions" style="margin-top:12px;">
                    <button class="btn btn-cancel" onclick="closeUsersManagement()">Cerrar</button>
                    <button class="btn btn-accept" onclick="saveUsersChanges()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor de Mensajes -->
    <div class="message-container" id="messageContainer">
        <div class="message-box">
            <div class="message-title" id="messageTitle"></div>
            <div class="message-text" id="messageText"></div>
            <div class="message-actions">
                <button class="btn btn-accept" onclick="closeMessage()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Contenedor de Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // CONFIGURACI칍N DE FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCGE9TrLvHAIwuXn0o6jqFSw5RhSOHDtg8",
            authDomain: "apptaxi-f2190.firebaseapp.com",
            projectId: "apptaxi-f2190",
            storageBucket: "apptaxi-f2190.firebasestorage.app",
            messagingSenderId: "804273724178",
            appId: "1:804273724178:web:c5955a1f657884c0e7f1cb",
            measurementId: "G-3D8R30TYTM"
        };

        // Inicializar Firebase (solo si est치 configurado)
        let db = null;
        let isFirebaseConfigured = false;
        let isFirebaseConnected = false;
        let useLocalStorage = false;
        let recurringEventsDefinitions = [];

        // Verificar si Firebase est치 configurado
        if (firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();

                // Habilitar persistencia offline (Compat v10)
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.warn('Persistencia: m칰ltiples pesta침as abiertas');
                    } else if (err.code == 'unimplemented') {
                        console.warn('Persistencia: no soportada');
                    }
                });

                isFirebaseConfigured = true;
                isFirebaseConnected = true;
                console.log('九 Firebase conectado correctamente');
            } catch (error) {
                console.error('仇 Error initializing Firebase:', error);
                console.warn('Firebase no configurado, usando modo demo con localStorage');
                useLocalStorage = true;
                try {
                    const stored = localStorage.getItem('local_recurring_events');
                    if (stored) recurringEventsDefinitions = JSON.parse(stored);
                } catch (e) { }
            }
        } else {
            console.log('游닆 Modo Demo: Firebase no configurado, usando localStorage');
            useLocalStorage = true;
            try {
                const stored = localStorage.getItem('local_recurring_events');
                if (stored) recurringEventsDefinitions = JSON.parse(stored);
            } catch (e) { }
        }

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let currentDate = new Date();
        const isSameDay = (d1, d2) =>
            d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();
        let currentView = 'home';
        let selectedDate = null;
        let currentNote = null;
        let eventsCache = {}; // Cach칠 de eventos de Firebase
        const appId = 'medieval_calendar';

        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];

        const weekDays = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

        function getUsers() {
            try {
                const rawMedieval = localStorage.getItem('medieval_users');
                const rawLegacy = localStorage.getItem('users');
                const raw = rawMedieval || rawLegacy || '';
                if (!raw) return getDefaultUsers();
                const list = JSON.parse(raw);
                return Array.isArray(list) && list.length > 0 ? list : getDefaultUsers();
            } catch (e) {
                return getDefaultUsers();
            }
        }
        const USER_KEY = 'medieval_users';
        const CURRENT_USER_KEY = 'medieval_current_user';
        const availableUserColors = [
            '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4',
            '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722',
            '#795548', '#607D8B', '#9E9E9E', '#000000', '#FFFFFF'
        ];
        function getDefaultUsers() {
            return [
                { id: '1', name: 'Juan Carlos', color: '#2196F3', userId: 1, avatar: '游땕', avatarType: 'emoji' },
                { id: '2', name: 'Carmen', color: '#4CAF50', userId: 2, avatar: '游놀', avatarType: 'emoji' },
                { id: '3', name: 'Mar칤a', color: '#FF9800', userId: 3, avatar: '游녾', avatarType: 'emoji' },
                { id: '4', name: 'Pedro', color: '#9C27B0', userId: 4, avatar: '游녽', avatarType: 'emoji' }
            ];
        }
        async function loadUsersData() {
            let users = [];

            // 1. Intentar Firebase si estamos conectados
            if (isFirebaseConfigured && db) {
                try {
                    const snapshot = await db.collection('users').get();
                    if (!snapshot.empty) {
                        users = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: String(doc.id),
                                name: data.name || `Usuario ${doc.id}`,
                                color: data.color || '#9E9E9E',
                                userId: parseInt(doc.id) || 0,
                                avatar: data.avatar || '游녻',
                                avatarType: data.avatarType || 'emoji'
                            };
                        });
                        // Guardar en local para cach칠 r치pida
                        localStorage.setItem(USER_KEY, JSON.stringify(users));
                    }
                } catch (e) {
                    console.warn('No se pudo cargar de Firebase (users), usando local');
                }
            }

            // 2. Fallback a LocalStorage si Firebase no dio nada
            if (users.length === 0) {
                try {
                    const raw = localStorage.getItem(USER_KEY);
                    if (raw) users = JSON.parse(raw);
                } catch (e) { }
            }

            // 3. Fallback a por defecto
            if (users.length === 0) users = getDefaultUsers();

            return users;
        }
        async function saveUsersData(users) {
            try { localStorage.setItem(USER_KEY, JSON.stringify(users)); } catch (e) { }
            if (isFirebaseConfigured) {
                try {
                    const batch = db.batch();
                    users.forEach(u => {
                        const ref = db.collection('users').doc(String(u.id));
                        batch.set(ref, {
                            name: u.name, color: u.color, userId: u.userId,
                            avatar: u.avatar, avatarType: u.avatarType
                        });
                    });
                    await batch.commit();
                } catch (e) { /* silent */ }
            }
        }
        function getCurrentUserId() {
            try { return localStorage.getItem(CURRENT_USER_KEY) || ''; } catch (e) { return ''; }
        }
        function setCurrentUserId(id) {
            try { localStorage.setItem(CURRENT_USER_KEY, String(id || '')); } catch (e) { }
        }
        let usersEditBuffer = [];
        async function openUsersManagement() {
            const users = await loadUsersData();
            usersEditBuffer = users.map(u => ({ ...u }));
            const container = document.getElementById('usersContainer');
            if (container) {
                container.innerHTML = '';
                usersEditBuffer.forEach(u => {
                    const card = document.createElement('div');
                    card.className = 'medieval-section';
                    card.style.marginBottom = '8px';
                    const header = document.createElement('div');
                    header.className = 'notes-header';
                    header.textContent = `Perfil ${u.id}`;
                    const body = document.createElement('div');
                    body.style.display = 'flex';
                    body.style.flexDirection = 'column';
                    body.style.gap = '8px';
                    const preview = document.createElement('div');
                    preview.id = `avatarPreview_${u.id}`;
                    preview.style.width = '80px';
                    preview.style.height = '80px';
                    preview.style.borderRadius = '50%';
                    preview.style.border = 'var(--border-width) var(--border-style) var(--border-color)';
                    preview.style.display = 'flex';
                    preview.style.alignItems = 'center';
                    preview.style.justifyContent = 'center';
                    preview.style.fontSize = '40px';
                    preview.style.background = 'var(--bg-body)';
                    preview.style.boxShadow = 'var(--shadow-ui)';
                    preview.textContent = u.avatarType === 'emoji' ? (u.avatar || '游녻') : '';
                    if (u.avatarType === 'photo' && u.avatar) {
                        const img = document.createElement('img');
                        img.src = u.avatar;
                        img.alt = 'Avatar';
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.borderRadius = '50%';
                        img.style.objectFit = 'cover';
                        preview.appendChild(img);
                    }
                    const tabs = document.createElement('div');
                    tabs.style.display = 'flex';
                    tabs.style.gap = '6px';
                    const emojiTab = document.createElement('button');
                    emojiTab.id = `emojiTab_${u.id}`;
                    emojiTab.className = 'btn';
                    emojiTab.textContent = '游땕 Caritas';
                    const photoTab = document.createElement('button');
                    photoTab.id = `photoTab_${u.id}`;
                    photoTab.className = 'btn';
                    photoTab.textContent = '游닝 Foto';
                    tabs.appendChild(emojiTab);
                    tabs.appendChild(photoTab);
                    const emojiPanel = document.createElement('div');
                    emojiPanel.id = `emojiPanel_${u.id}`;
                    emojiPanel.style.display = u.avatarType === 'emoji' ? 'grid' : 'none';
                    emojiPanel.style.gridTemplateColumns = 'repeat(6, 1fr)';
                    emojiPanel.style.gap = '6px';
                    ['游땕', '游땙', '游봅', '游뱁', '游땒', '游뱅', '游녿', '游놀', '游녽', '游녾', '游놊', '游놋'].forEach(em => {
                        const opt = document.createElement('button');
                        opt.className = 'btn';
                        opt.textContent = em;
                        opt.onclick = () => { selectEmoji(u.id, em); };
                        emojiPanel.appendChild(opt);
                    });
                    const photoPanel = document.createElement('div');
                    photoPanel.id = `photoPanel_${u.id}`;
                    photoPanel.style.display = u.avatarType === 'photo' ? 'block' : 'none';
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.id = `fileInput_${u.id}`;
                    fileInput.style.display = 'none';
                    fileInput.onchange = (ev) => handlePhotoUpload(u.id, ev);
                    const uploadBtn = document.createElement('button');
                    uploadBtn.className = 'btn';
                    uploadBtn.textContent = '游닝 Subir Foto';
                    uploadBtn.onclick = () => document.getElementById(`fileInput_${u.id}`).click();
                    photoPanel.appendChild(fileInput);
                    photoPanel.appendChild(uploadBtn);
                    const nameRow = document.createElement('div');
                    nameRow.style.display = 'grid';
                    nameRow.style.gridTemplateColumns = '120px 1fr';
                    nameRow.style.gap = '6px';
                    const nameLabel = document.createElement('label');
                    nameLabel.className = 'notes-label';
                    nameLabel.textContent = 'Nombre';
                    const nameInput = document.createElement('input');
                    nameInput.className = 'notes-input';
                    nameInput.value = u.name;
                    nameInput.oninput = (e) => { u.name = e.target.value; };
                    nameRow.appendChild(nameLabel);
                    nameRow.appendChild(nameInput);
                    const colorLabel = document.createElement('label');
                    colorLabel.className = 'notes-label';
                    colorLabel.textContent = 'Color';
                    const colorRow = document.createElement('div');
                    colorRow.style.display = 'flex';
                    colorRow.style.flexWrap = 'wrap';
                    colorRow.style.gap = '6px';
                    availableUserColors.forEach(col => {
                        const btn = document.createElement('button');
                        btn.className = 'btn';
                        btn.style.background = col;
                        btn.style.borderColor = 'var(--border-color)';
                        btn.style.color = '#000';
                        btn.textContent = ' ';
                        btn.style.width = '28px';
                        btn.style.height = '28px';
                        btn.style.padding = '0';
                        btn.title = col;
                        btn.dataset.userId = String(u.id);
                        btn.dataset.color = col;
                        btn.onclick = () => {
                            const alreadyInUse = usersEditBuffer.some(other => String(other.id) !== String(u.id) && other.color === col);
                            if (alreadyInUse) {
                                showToast('丘멆잺 Este color ya ha sido reclamado por otro miembro de la corte');
                                return;
                            }
                            u.color = col;
                            refreshUsersColorUI();
                        };
                    });

                    // Sistema adicional de color libre
                    const customColorBtn = document.createElement('div');
                    customColorBtn.style.display = 'flex';
                    customColorBtn.style.alignItems = 'center';
                    customColorBtn.style.gap = '4px';
                    customColorBtn.style.marginLeft = '4px';
                    const customPicker = document.createElement('input');
                    customPicker.type = 'color';
                    customPicker.value = u.color || '#ffffff';
                    customPicker.style.width = '30px';
                    customPicker.style.height = '30px';
                    customPicker.style.border = '1px solid var(--border-color)';
                    customPicker.style.cursor = 'pointer';
                    customPicker.onchange = (e) => {
                        const newCol = e.target.value.toUpperCase();
                        const alreadyInUse = usersEditBuffer.some(other => String(other.id) !== String(u.id) && other.color.toUpperCase() === newCol);
                        if (alreadyInUse) {
                            showToast('丘멆잺 Este tono ya ha sido reclamado por otro miembro de la corte');
                            e.target.value = u.color;
                            return;
                        }
                        u.color = newCol;
                        refreshUsersColorUI();
                    };
                    customColorBtn.appendChild(customPicker);
                    colorRow.appendChild(customColorBtn);

                    body.appendChild(preview);
                    body.appendChild(tabs);
                    body.appendChild(emojiPanel);
                    body.appendChild(photoPanel);
                    body.appendChild(nameRow);
                    body.appendChild(colorLabel);
                    body.appendChild(colorRow);
                    card.appendChild(header);
                    card.appendChild(body);
                    container.appendChild(card);
                    document.getElementById(`emojiTab_${u.id}`).onclick = () => switchAvatarTab(u.id, 'emoji');
                    document.getElementById(`photoTab_${u.id}`).onclick = () => switchAvatarTab(u.id, 'photo');
                });
                container.dataset.usersJson = JSON.stringify(usersEditBuffer);
                refreshUsersColorUI();
            }
            document.getElementById('usersModal').classList.add('show');
        }
        function closeUsersManagement() {
            document.getElementById('usersModal').classList.remove('show');
        }
        async function saveUsersChanges() {
            await saveUsersData(usersEditBuffer);
            showToast('九 Usuarios guardados');
            closeUsersManagement();
            populateFilters();
        }
        function switchAvatarTab(userId, tabType) {
            const emojiPanel = document.getElementById(`emojiPanel_${userId}`);
            const photoPanel = document.getElementById(`photoPanel_${userId}`);
            const emojiTab = document.getElementById(`emojiTab_${userId}`);
            const photoTab = document.getElementById(`photoTab_${userId}`);
            if (tabType === 'emoji') {
                emojiPanel.style.display = 'grid';
                photoPanel.style.display = 'none';
                emojiTab.classList.add('btn-accept');
                photoTab.classList.remove('btn-accept');
            } else {
                photoPanel.style.display = 'block';
                emojiPanel.style.display = 'none';
                photoTab.classList.add('btn-accept');
                emojiTab.classList.remove('btn-accept');
            }
        }
        function selectEmoji(userId, emoji) {
            const idx = usersEditBuffer.findIndex(u => String(u.id) === String(userId));
            if (idx === -1) return;
            usersEditBuffer[idx].avatar = emoji;
            usersEditBuffer[idx].avatarType = 'emoji';
            updateAvatarPreview(userId);
        }
        async function handlePhotoUpload(userId, event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return;
            const dataUrl = await resizeImage(file, 200, 200);
            const idx = usersEditBuffer.findIndex(u => String(u.id) === String(userId));
            if (idx === -1) return;
            usersEditBuffer[idx].avatar = dataUrl;
            usersEditBuffer[idx].avatarType = 'photo';
            updateAvatarPreview(userId);
        }
        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round(width * (maxHeight / height));
                                height = maxHeight;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = maxWidth;
                        canvas.height = maxHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, maxWidth, maxHeight);
                        const x = Math.round((maxWidth - width) / 2);
                        const y = Math.round((maxHeight - height) / 2);
                        ctx.drawImage(img, x, y, width, height);
                        const out = canvas.toDataURL('image/webp', 0.85);
                        resolve(out);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function updateAvatarPreview(userId) {
            const prev = document.getElementById(`avatarPreview_${userId}`);
            const u = usersEditBuffer.find(x => String(x.id) === String(userId));
            if (!prev || !u) return;
            prev.innerHTML = '';
            if (u.avatarType === 'photo' && u.avatar) {
                const img = document.createElement('img');
                img.src = u.avatar;
                img.alt = 'Avatar';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.borderRadius = '50%';
                img.style.objectFit = 'cover';
                prev.appendChild(img);
            } else {
                prev.textContent = u.avatar || '游녻';
            }
        }
        function refreshUsersColorUI() {
            const used = {};
            usersEditBuffer.forEach(u => { used[u.color] = (used[u.color] || 0) + 1; });
            document.querySelectorAll('#usersContainer [data-color]').forEach(el => {
                const color = el.dataset.color;
                const userId = el.dataset.userId;
                const selectedByUser = usersEditBuffer.find(u => String(u.id) === String(userId))?.color === color;
                const inUseByOther = usersEditBuffer.some(u => String(u.id) !== String(userId) && u.color === color);
                el.disabled = inUseByOther && !selectedByUser;
                el.style.opacity = el.disabled ? '0.4' : '1';
                if (selectedByUser) el.classList.add('btn-accept'); else el.classList.remove('btn-accept');
            });
        }

        // ============================================
        // FUNCIONES DE NAVEGACI칍N
        // ============================================
        function showTab(tab) {
            currentView = tab;

            // Actualizar botones de pesta침as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList.add('active');

            // Ocultar todas las vistas
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('calendarView').classList.remove('active');
            document.getElementById('yearView').classList.remove('active');
            document.getElementById('summaryView').style.display = 'none';
            document.getElementById('themeView').style.display = 'none';
            document.getElementById('monthNav').style.display = 'none';
            document.getElementById('bottomActions').style.display = 'none';
            document.getElementById('monthFilters').style.display = 'none';
            document.getElementById('userSelectionView').style.display = 'none';

            // Mostrar vista correspondiente
            if (tab === 'home') {
                document.getElementById('homeView').classList.add('active');
                renderHome();
            } else if (tab === 'calendar') {
                document.getElementById('calendarView').classList.add('active');
                document.getElementById('monthNav').style.display = 'flex';
                document.getElementById('monthFilters').style.display = 'flex';
                // Peque침o delay para asegurar que el layout se actualice
                setTimeout(() => { initMonthFilters(); renderCalendar(); }, 10);
            } else if (tab === 'year') {
                document.getElementById('yearView').classList.add('active');
                renderYear();
            } else if (tab === 'summary') {
                document.getElementById('summaryView').style.display = 'block';
                renderSummary();
            } else if (tab === 'theme') {
                document.getElementById('themeView').style.display = 'block';
                renderThemeView();
            } else if (tab === 'userSelection') {
                document.getElementById('userSelectionView').style.display = 'flex';
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.tab-nav').style.display = 'none';
                renderUserSelection();
            }

            // Mostrar barras si no es selecci칩n de usuario
            if (tab !== 'userSelection') {
                document.querySelector('.header').style.display = 'flex';
                document.querySelector('.tab-nav').style.display = 'flex';
            }
        }

        // ============================================
        // SISTEMA DE TEMAS (ESTILOS VISUALES)
        // ============================================
        let currentTheme = 'medieval';

        function setTheme(theme) {
            currentTheme = theme;

            // Eliminar clases de tema anteriores
            document.body.classList.remove('theme-cyber', 'theme-comic', 'theme-wildwest');

            // Aplicar nueva clase si no es medieval
            if (theme !== 'medieval') {
                document.body.classList.add(`theme-${theme}`);
            }

            // Guardar preferencia
            try {
                localStorage.setItem('app_theme', theme);
            } catch (e) { }

            // Actualizar UI
            renderThemeView();

            // Cambiar iconos o t칤tulos seg칰n el tema
            updateThematicElements();

            showToast(`游꿛 Est칠tica cambiada: ${theme.toUpperCase()}`);
        }

        function loadSavedTheme() {
            const saved = localStorage.getItem('app_theme');
            if (saved && ['medieval', 'cyber', 'comic', 'wildwest'].includes(saved)) {
                setTheme(saved);
            }
        }

        function renderThemeView() {
            const container = document.getElementById('themeView');
            if (!container) return;

            // Actualizar estado activo en las tarjetas
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('active');
                card.style.transform = 'scale(1)';
                card.style.boxShadow = 'none';

                const check = card.querySelector('.theme-check');
                if (check) check.style.display = 'none';

                if (card.classList.contains(currentTheme)) {
                    card.classList.add('active');
                    card.style.transform = 'scale(1.05)';
                    card.style.boxShadow = '0 10px 25px rgba(0,0,0,0.2)';
                    if (check) check.style.display = 'block';
                }
            });
        }

        function updateThematicElements() {
            const title = document.querySelector('.header-title');
            if (!title) return;

            if (currentTheme === 'cyber') {
                title.textContent = '游 FamilySync 2099';
            } else if (currentTheme === 'comic') {
                title.textContent = '游눤 SUPER CALENDAR!';
            } else if (currentTheme === 'wildwest') {
                title.textContent = '救 Estaci칩n Central';
            } else {
                title.textContent = '游닆 Chronicon';
            }

            // Actualizar saludo en home
            const gt = document.getElementById('greetingTitle');
            if (gt) {
                const users = JSON.parse(localStorage.getItem(USER_KEY) || '[]');
                const cur = getCurrentUserId();
                const u = users.find(x => String(x.id) === String(cur));
                const name = u ? u.name : 'Escriba';

                if (currentTheme === 'cyber') gt.textContent = `En l칤nea, ${name}`;
                else if (currentTheme === 'comic') gt.textContent = `춰HOLA ${name.toUpperCase()}!`;
                else if (currentTheme === 'wildwest') gt.textContent = `Saludos, vaquero ${name}`;
                else gt.textContent = `Bienvenido, ${name}`;
            }
        }

        async function renderUserSelection() {
            const grid = document.getElementById('userSelectionGrid');
            if (!grid) return;

            const users = await loadUsersData();
            const currentId = getCurrentUserId();

            grid.innerHTML = '';

            users.forEach(u => {
                const isActive = String(u.id) === String(currentId);
                const card = document.createElement('div');
                card.className = `user-card-switch ${isActive ? 'active' : ''}`;
                card.onclick = () => {
                    setCurrentUserId(u.id);
                    renderUserSelection();
                    updateHomeAvatar();
                };

                const avatar = document.createElement('div');
                avatar.className = 'avatar-circle';
                if (u.avatarType === 'photo' && u.avatar) {
                    const img = document.createElement('img');
                    img.src = u.avatar;
                    avatar.appendChild(img);
                } else {
                    avatar.textContent = (u.name || 'U').charAt(0).toUpperCase();
                    avatar.style.background = u.color || '#fff';
                    avatar.style.color = getContrastYIQ(u.color || '#fff');
                }

                const name = document.createElement('div');
                name.className = 'name';
                name.textContent = u.name;

                const check = document.createElement('div');
                check.className = 'check';
                check.textContent = isActive ? '九' : '';

                card.appendChild(avatar);
                card.appendChild(name);
                card.appendChild(check);
                grid.appendChild(card);
            });
        }

        function getContrastYIQ(hexcolor) {
            if (!hexcolor || hexcolor.length < 4) return 'black';
            hexcolor = hexcolor.replace("#", "");
            if (hexcolor.length === 3) {
                hexcolor = hexcolor[0] + hexcolor[0] + hexcolor[1] + hexcolor[1] + hexcolor[2] + hexcolor[2];
            }
            var r = parseInt(hexcolor.substr(0, 2), 16);
            var g = parseInt(hexcolor.substr(2, 2), 16);
            var b = parseInt(hexcolor.substr(4, 2), 16);
            var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? 'black' : 'white';
        }

        async function updateHomeAvatar() {
            const homeAvatar = document.getElementById('homeAvatar');
            if (!homeAvatar) return;
            const users = await loadUsersData();
            const cur = getCurrentUserId();
            const u = users.find(x => String(x.id) === String(cur));
            if (u) {
                homeAvatar.style.background = u.color;
                const contrast = getContrastYIQ(u.color);
                homeAvatar.style.color = contrast;
                if (u.avatarType === 'photo' && u.avatar) {
                    homeAvatar.innerHTML = `<img src="${u.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                } else {
                    homeAvatar.textContent = u.avatar || '游녻';
                }
                const gt = document.getElementById('greetingTitle');
                if (gt) gt.textContent = `Bienvenido, ${u.name}`;
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            updateMonthTitle();
            renderCalendar();
        }

        function changeYear(delta) {
            currentDate.setFullYear(currentDate.getFullYear() + delta);
            document.getElementById('yearTitle').textContent = currentDate.getFullYear();
            renderYear();
        }

        function openSettings() {
            const ws = localStorage.getItem('week_start') || '1';
            const ht = localStorage.getItem('highlight_today') || 'false';
            const fs = localStorage.getItem('app_font_size') || '16px';
            document.getElementById('weekStartSelect').value = ws;
            document.getElementById('highlightTodaySelect').value = ht;
            document.getElementById('fontSizeSelect').value = fs;
            document.getElementById('settingsModal').classList.add('show');
        }
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        function saveSettings() {
            const ws = document.getElementById('weekStartSelect').value;
            const ht = document.getElementById('highlightTodaySelect').value;
            const fs = document.getElementById('fontSizeSelect').value;
            try {
                localStorage.setItem('week_start', ws);
                localStorage.setItem('highlight_today', ht);
                localStorage.setItem('app_font_size', fs);
            } catch (e) { }
            closeSettingsModal();
            applySettings();
            updateMonthTitle();
            renderCalendar();
            renderWeeklyView();
        }

        function applySettings() {
            const ws = localStorage.getItem('week_start') || '1';
            const ht = localStorage.getItem('highlight_today') || 'false';
            const fs = localStorage.getItem('app_font_size') || '16px';
            document.documentElement.style.setProperty('--app-font-size', fs);
        }

        async function openReminders() {
            const now = new Date();
            const from = new Date(now.getFullYear(), now.getMonth(), 1);
            const to = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const map = await getEventsForRange(from, to);
            const list = document.getElementById('remindersList');
            list.innerHTML = '';
            const items = [];
            Object.entries(map).forEach(([dateStr, events]) => {
                events.forEach(e => {
                    if (e.type === 'note' && (e.category || '').toLowerCase().includes('recordatorio')) {
                        items.push({ dateStr, e });
                    }
                });
            });
            if (items.length === 0) {
                list.innerHTML = '<div style="text-align:center; color: var(--sepia);">No hay recordatorios en este mes</div>';
            } else {
                items.sort((a, b) => a.dateStr.localeCompare(b.dateStr));
                items.forEach(({ dateStr, e }) => {
                    const d = new Date(dateStr);
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.padding = '6px 8px';
                    row.style.borderBottom = '1px solid var(--sepia)';
                    const left = document.createElement('div');
                    left.style.fontFamily = "'Cinzel', serif";
                    left.style.color = 'var(--cinnabar)';
                    left.textContent = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
                    const right = document.createElement('div');
                    right.style.fontFamily = "'Almendra', serif";
                    right.textContent = e.text || '';
                    row.appendChild(left);
                    row.appendChild(right);
                    list.appendChild(row);
                });
            }
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('remindersModal').classList.add('show');
        }

        function openRecurringEvents() {
            const sel = document.getElementById('recShift');
            sel.innerHTML = '';
            shiftTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id || t.name;
                opt.textContent = t.name || t.abbreviation || 'Turno';
                sel.appendChild(opt);
            });
            document.getElementById('recType').onchange = () => {
                const v = document.getElementById('recType').value;
                document.getElementById('recShiftGroup').style.display = v === 'shift' ? 'block' : 'none';
                document.getElementById('recNoteGroup').style.display = v === 'note' ? 'block' : 'none';
            };
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('recurringModal').classList.add('show');
        }
        async function generateRecurring() {
            const type = document.getElementById('recType').value;
            const freq = document.getElementById('recFreq').value;
            const count = parseInt(document.getElementById('recCount').value || '1');
            const start = new Date(document.getElementById('recStart').value || new Date());
            const eventsToSave = [];
            for (let i = 0; i < count; i++) {
                const d = new Date(start);
                if (freq === 'daily') d.setDate(d.getDate() + i);
                else if (freq === 'weekly') d.setDate(d.getDate() + i * 7);
                else if (freq === 'monthly') d.setMonth(d.getMonth() + i);
                const dayEvents = await getEventsForDate(d);
                if (type === 'shift') {
                    const chosen = document.getElementById('recShift').value;
                    const tpl = shiftTemplates.find(t => (t.id || t.name) === chosen);
                    if (!tpl) continue;
                    dayEvents.push({
                        type: 'shift',
                        text: tpl.name || tpl.abbreviation || 'Turno',
                        startTime: tpl.startTime || '',
                        endTime: tpl.endTime || '',
                        backgroundColor: tpl.color || tpl.backgroundColor || ''
                    });
                } else {
                    const text = document.getElementById('recNoteText').value || '';
                    const cat = document.getElementById('recNoteCat').value || 'Recordatorio';
                    dayEvents.push({
                        type: 'note',
                        text: text,
                        category: cat
                    });
                }
                await saveEventsForDate(d, dayEvents);
            }
            document.getElementById('recurringModal').classList.remove('show');
            renderCalendar();
            renderWeeklyView();
            showMessage('Completado', 'Se han generado los eventos recurrentes.');
        }

        function openExport() {
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('exportModal').classList.add('show');
        }
        async function exportCalendar() {
            const fromVal = document.getElementById('exportFrom').value;
            const toVal = document.getElementById('exportTo').value;
            const from = fromVal ? new Date(fromVal) : new Date(new Date().getFullYear(), 0, 1);
            const to = toVal ? new Date(toVal) : new Date(new Date().getFullYear(), 11, 31);
            const map = await getEventsForRange(from, to);
            const blob = new Blob([JSON.stringify(map)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chronicon_${from.toISOString().split('T')[0]}_${to.toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportStatus').textContent = 'Exportado.';
        }

        // MODO ZEN - VIGILIA DEL ESCRIBA
        function toggleZenMode() {
            const isZen = document.body.classList.toggle('zen-mode');
            document.getElementById('toolsModal').classList.remove('show');
            if (isZen) {
                showToast('九 Entrando en la Vigilia del Escriba...');
            } else {
                showToast('游녜勇 Volviendo al Presente');
            }
            renderCalendar();
        }

        function openTools() {
            document.getElementById('settingsModal').classList.remove('show');
            document.getElementById('toolsModal').classList.add('show');
        }
        function backupData() {
            const data = {};
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k && k.startsWith(appId)) data[k] = localStorage.getItem(k);
                }
            } catch (e) { }
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chronicon_backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        function importBackup(ev) {
            const file = ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const obj = JSON.parse(reader.result);
                    Object.entries(obj).forEach(([k, v]) => {
                        localStorage.setItem(k, v);
                    });
                    showMessage('Importado', 'Se restaur칩 el backup.');
                    renderCalendar();
                    renderWeeklyView();
                } catch (e) {
                    showMessage('Error', 'Backup inv치lido.');
                }
            };
            reader.readAsText(file);
        }

        // --- SISTEMA DE LIBRO DE CUENTAS (GOOGLE SHEETS) ---

        function toggleImportArea() {
            const area = document.getElementById('importArea');
            area.style.display = area.style.display === 'none' ? 'flex' : 'none';
        }

        async function exportToCSV() {
            const fromVal = document.getElementById('exportFrom').value;
            const toVal = document.getElementById('exportTo').value;
            const from = fromVal ? new Date(fromVal) : new Date(new Date().getFullYear(), 0, 1);
            const to = toVal ? new Date(toVal) : new Date(new Date().getFullYear(), 11, 31);

            const map = await getEventsForRange(from, to);
            const users = getUsers();

            // Cabecera alineada con Firebase (title, description, time, userId...)
            let csv = "Fecha,ID,Tipo,Titulo,Descripcion,Hora,Color,AutorID,AutorNombre,RecurrenteID,Virtual,Timestamp\n";

            Object.entries(map).forEach(([dateKey, events]) => {
                const parts = dateKey.split('-');
                const dFormatted = `${parts[2]}/${parts[1]}/${parts[0]}`;

                events.forEach(ev => {
                    let cleanText = stripHTML(ev.text || ev.title || '');
                    let authorName = 'Desconocido';
                    const uId = ev.authorId || ev.userId;
                    if (uId) {
                        const u = users.find(x => String(x.id) === String(uId));
                        if (u) authorName = u.name;
                    }

                    // Resolver horarios para turnos si faltan
                    let startT = ev.startTime || ev.time || '';
                    let endT = ev.endTime || '';
                    if ((ev.type === 'shift') && (!startT || !endT)) {
                        const name = (ev.text || ev.title || '').toLowerCase();
                        const tmpl = shiftTemplates.find(t =>
                            (t.name || '').toLowerCase() === name ||
                            (t.abbreviation || '').toLowerCase() === name
                        );
                        if (tmpl) {
                            startT = startT || tmpl.startTime || '';
                            endT = endT || tmpl.endTime || '';
                        }
                    }

                    const row = [
                        dFormatted,
                        ev.id || '',
                        ev.type || 'note',
                        `"${cleanText.replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                        `"${(ev.category || ev.description || '').replace(/"/g, '""')}"`,
                        startT,
                        ev.backgroundColor || ev.userColor || '',
                        uId || '',
                        authorName,
                        ev.recurringId || ev.recurringEventId || '',
                        ev.isRecurring ? "SI" : "NO",
                        ev.timestamp || ''
                    ];
                    csv += row.join(",") + "\n";
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `libro_cuentas_${from.toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('游늵 Libro de Cuentas (CSV) generado con fidelidad Firebase');
        }

        async function importFromSheets() {
            const area = document.getElementById('sheetsPasteArea');
            const content = area.value.trim();
            if (!content) {
                showToast('仇 El pergamino est치 vac칤o');
                return;
            }

            const rows = content.split('\n');
            if (rows.length < 2) return;

            // Detectar delimitador y mapear cabeceras
            const headerRow = rows[0].toLowerCase();
            const sep = headerRow.includes('\t') ? '\t' : (headerRow.includes(';') ? ';' : ',');
            const headers = rows[0].split(sep).map(h => h.trim().toLowerCase());

            const idx = {
                fecha: headers.indexOf('fecha'),
                id: headers.indexOf('id'),
                tipo: headers.indexOf('tipo'),
                titulo: headers.indexOf('titulo'),
                desc: headers.indexOf('descripcion'),
                hora: headers.indexOf('hora'),
                color: headers.indexOf('color'),
                authorId: headers.indexOf('autorid'),
                recId: headers.indexOf('recurrenteid'),
                virtual: headers.indexOf('virtual'),
                ts: headers.indexOf('timestamp')
            };

            let successCount = 0;
            let skipCount = 0;

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row.trim()) continue;

                const cols = row.split(sep);
                if (cols.length < 3) continue;

                // --- PROTECCI칍N CONTRA VIRTUALES ---
                // Si el evento era virtual (recurrido), no lo re-importamos como plano 
                // para evitar duplicados con las reglas de Firebase.
                if (idx.virtual !== -1 && (cols[idx.virtual] || '').trim().toUpperCase() === 'SI') {
                    skipCount++;
                    continue;
                }

                // Parsear Fecha
                let date;
                const dStr = cols[idx.fecha] ? cols[idx.fecha].trim() : '';
                if (dStr.includes('/')) {
                    const [d, m, y] = dStr.split('/');
                    date = new Date(y, m - 1, d);
                } else {
                    date = new Date(dStr);
                }
                if (isNaN(date.getTime())) continue;

                const eventId = idx.id !== -1 && cols[idx.id] ? cols[idx.id].trim() : (Date.now() + Math.random());

                // --- PROTECCI칍N CONTRA DUPLICADOS POR ID ---
                const currentEvents = await getEventsForDate(date);
                if (currentEvents.some(e => String(e.id) === String(eventId))) {
                    skipCount++;
                    continue;
                }

                const typeStr = idx.tipo !== -1 && cols[idx.tipo] ? cols[idx.tipo].trim().toLowerCase() : 'note';

                const event = {
                    id: eventId,
                    type: typeStr,
                    text: idx.titulo !== -1 ? cols[idx.titulo].trim().replace(/^"|"$/g, '') : '',
                    title: idx.titulo !== -1 ? cols[idx.titulo].trim().replace(/^"|"$/g, '') : '',
                    description: idx.desc !== -1 ? cols[idx.desc].trim().replace(/^"|"$/g, '') : '',
                    category: idx.desc !== -1 ? cols[idx.desc].trim().replace(/^"|"$/g, '') : '',
                    startTime: idx.hora !== -1 ? cols[idx.hora].trim() : '',
                    time: idx.hora !== -1 ? cols[idx.hora].trim() : '',
                    backgroundColor: idx.color !== -1 ? cols[idx.color].trim() : '',
                    userColor: idx.color !== -1 ? cols[idx.color].trim() : '',
                    authorId: idx.authorId !== -1 && cols[idx.authorId] ? cols[idx.authorId].trim() : getCurrentUserId(),
                    userId: idx.authorId !== -1 && cols[idx.authorId] ? cols[idx.authorId].trim() : getCurrentUserId(),
                    recurringId: idx.recId !== -1 ? cols[idx.recId].trim() : '',
                    recurringEventId: idx.recId !== -1 ? cols[idx.recId].trim() : '',
                    timestamp: idx.ts !== -1 && cols[idx.ts] ? parseInt(cols[idx.ts]) : Date.now()
                };

                currentEvents.push(event);
                await saveEvents(date, currentEvents);
                successCount++;
            }

            if (successCount > 0) {
                showToast(`九 ${successCount} cr칩nicas importadas. (${skipCount} duplicados/virtuales omitidos)`);
                area.value = '';
                if (document.getElementById('importArea').style.display !== 'none') toggleImportArea();
                renderCalendar();
            } else if (skipCount > 0) {
                showToast(`좶잺 Los anales ya est치n al d칤a. (${skipCount} registros omitidos)`);
            } else {
                showToast('丘멆잺 No se pudo procesar el pergamino.');
            }
        }

        function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('sheetsPasteArea').value = e.target.result;
                if (document.getElementById('importArea').style.display === 'none') toggleImportArea();
                showToast('游늯 Archivo CSV cargado, procediendo...');
                importFromSheets();
            };
            reader.readAsText(file);
        }

        function initDragAndDrop() {
            setTimeout(() => {
                const dropZone = document.getElementById('sheetsPasteArea');
                if (dropZone) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.style.borderColor = 'var(--lapis-lazuli)';
                        dropZone.style.background = 'rgba(21, 101, 192, 0.05)';
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.style.borderColor = 'var(--gold-leaf)';
                        dropZone.style.background = 'white';
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.style.borderColor = 'var(--gold-leaf)';
                        dropZone.style.background = 'white';
                        const file = e.dataTransfer.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (rev) => {
                                document.getElementById('sheetsPasteArea').value = rev.target.result;
                                if (document.getElementById('importArea').style.display === 'none') toggleImportArea();
                                importFromSheets();
                            };
                            reader.readAsText(file);
                        }
                    });
                }
            }, 1000);
        }
        initDragAndDrop();

        function updateMonthTitle() {
            const month = monthNames[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('monthTitle').textContent = `${month.toUpperCase()} ${year}`;
        }

        let currentStatsTab = 'month';
        let rangeStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        let rangeEnd = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0);

        function stripHTML(html) {
            const tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }

        // ============================================
        // FUNCIONES DE RENDERIZADO
        // ============================================
        async function renderHome() {
            const now = new Date();
            const hours = now.getHours();
            let greetingBase = 'Bienvenido';
            if (hours < 12) greetingBase = 'Buenos D칤as';
            else if (hours < 18) greetingBase = 'Buenas Tardes';
            else greetingBase = 'Buenas Noches';

            // Obtener usuario actual para el saludo y avatar
            const users = await loadUsersData();
            const curId = getCurrentUserId();
            const curUser = users.find(u => String(u.id) === curId) || users[0];

            if (curUser) {
                document.getElementById('greetingTitle').textContent = `춰${greetingBase}, ${curUser.name}`;
                const avatarDiv = document.getElementById('homeAvatar');
                if (curUser.avatarType === 'photo' && curUser.avatar) {
                    avatarDiv.innerHTML = `<img src="${curUser.avatar}" alt="Avatar">`;
                } else if (curUser.avatarType === 'emoji') {
                    avatarDiv.textContent = curUser.avatar || '游녻';
                } else {
                    avatarDiv.textContent = '游녻';
                }
            } else {
                document.getElementById('greetingTitle').textContent = greetingBase + ', Escriba';
            }

            document.getElementById('dateDisplay').textContent = formatDate(now);

            // 1. Contar y listar eventos de hoy
            const todayEvents = await getEventsForDate(now);
            document.getElementById('eventsCount').textContent = todayEvents.length;

            const listCont = document.getElementById('homeEventsList');
            if (listCont) {
                listCont.innerHTML = '';
                if (todayEvents.length === 0) {
                    listCont.innerHTML = '<div style="text-align:center; padding: 20px; color: #999; font-style: italic;">No hay cr칩nicas para hoy</div>';
                } else {
                    // Ordenar por hora
                    todayEvents.sort((a, b) => (a.time || '00:00').localeCompare(b.time || '00:00'));
                    todayEvents.forEach(ev => {
                        const item = document.createElement('div');
                        item.className = 'home-event-item';

                        const time = document.createElement('div');
                        time.className = 'home-event-time';
                        time.textContent = ev.time || '--:--';

                        const dot = document.createElement('div');
                        dot.className = 'home-event-dot';
                        dot.style.background = ev.backgroundColor || ev.color || 'var(--gold-leaf)';

                        const title = document.createElement('div');
                        title.className = 'home-event-title';
                        title.textContent = ev.text || ev.title || 'Evento';

                        item.appendChild(time);
                        item.appendChild(dot);
                        item.appendChild(title);
                        listCont.appendChild(item);
                    });
                }
            }

            // 2. Renderizar Mini Calendario (3 semanas)
            renderMiniCalendar();
        }

        async function renderMiniCalendar() {
            const grid = document.getElementById('miniCalendarGrid');
            if (!grid) return;
            grid.innerHTML = '';

            const weekStart = parseInt(localStorage.getItem('week_start') || '1');
            const dayNamesShort = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];

            // Cabeceras de d칤as
            for (let i = 0; i < 7; i++) {
                const dayIdx = (weekStart + i) % 7;
                const h = document.createElement('div');
                h.className = 'mini-header-day';
                h.textContent = dayNamesShort[dayIdx];
                grid.appendChild(h);
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // Calcular el inicio de la semana ACTUAL
            let start = new Date(today);
            let dayOfWeek = today.getDay();
            let diff = dayOfWeek >= weekStart ? dayOfWeek - weekStart : 6 + dayOfWeek;
            start.setDate(today.getDate() - diff);

            // Renderizar 1 semana (7 d칤as)
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);

                const cell = document.createElement('div');
                cell.className = 'mini-day';
                if (isSameDay(d, today)) cell.classList.add('today');
                if (d.getMonth() !== now.getMonth()) cell.classList.add('other-month');

                const num = document.createElement('div');
                num.className = 'mini-day-num';
                num.textContent = d.getDate();
                cell.appendChild(num);

                const eventsCont = document.createElement('div');
                eventsCont.style.fontSize = '9px';
                eventsCont.style.overflow = 'hidden';
                eventsCont.style.flex = '1';
                eventsCont.style.marginTop = '4px';

                const evs = await getEventsForDate(d);
                evs.slice(0, 3).forEach(e => {
                    const line = document.createElement('div');
                    line.style.borderLeft = `3px solid ${e.backgroundColor || e.color || 'var(--gold-leaf)'}`;
                    line.style.paddingLeft = '3px';
                    line.style.marginBottom = '2px';
                    line.style.background = 'rgba(0,0,0,0.03)';
                    line.style.lineHeight = '1.1';

                    const fullText = e.text || e.title || 'Evento';
                    const words = fullText.split(' ').slice(0, 3).join(' ');
                    const timeStr = e.time ? ` [${e.time}]` : '';

                    line.textContent = words + timeStr;
                    eventsCont.appendChild(line);
                });

                cell.appendChild(eventsCont);
                grid.appendChild(cell);
            }
        }

        async function renderCalendar() {
            updateMonthTitle();
            const grid = document.getElementById('calendarGrid');
            const monthFilters = loadMonthFilters();

            const weekStart = parseInt(localStorage.getItem('week_start') || '1');
            const daysSource = ['D', 'L', 'M', 'X', 'J', 'V', 'S'];

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();
            const adjustedStart = (startDayOfWeek - weekStart + 7) % 7;

            // 1. Cargar datos ANTES de limpiar la rejilla
            if (isFirebaseConfigured) {
                await getEventsForRange(firstDay, lastDay);
            }
            const monthPromises = [];
            for (let d = 1; d <= daysInMonth; d++) {
                monthPromises.push(getEventsForDate(new Date(year, month, d)));
            }
            const allMonthEvents = await Promise.all(monthPromises);

            // 2. Limpiar e iniciar construcci칩n
            grid.innerHTML = '';

            const displayWeekDays = [];
            for (let i = 0; i < 7; i++) {
                displayWeekDays.push(daysSource[(weekStart + i) % 7]);
            }
            displayWeekDays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'weekday-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // D칤as del mes anterior
            const prevMonth = new Date(year, month, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = adjustedStart - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevMonthDays - i;
                grid.appendChild(day);
            }

            const weeksNeeded = Math.ceil((adjustedStart + daysInMonth) / 7);
            grid.style.gridTemplateRows = `auto repeat(${weeksNeeded}, 1fr)`;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const day = document.createElement('div');
                day.className = 'calendar-day';
                if (date.toDateString() === today.toDateString()) {
                    const ht = localStorage.getItem('highlight_today') || 'false';
                    if (ht === 'true') day.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = d;
                day.appendChild(dayNumber);

                const dayEvents = document.createElement('div');
                dayEvents.className = 'day-events';
                day.appendChild(dayEvents);

                // Obtener eventos ya pre-cargados
                const events = allMonthEvents[d - 1] || [];

                // Mostrar turnos del d칤a (m치ximo 3, con +N)
                let shifts = events.filter(e => e.type === 'shift');
                let notes = events.filter(e => e.type === 'note');
                if (monthFilters.shiftWanted) {
                    shifts = shifts.filter(e => (e.shiftId === monthFilters.shiftWanted) || ((e.text || '') === monthFilters.shiftWanted));
                }
                if (monthFilters.notesCatWanted) {
                    notes = notes.filter(n => (n.category || '') === monthFilters.notesCatWanted);
                }

                // Filtrar seg칰n modo de vista
                if (monthFilters.viewMode === 'recurring') {
                    notes = notes.filter(n => n.isRecurring);
                    shifts = []; // Ocultar turnos si buscamos solo recurrentes?
                } else if (monthFilters.viewMode === 'notes') {
                    notes = notes.filter(n => !n.isRecurring);
                }

                // Ordenar notas: Recurrentes al final
                notes.sort((a, b) => (a.isRecurring === b.isRecurring ? 0 : a.isRecurring ? 1 : -1));

                if (monthFilters.viewMode !== 'notes' && monthFilters.viewMode !== 'recurring' && shifts.length > 0) {
                    dayEvents.innerHTML = '';
                    if (shifts.length === 1) {
                        const s = shifts[0];
                        const bg = s.backgroundColor || '#f4e4bc';
                        day.style.backgroundColor = bg;
                        const contrast = getContrastColor(bg);
                        dayNumber.style.color = contrast;
                    } else {
                        day.style.backgroundColor = '';
                        shifts.slice(0, 4).forEach(s => {
                            const bar = document.createElement('div');
                            bar.style.background = s.backgroundColor || '#9E9E9E';
                            bar.style.height = '6px';
                            bar.style.margin = '2px 0';
                            bar.style.borderRadius = '2px';
                            bar.style.border = '1px solid rgba(212, 175, 55, 0.3)';
                            dayEvents.appendChild(bar);
                        });
                        if (shifts.length > 4) {
                            const more = document.createElement('div');
                            more.style.fontSize = '8px';
                            more.style.textAlign = 'right';
                            more.textContent = '...';
                            dayEvents.appendChild(more);
                        }
                    }
                    // Mostrar indicadores de notas si hay
                    if (monthFilters.viewMode !== 'shifts' && notes.length > 0) {
                        const icon = document.createElement('div');
                        icon.textContent = '游닆';
                        icon.style.position = 'absolute';
                        icon.style.top = '2px'; icon.style.right = '2px';
                        icon.style.fontSize = '0.8em';
                        dayEvents.appendChild(icon);

                        // Si hay turnos, mostramos menos notas para no saturar
                        const limit = shifts.length > 0 ? 2 : 4;
                        notes.slice(0, limit).forEach((n, index) => {
                            const line = document.createElement('div');
                            line.style.fontSize = '9px';
                            line.style.fontFamily = n.fontFamily || "'Almendra', serif";
                            line.style.marginTop = '0px';
                            line.style.lineHeight = '1';
                            line.style.overflow = 'hidden';
                            line.style.display = '-webkit-box';
                            line.style.webkitLineClamp = '2';
                            line.style.webkitBoxOrient = 'vertical';
                            line.style.maxWidth = '100%';

                            const author = getUsers().find(u => String(u.id) === String(n.authorId));
                            if (author && author.color) line.style.color = author.color;
                            else line.style.color = 'var(--iron-gall)';

                            const textToProcess = (n.text || '').trim();
                            const cleanText = textToProcess.replace(/<[^>]*>/g, '').trim();

                            // Si no hay texto pero hay hora, mostramos algo
                            let displayContent = '';
                            if (cleanText) {
                                // Solo 3 primeras palabras
                                displayContent = cleanText.split(/\s+/).slice(0, 3).join(' ');
                            } else if (n.time) {
                                displayContent = 'Evento';
                            }

                            const timePart = (n.time && !n.isRecurring) ? `<div style="font-weight:bold; opacity:0.8; font-size: 0.9em; margin-top:2px;">${n.time}</div>` : '';
                            line.innerHTML = `<div style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">${displayContent || '...'}</div>` + timePart;

                            // Empujar recurrentes al fondo si es el primero de los recurrentes
                            const firstRecurringIndex = notes.slice(0, limit).findIndex(x => x.isRecurring);
                            if (n.isRecurring && index === firstRecurringIndex) {
                                line.style.marginTop = 'auto';
                            }

                            dayEvents.appendChild(line);
                        });
                    }
                } else if (monthFilters.viewMode !== 'shifts' && notes.length > 0) {
                    dayEvents.innerHTML = '';
                    const limit = 4;
                    notes.slice(0, limit).forEach((n, index) => {
                        const line = document.createElement('div');
                        line.style.fontSize = '9px';
                        line.style.fontFamily = n.fontFamily || "'Almendra', serif";
                        line.style.marginTop = '1px';
                        line.style.lineHeight = '1';
                        line.style.overflow = 'hidden';
                        line.style.display = '-webkit-box';
                        line.style.webkitLineClamp = '2';
                        line.style.webkitBoxOrient = 'vertical';

                        const author = getUsers().find(u => String(u.id) === String(n.authorId));
                        if (author && author.color) line.style.color = author.color;

                        const cleanText = (n.text || '').replace(/<[^>]*>/g, '').trim();
                        const words = cleanText.split(/\s+/).slice(0, 3).join(' ');
                        const timePart = (n.time && !n.isRecurring) ? `<div style="font-weight:bold; opacity:0.9; margin-top:2px;">${n.time}</div>` : '';
                        line.innerHTML = `<div style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">${words || '...'}</div>` + timePart;

                        // Empujar recurrentes al fondo if viewMode is all or recurring
                        const firstRecurringIndex = notes.slice(0, limit).findIndex(x => x.isRecurring);
                        if (n.isRecurring && index === firstRecurringIndex) {
                            line.style.marginTop = 'auto';
                        }

                        dayEvents.appendChild(line);
                    });
                }

                // Manejar click seg칰n modo
                if (selectedShiftForPainting) {
                    day.onclick = () => paintDay(date, selectedShiftForPainting);
                } else if (isDeleteMode) {
                    day.onclick = () => deleteDayShifts(date);
                } else {
                    day.onclick = () => openDayModal(date);
                }

                day.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    day.style.outline = '2px dashed var(--gold-leaf)';
                });
                day.addEventListener('dragleave', () => {
                    day.style.outline = '';
                });
                day.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    day.style.outline = '';
                    const idxRaw = e.dataTransfer.getData('text/plain');
                    const idx = parseInt(idxRaw);
                    if (isNaN(idx) || idx < 0 || idx >= shiftTemplates.length) return;
                    const shift = shiftTemplates[idx];
                    await paintDay(date, shift);
                });

                grid.appendChild(day);
            }

            // D칤as del mes siguiente (Cierre de rejilla exacto para evitar semanas repetidas)
            const dayCellsSoFar = grid.children.length - 7; // -7 de los headers
            const targetCellsCount = weeksNeeded * 7;
            const remaining = targetCellsCount - dayCellsSoFar;

            for (let i = 1; i <= remaining; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                grid.appendChild(day);
            }
        }

        // =========================
        // Vista Semanal
        // =========================
        let weeklyViewMode = 'grid';
        let weeklyPdfWindow = null;

        function openWeeklyView() {
            document.getElementById('weeklyViewModal').classList.add('show');
            setWeeklyViewMode(weeklyViewMode);
        }
        function closeWeeklyView() {
            document.getElementById('weeklyViewModal').classList.remove('show');
        }
        function setWeeklyViewMode(mode) {
            weeklyViewMode = mode;
            document.getElementById('weeklyGridBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('weeklyAgendaBtn').classList.toggle('active', mode === 'agenda');
            document.getElementById('weeklyGrid').style.display = mode === 'grid' ? 'block' : 'none';
            document.getElementById('weeklyAgenda').style.display = mode === 'agenda' ? 'block' : 'none';
            renderWeeklyView();
        }
        function changeWeek(delta) {
            currentDate.setDate(currentDate.getDate() + delta * 7);
            renderWeeklyView();
        }
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const weekStart = parseInt(localStorage.getItem('week_start') || '1');
            const offset = (day - weekStart + 7) % 7;
            d.setDate(d.getDate() - offset);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        async function renderWeeklyView() {
            const start = getWeekStart(currentDate);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            const rangeStr = `${start.getDate()}/${start.getMonth() + 1} - ${end.getDate()}/${end.getMonth() + 1}/${end.getFullYear()}`;
            document.getElementById('weeklyRange').textContent = rangeStr;
            if (weeklyViewMode === 'grid') {
                await renderWeeklyGrid(start);
            } else {
                await renderWeeklyAgenda(start);
            }
        }

        // Funci칩n auxiliar para formatear fecha estilo "Lun, 2 Feb"
        function formatShortDay(date) {
            const shortDays = ['Dom', 'Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b'];
            const shortMonths = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${shortDays[date.getDay()]}, ${date.getDate()} ${shortMonths[date.getMonth()]}`;
        }

        async function renderWeeklyGrid(start) {
            const container = document.getElementById('weeklyGrid');
            container.innerHTML = '';

            const hoursStart = 6, hoursEnd = 23; // Ampliado un poco el rango

            // Header
            const header = document.createElement('div');
            header.style.display = 'grid';
            header.style.gridTemplateColumns = '60px repeat(7, 1fr)';
            header.style.borderBottom = '2px solid var(--gold-leaf)';
            header.style.background = 'var(--parchment-dark)';
            header.style.position = 'sticky';
            header.style.top = '0';
            header.style.zIndex = '10';

            const timeHeader = document.createElement('div');
            header.appendChild(timeHeader);

            const weekStart = parseInt(localStorage.getItem('week_start') || '1');
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i);
                const isToday = isSameDay(d, new Date());
                const cell = document.createElement('div');
                cell.style.textAlign = 'center';
                cell.style.padding = '8px 2px';
                cell.style.fontFamily = "'Cinzel', serif";
                cell.style.fontSize = '12px';
                cell.style.color = isToday ? 'var(--cinnabar)' : 'var(--sepia)';
                cell.style.background = isToday ? 'rgba(139, 38, 53, 0.1)' : 'transparent';
                cell.innerHTML = `<strong>${d.getDate()}</strong><br><small>${formatShortDay(d).split(',')[0]}</small>`;
                header.appendChild(cell);
            }
            container.appendChild(header);

            // Filas
            for (let h = hoursStart; h <= hoursEnd; h++) {
                const row = document.createElement('div');
                row.className = 'week-grid-row';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '60px repeat(7, 1fr)';
                row.style.borderBottom = '1px solid rgba(112, 66, 20, 0.2)';
                row.style.minHeight = '50px';
                row.style.background = 'white';

                const timeDiv = document.createElement('div');
                timeDiv.style.textAlign = 'center';
                timeDiv.style.padding = '4px 0';
                timeDiv.style.fontSize = '11px';
                timeDiv.style.color = '#777';
                timeDiv.style.background = 'var(--parchment-dark)';
                timeDiv.style.borderRight = '1px solid var(--gold-leaf)';
                timeDiv.textContent = `${String(h).padStart(2, '0')}:00`;
                row.appendChild(timeDiv);

                for (let i = 0; i < 7; i++) {
                    const slot = document.createElement('div');
                    slot.className = `day-slot-${i}`;
                    slot.style.position = 'relative';
                    slot.style.borderRight = '1px solid rgba(112, 66, 20, 0.1)';
                    row.appendChild(slot);
                }
                container.appendChild(row);
            }

            // Inyectar eventos
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i);
                const allEvents = await getEventsForDate(d);

                allEvents.forEach(e => {
                    if (e.type !== 'shift' && e.type !== 'note') return;
                    const timeStr = (e.type === 'shift' ? e.startTime : e.time) || '';
                    if (!timeStr.includes(':')) return;

                    const [h, m] = timeStr.split(':').map(Number);
                    if (h < hoursStart || h > hoursEnd) return;

                    const rowIndex = h - hoursStart;
                    const row = container.querySelectorAll('.week-grid-row')[rowIndex];
                    if (!row) return;

                    const slot = row.querySelector(`.day-slot-${i}`);
                    if (!slot) return;

                    const box = document.createElement('div');
                    box.className = 'grid-event-box';
                    box.style.position = 'absolute';
                    box.style.top = `${(m / 60) * 50}px`;
                    box.style.left = '2px';
                    box.style.right = '2px';
                    box.style.padding = '2px 4px';
                    box.style.fontSize = '10px';
                    box.style.borderRadius = '3px';
                    box.style.zIndex = e.type === 'shift' ? '1' : '5';
                    box.style.overflow = 'hidden';
                    box.style.whiteSpace = 'nowrap';
                    box.style.textOverflow = 'ellipsis';
                    box.style.boxShadow = '0 1px 2px rgba(0,0,0,0.1)';

                    if (e.type === 'shift') {
                        box.style.background = e.backgroundColor || 'var(--lapis-lazuli)';
                        box.style.color = 'white';
                        box.style.borderLeft = '3px solid var(--gold-leaf)';
                    } else {
                        box.style.background = 'var(--parchment)';
                        box.style.color = 'var(--iron-gall)';
                        box.style.borderLeft = '3px solid var(--cinnabar)';
                    }

                    const cleanText = (e.text || '').replace(/<[^>]*>/g, '').trim();
                    box.title = cleanText;
                    box.textContent = cleanText;
                    slot.appendChild(box);
                });
            }
        }

        async function renderWeeklyAgenda(start) {
            const container = document.getElementById('weeklyAgenda');
            container.innerHTML = '';
            container.style.padding = '10px';
            container.style.background = '#f8f9fa'; // Un gris muy suave para que resalten las tarjetas blancas

            let totalEvents = 0;

            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i);
                const isToday = isSameDay(d, new Date());
                const allEvents = await getEventsForDate(d);

                // Filtrar solo las notas
                const relevantEvents = allEvents.filter(e => e.type === 'note');
                if (relevantEvents.length === 0) continue;

                totalEvents += relevantEvents.length;

                // Bloque de D칤a (Encabezado verde en la foto)
                const dayHeader = document.createElement('div');
                dayHeader.style.fontFamily = "'Cinzel', serif";
                dayHeader.style.color = isToday ? 'var(--cinnabar)' : '#1B5E20';
                dayHeader.style.fontSize = '14px';
                dayHeader.style.fontWeight = '700';
                dayHeader.style.padding = '12px 10px 4px';
                dayHeader.style.borderBottom = `1px solid ${isToday ? 'var(--cinnabar)' : '#1B5E20'}`;
                dayHeader.style.marginTop = '10px';
                dayHeader.textContent = formatShortDay(d);
                container.appendChild(dayHeader);

                // Ordenar por hora
                relevantEvents.sort((a, b) => {
                    const tA = (a.type === 'shift' ? a.startTime : a.time) || '99:99';
                    const tB = (b.type === 'shift' ? b.startTime : b.time) || '99:99';
                    return tA.localeCompare(tB);
                });

                relevantEvents.forEach(e => {
                    const row = document.createElement('div');
                    row.style.background = 'white';
                    row.style.borderBottom = '1px solid #eee';
                    row.style.display = 'flex';
                    row.style.padding = '12px 10px';
                    row.style.gap = '15px';
                    row.style.transition = 'background 0.2s';
                    row.onmouseenter = () => row.style.background = '#fefefe';
                    row.onmouseleave = () => row.style.background = 'white';

                    // Columna de Hora (Izquierda)
                    const timeCol = document.createElement('div');
                    timeCol.style.width = '50px';
                    timeCol.style.fontSize = '13px';
                    timeCol.style.color = '#777';
                    timeCol.style.fontWeight = 'bold';
                    timeCol.textContent = (e.type === 'shift' ? e.startTime : e.time) || '--:--';

                    // Columna de Contenido (Derecha)
                    const contentCol = document.createElement('div');
                    contentCol.style.flex = '1';

                    const title = document.createElement('div');
                    title.style.fontSize = '14px';
                    title.style.fontWeight = '700';
                    title.style.color = 'var(--iron-gall)';
                    title.style.marginBottom = '2px';

                    const cleanText = (e.text || '').replace(/<[^>]*>/g, '').trim();
                    title.textContent = cleanText || (e.type === 'shift' ? 'Turno' : 'Cr칩nica');

                    const subtext = document.createElement('div');
                    subtext.style.fontSize = '12px';
                    subtext.style.color = '#999';
                    subtext.style.marginBottom = '6px';
                    subtext.textContent = e.category || (e.type === 'shift' ? e.text : '');

                    // Badge (Como en la foto)
                    const badge = document.createElement('span');
                    badge.style.display = 'inline-block';
                    badge.style.padding = '2px 8px';
                    badge.style.borderRadius = '4px';
                    badge.style.fontSize = '10px';
                    badge.style.fontWeight = 'bold';
                    badge.style.textTransform = 'uppercase';

                    if (e.type === 'note') {
                        badge.style.background = '#E3F2FD';
                        badge.style.color = '#2196F3';
                        badge.textContent = 'Nota';
                    } else {
                        badge.style.background = (e.backgroundColor || '#eee') + '33'; // 20% opacidad
                        badge.style.color = e.backgroundColor || '#777';
                        badge.style.border = `1px solid ${e.backgroundColor || '#ddd'}`;
                        badge.textContent = 'Turno';
                    }

                    contentCol.appendChild(title);
                    if (subtext.textContent) contentCol.appendChild(subtext);
                    contentCol.appendChild(badge);

                    row.appendChild(timeCol);
                    row.appendChild(contentCol);
                    container.appendChild(row);
                });
            }

            if (totalEvents === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#999;">
                        <div style="font-size:48px; margin-bottom:10px;">游닔</div>
                        <div style="font-family:'Cinzel', serif;">No hay cr칩nicas para esta semana</div>
                    </div>
                `;
            }

            // Actualizar contador superior si existe
            const totalDisplay = document.getElementById('totalEvents');
            if (totalDisplay) totalDisplay.textContent = totalEvents;
        }
        async function openWeeklyPdfPreview() {
            const mode = weeklyViewMode;
            const container = document.getElementById(mode === 'grid' ? 'weeklyGrid' : 'weeklyAgenda');
            const start = getWeekStart(currentDate);
            const end = new Date(start); end.setDate(start.getDate() + 6);
            const map = await getEventsForRange(start, end);
            const legend = {};
            Object.values(map).forEach(events => {
                events.filter(e => e.type === 'shift').forEach(e => {
                    const key = (e.text || 'Turno') + '|' + (e.backgroundColor || '#9E9E9E');
                    if (!legend[key]) legend[key] = { name: e.text || 'Turno', color: e.backgroundColor || '#9E9E9E', count: 0 };
                    legend[key].count += 1;
                });
            });
            const rangeStr = `${start.getDate()}/${start.getMonth() + 1} - ${end.getDate()}/${end.getMonth() + 1}/${end.getFullYear()}`;
            const legendHtml = Object.values(legend).length > 0 ? `
                <div style="margin-top:16px;">
                    <div style="font-family:'Cinzel', serif; color:#8B2635; font-weight:700; margin-bottom:8px;">Leyenda de Turnos (Semana)</div>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                        ${Object.values(legend).map(i => `
                            <div style="display:flex; align-items:center; gap:8px; border:1px solid #D4AF37; border-radius:6px; padding:6px;">
                                <div style="width:16px; height:16px; border:2px solid #D4AF37; border-radius:50%; background:${i.color};"></div>
                                <div style="flex:1; font-family:'Almendra', serif;">${i.name}</div>
                                <div style="font-family:'Cinzel', serif; color:#704214;">${i.count}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : '';
            const html = `
                <html><head><title>Vista Semanal ${rangeStr}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Almendra:wght@400;700&display=swap" rel="stylesheet">
                </head>
                <body style="font-family:'Almendra', serif; padding:16px; background:#F4E4BC;">
                    <div style="font-family:'Cinzel', serif; font-weight:700; color:#8B2635; margin-bottom:12px; border-bottom:2px solid #D4AF37; padding-bottom:8px;">Semana ${rangeStr}</div>
                    <div style="border:3px double #D4AF37; border-radius:8px; padding:12px; background:rgba(255,255,255,0.6);">
                        ${container.innerHTML}
                    </div>
                    ${legendHtml}
                </body></html>`;
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            w.focus();
            w.print();
        }

        async function openMonthPdfPreview() {
            const month = monthNames[currentDate.getMonth()].toUpperCase();
            const year = currentDate.getFullYear();
            const title = `${month} ${year}`;
            const container = document.getElementById('calendarView');
            const from = new Date(year, currentDate.getMonth(), 1);
            const to = new Date(year, currentDate.getMonth() + 1, 0);
            const map = await getEventsForRange(from, to);
            const monthFilters = loadMonthFilters();
            const legend = {};
            Object.values(map).forEach(events => {
                let evs = events.filter(e => e.type === 'shift');
                if (monthFilters.shiftWanted) {
                    evs = evs.filter(e => (e.shiftId === monthFilters.shiftWanted) || ((e.text || '') === monthFilters.shiftWanted));
                }
                if (monthFilters.viewMode === 'notes') evs = [];
                evs.forEach(e => {
                    const key = (e.text || 'Turno') + '|' + (e.backgroundColor || '#9E9E9E');
                    if (!legend[key]) legend[key] = { name: e.text || 'Turno', color: e.backgroundColor || '#9E9E9E', count: 0 };
                    legend[key].count += 1;
                });
            });
            const legendHtml = Object.values(legend).length > 0 ? `
                <div style="margin-top:16px;">
                    <div style="font-family:'Cinzel', serif; color:#8B2635; font-weight:700; margin-bottom:8px;">Leyenda de Turnos</div>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                        ${Object.values(legend).map(i => `
                            <div style="display:flex; align-items:center; gap:8px; border:1px solid #D4AF37; border-radius:6px; padding:6px;">
                                <div style="width:16px; height:16px; border:2px solid #D4AF37; border-radius:50%; background:${i.color};"></div>
                                <div style="flex:1; font-family:'Almendra', serif;">${i.name}</div>
                                <div style="font-family:'Cinzel', serif; color:#704214;">${i.count}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : '';
            const html = `
                <html><head><title>${title}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Almendra:wght@400;700&display=swap" rel="stylesheet">
                </head>
                <body style="font-family:'Almendra', serif; padding:16px; background:#F4E4BC;">
                    <div style="font-family:'Cinzel', serif; font-weight:700; color:#8B2635; margin-bottom:12px; border-bottom:2px solid #D4AF37; padding-bottom:8px;">${title}</div>
                    <div style="border:3px double #D4AF37; border-radius:8px; padding:12px; background:rgba(255,255,255,0.6);">
                        ${container.innerHTML}
                    </div>
                    ${legendHtml}
                </body></html>`;
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            w.focus();
            w.print();
        }

        async function openYearPdfPreview() {
            const y = currentDate.getFullYear();
            const title = `A칌O ${y}`;
            const from = new Date(y, 0, 1);
            const to = new Date(y, 11, 31);
            const map = await getEventsForRange(from, to);
            const legend = {};
            Object.entries(map).forEach(([dateStr, events]) => {
                events.filter(e => e.type === 'shift').forEach(e => {
                    const key = (e.text || 'Turno') + '|' + (e.backgroundColor || '#9E9E9E');
                    if (!legend[key]) legend[key] = { name: e.text || 'Turno', color: e.backgroundColor || '#9E9E9E', count: 0 };
                    legend[key].count += 1;
                });
            });
            const monthsSummary = [];
            for (let m = 0; m < 12; m++) {
                const s = new Date(y, m, 1);
                const e = new Date(y, m + 1, 0);
                let count = 0;
                const cur = await getEventsForRange(s, e);
                Object.values(cur).forEach(events => {
                    count += events.filter(ev => ev.type === 'shift').length;
                });
                monthsSummary.push({ m, count });
            }
            const legendHtml = Object.values(legend).length > 0 ? `
                <div style="margin-top:16px;">
                    <div style="font-family:'Cinzel', serif; color:#8B2635; font-weight:700; margin-bottom:8px;">Leyenda de Turnos (A침o)</div>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                        ${Object.values(legend).map(i => `
                            <div style="display:flex; align-items:center; gap:8px; border:1px solid #D4AF37; border-radius:6px; padding:6px;">
                                <div style="width:16px; height:16px; border:2px solid #D4AF37; border-radius:50%; background:${i.color};"></div>
                                <div style="flex:1; font-family:'Almendra', serif;">${i.name}</div>
                                <div style="font-family:'Cinzel', serif; color:#704214;">${i.count}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : '';
            const monthsHtml = `
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;">
                    ${monthsSummary.map(ms => `
                        <div style="border:2px solid #D4AF37; border-radius:8px; padding:8px; background:rgba(255,255,255,0.6);">
                            <div style="font-family:'Cinzel', serif; color:#8B2635; font-weight:700; margin-bottom:6px;">${monthNames[ms.m].toUpperCase()}</div>
                            <div style="font-family:'Almendra', serif;">Turnos: ${ms.count}</div>
                        </div>
                    `).join('')}
                </div>`;
            const html = `
                <html><head><title>${title}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Almendra:wght@400;700&display=swap" rel="stylesheet">
                </head>
                <body style="font-family:'Almendra', serif; padding:16px; background:#F4E4BC;">
                    <div style="font-family:'Cinzel', serif; font-weight:700; color:#8B2635; margin-bottom:12px; border-bottom:2px solid #D4AF37; padding-bottom:8px;">${title}</div>
                    ${monthsHtml}
                    ${legendHtml}
                </body></html>`;
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            w.focus();
            w.print();
        }

        function renderSummary() {
            document.getElementById('tabMonth').onclick = () => switchStatsTab('month');
            document.getElementById('tabYear').onclick = () => switchStatsTab('year');
            document.getElementById('tabRange').onclick = () => switchStatsTab('range');

            const fromInp = document.getElementById('fromInput');
            const toInp = document.getElementById('toInput');
            if (fromInp) fromInp.onchange = (e) => {
                const parts = e.target.value.split('-');
                rangeStart = new Date(parts[0], parts[1] - 1, parts[2]);
                calculateStats(rangeStart, rangeEnd);
            };
            if (toInp) toInp.onchange = (e) => {
                const parts = e.target.value.split('-');
                rangeEnd = new Date(parts[0], parts[1] - 1, parts[2]);
                calculateStats(rangeStart, rangeEnd);
            };

            document.getElementById('iconSearchBtn').onclick = () => performIconSearch();
            document.getElementById('clearFiltersBtn').onclick = () => clearFilters();
            const tBtn = document.getElementById('textSearchBtn');
            if (tBtn) tBtn.onclick = () => performTextSearch();
            populateFilters();
            applySavedFilters();
            switchStatsTab(currentStatsTab);
        }

        function switchStatsTab(tab) {
            currentStatsTab = tab;
            document.getElementById('tabMonth').classList.remove('active');
            document.getElementById('tabYear').classList.remove('active');
            document.getElementById('tabRange').classList.remove('active');
            if (tab === 'month') {
                document.getElementById('tabMonth').classList.add('active');
                document.getElementById('rangeControls').style.display = 'none';
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1);
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                calculateStats(start, end);
            } else if (tab === 'year') {
                document.getElementById('tabYear').classList.add('active');
                document.getElementById('rangeControls').style.display = 'none';
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 1);
                const end = new Date(now.getFullYear(), 11, 31);
                calculateStats(start, end);
            } else {
                document.getElementById('tabRange').classList.add('active');
                document.getElementById('rangeControls').style.display = 'flex';
                updateRangeDisplay();
                calculateStats(rangeStart, rangeEnd);
            }
        }

        function updateRangeDisplay() {
            const pad = (n) => String(n).padStart(2, '0');
            const startStr = `${rangeStart.getFullYear()}-${pad(rangeStart.getMonth() + 1)}-${pad(rangeStart.getDate())}`;
            const endStr = `${rangeEnd.getFullYear()}-${pad(rangeEnd.getMonth() + 1)}-${pad(rangeEnd.getDate())}`;

            const fromInp = document.getElementById('fromInput');
            const toInp = document.getElementById('toInput');
            if (fromInp) fromInp.value = startStr;
            if (toInp) toInp.value = endStr;
        }

        function adjustRange(delta) {
            rangeStart.setMonth(rangeStart.getMonth() + delta);
            rangeEnd.setDate(1);
            rangeEnd.setMonth(rangeEnd.getMonth() + delta + 1);
            rangeEnd.setDate(0);
            updateRangeDisplay();
            calculateStats(rangeStart, rangeEnd);
        }

        async function calculateStats(start, end) {
            const tableBody = document.querySelector('#statsTable tbody');
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center">Cargando...</td></tr>';
            const eventsMap = await getEventsForRange(start, end);
            const stats = computeStats(eventsMap);
            renderStatsTable(stats);
        }

        function getCurrentStatsRange() {
            const now = new Date();
            if (currentStatsTab === 'month') {
                const s = new Date(now.getFullYear(), now.getMonth(), 1);
                const e = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                return { start: s, end: e };
            }
            if (currentStatsTab === 'year') {
                const s = new Date(now.getFullYear(), 0, 1);
                const e = new Date(now.getFullYear(), 11, 31);
                return { start: s, end: e };
            }
            return { start: rangeStart, end: rangeEnd };
        }

        async function performTextSearch() {
            const q = (document.getElementById('textSearchInput')?.value || '').trim().toLowerCase();
            const out = document.getElementById('textSearchResult');
            const outEmpty = document.getElementById('textSearchResultEmpty');
            if (!q) {
                if (out) out.innerHTML = '';
                if (outEmpty) { outEmpty.style.display = 'block'; outEmpty.textContent = 'Escribe texto para buscar'; }
                return;
            }
            if (outEmpty) outEmpty.style.display = 'none';
            if (out) out.innerHTML = '<div style="text-align:center; padding:10px;">Buscando...</div>';
            const { start, end } = getCurrentStatsRange();
            const map = await getEventsForRange(start, end);
            const hits = [];
            Object.entries(map).forEach(([dateStr, events]) => {
                events.filter(e => e.type === 'note' && (e.text || '').toLowerCase().includes(q)).forEach(note => {
                    hits.push({ dateKey: dateStr, note });
                });
            });
            if (hits.length === 0) {
                if (out) out.innerHTML = '';
                if (outEmpty) { outEmpty.style.display = 'block'; outEmpty.textContent = 'Sin coincidencias.'; }
                return;
            }
            hits.sort((a, b) => a.dateKey.localeCompare(b.dateKey));
            if (out) {
                out.innerHTML = '';
                hits.forEach(({ dateKey, note }) => {
                    const d = new Date(dateKey);
                    const dateStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                    const item = document.createElement('div');
                    item.className = 'medieval-section';
                    item.style.padding = '8px';
                    item.style.marginBottom = '8px';
                    item.style.cursor = 'pointer';
                    item.onclick = () => { currentDate = new Date(dateKey); showTab('calendar'); openDayModal(currentDate); };
                    const header = document.createElement('div');
                    header.style.display = 'flex';
                    header.style.justifyContent = 'space-between';
                    header.style.marginBottom = '4px';
                    const dateDiv = document.createElement('div');
                    dateDiv.style.fontFamily = "var(--font-header)";
                    dateDiv.style.fontWeight = 'bold';
                    dateDiv.style.color = 'var(--accent-red)';
                    dateDiv.textContent = dateStr;
                    const catDiv = document.createElement('div');
                    catDiv.style.fontFamily = "var(--font-main)";
                    catDiv.style.color = 'var(--text-muted)';
                    catDiv.textContent = note.category || '';
                    header.appendChild(dateDiv);
                    header.appendChild(catDiv);
                    item.appendChild(header);
                    const body = document.createElement('div');
                    body.style.fontFamily = "var(--font-main)";
                    body.style.fontSize = '14px';
                    body.style.color = 'var(--text-main)';
                    body.textContent = stripHTML(note.text || '(Sin texto)');
                    try {
                        const users = getUsers();
                        const u = users.find(x => String(x.id) === String(note.authorId));
                        if (u && u.color) body.style.color = u.color;
                    } catch (e) { }
                    item.appendChild(body);
                    out.appendChild(item);
                });
            }
        }

        async function getEventsForRange(d1, d2) {
            const out = {};
            const startKey = formatDateKey(d1);
            const endKey = formatDateKey(d2);

            // 1. Carga masiva de Firebase si aplica
            if (isFirebaseConfigured && db) {
                try {
                    const snapshot = await db.collection('calendar_events')
                        .where(firebase.firestore.FieldPath.documentId(), '>=', startKey)
                        .where(firebase.firestore.FieldPath.documentId(), '<=', endKey)
                        .get();

                    // Marcar todos los d칤as del rango como "vac칤os" en cach칠 inicialmente
                    // para evitar re-peticiones as칤ncronas lentas
                    let temp = new Date(d1);
                    while (temp <= d2) {
                        const k = formatDateKey(temp);
                        if (!eventsCache[k]) eventsCache[k] = [];
                        temp.setDate(temp.getDate() + 1);
                    }

                    snapshot.forEach(doc => {
                        eventsCache[doc.id] = doc.data().events || [];
                    });
                } catch (error) {
                    console.error('Error cargando rango:', error);
                }
            }

            // 2. Procesar d칤as sin re-pedir a Firebase (usando getEventsForDate sincronizado)
            const cur = new Date(d1);
            while (cur <= d2) {
                const dateKey = formatDateKey(cur);
                // Llamamos a getEventsForDate que ahora ser치 r치pido porque los datos est치n en cach칠
                const events = await getEventsForDate(new Date(cur));
                if (events && events.length > 0) out[dateKey] = events;
                cur.setDate(cur.getDate() + 1);
            }
            return out;
        }

        function parseTimeToMinutes(t) {
            if (!t || typeof t !== 'string' || !t.includes(':')) return null;
            const [h, m] = t.split(':').map(Number);
            if (isNaN(h) || isNaN(m)) return null;
            return h * 60 + m;
        }

        function computeStats(map) {
            const acc = {};
            let totalCount = 0;
            let totalMins = 0;

            Object.values(map).forEach(events => {
                events.filter(e => e.type === 'shift').forEach(e => {
                    let name = e.text || 'Otros';
                    let startT = e.startTime;
                    let endT = e.endTime;
                    let color = e.backgroundColor || '#9E9E9E';

                    // Si faltan datos, intentamos sacarlos de la plantilla
                    const tmpl = shiftTemplates.find(t =>
                        (t.name || '').toLowerCase() === name.toLowerCase() ||
                        (t.abbreviation || '').toLowerCase() === name.toLowerCase()
                    );
                    if (tmpl) {
                        startT = startT || tmpl.startTime;
                        endT = endT || tmpl.endTime;
                        color = tmpl.color || color;
                        name = tmpl.abbreviation || name;
                    }

                    let startM = parseTimeToMinutes(startT);
                    let endM = parseTimeToMinutes(endT);
                    let dur = 0;
                    if (startM !== null && endM !== null) {
                        if (startM === endM) {
                            dur = 1440; // 24 horas exactas
                        } else {
                            dur = endM > startM ? (endM - startM) : (1440 - startM + endM);
                        }
                    }

                    if (!acc[name]) acc[name] = { count: 0, mins: 0, name, color };
                    acc[name].count += 1;
                    acc[name].mins += dur;
                    totalCount += 1;
                    totalMins += dur;
                });
            });
            return { map: acc, totalCount, totalMins };
        }

        function renderStatsTable(stats) {
            const tbody = document.querySelector('#statsTable tbody');
            tbody.innerHTML = '';
            Object.values(stats.map).forEach(item => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(212, 175, 55, 0.1)';

                const h = Math.floor(item.mins / 60);
                const m = item.mins % 60;

                tr.innerHTML = `
                    <td style="padding:10px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div style="width:28px; height:28px; background:${item.color}; border-radius:6px; display:flex; align-items:center; justify-content:center; color:white; font-family:'Cinzel'; font-weight:bold; font-size:11px; border:1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${item.name.slice(0, 2)}</div>
                            <span style="font-family:'Almendra'; font-size:14px;">${item.name}</span>
                        </div>
                    </td>
                    <td style="text-align:center; padding:10px; font-family:'Cinzel'; font-weight:bold;">${item.count}</td>
                    <td style="text-align:center; padding:10px; font-family:'Spectral'; font-size:12px;">${h}h ${m}m</td>
                    <td style="text-align:center; padding:10px;">
                        <input type="checkbox" checked class="stats-check" 
                               data-count="${item.count}" data-mins="${item.mins}"
                               onchange="updateGlobalCalculation()"
                               style="accent-color: var(--lapis-lazuli); cursor:pointer;">
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if (Object.keys(stats.map).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: var(--sepia); padding: 20px;">Sin datos en este per칤odo</td></tr>';
            }
            updateGlobalCalculation();
        }

        function updateGlobalCalculation() {
            const checks = document.querySelectorAll('.stats-check');
            let tCount = 0;
            let tMins = 0;
            checks.forEach(c => {
                if (c.checked) {
                    tCount += parseInt(c.dataset.count || 0);
                    tMins += parseInt(c.dataset.mins || 0);
                }
            });
            const hGlobal = Math.floor(tMins / 60);
            const mGlobal = tMins % 60;
            document.getElementById('statsGlobal').innerHTML = `
                <div style="text-align:right; font-family:'Cinzel'; font-size:14px; color:var(--sepia); padding-top: 10px; border-top: 2px double rgba(212,175,55,0.3); margin-top: 8px;">
                    GLOBAL: <span style="font-weight:bold; color:var(--lapis-lazuli); font-size:16px;">${tCount} Turnos</span>
                    <span style="font-weight:bold; color:var(--cinnabar); margin-left:12px;">${hGlobal}H, ${mGlobal}M</span>
                </div>`;
        }

        function populateFilters() {
            const shiftSelect = document.getElementById('shiftFilter');
            if (shiftSelect) {
                shiftSelect.innerHTML = '<option value="">Todos los turnos</option>';
                shiftTemplates.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id || t.name;
                    opt.textContent = t.name || t.abbreviation || 'Turno';
                    shiftSelect.appendChild(opt);
                });
            }
            const userSelect = document.getElementById('userFilter');
            if (userSelect) {
                userSelect.innerHTML = '<option value="">Todos los usuarios</option>';
                getUsers().forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = u.name;
                    userSelect.appendChild(opt);
                });
            }
        }

        function clearFilters() {
            const iconSel = document.getElementById('iconPicker');
            const shiftSel = document.getElementById('shiftFilter');
            const userSel = document.getElementById('userFilter');
            if (iconSel) iconSel.value = '';
            if (shiftSel) shiftSel.value = '';
            if (userSel) userSel.value = '';
            const out = document.getElementById('iconSearchResult');
            const outEmpty = document.getElementById('iconSearchResultEmpty');
            if (out) out.innerHTML = '';
            if (outEmpty) outEmpty.style.display = 'block';
        }

        const FILTERS_KEY = 'medieval_filters_v1';
        function saveFilters() {
            const data = {
                icon: document.getElementById('iconPicker')?.value || '',
                shift: document.getElementById('shiftFilter')?.value || '',
                user: document.getElementById('userFilter')?.value || ''
            };
            try { localStorage.setItem(FILTERS_KEY, JSON.stringify(data)); } catch (e) { }
        }
        function applySavedFilters() {
            try {
                const raw = localStorage.getItem(FILTERS_KEY);
                if (!raw) return;
                const f = JSON.parse(raw);
                const iconSel = document.getElementById('iconPicker');
                const shiftSel = document.getElementById('shiftFilter');
                const userSel = document.getElementById('userFilter');
                function setIfExists(sel, val) {
                    if (!sel) return;
                    const opts = Array.from(sel.options).map(o => o.value);
                    if (opts.includes(val)) sel.value = val;
                }
                setIfExists(iconSel, f.icon);
                setIfExists(shiftSel, f.shift);
                setIfExists(userSel, f.user);
            } catch (e) { }
        }

        const MONTH_FILTERS_KEY = 'month_filters_v1';
        function loadMonthFilters() {
            try {
                const raw = localStorage.getItem(MONTH_FILTERS_KEY);
                if (!raw) return { viewMode: 'all', shiftWanted: '', notesCatWanted: '' };
                const f = JSON.parse(raw);
                return { viewMode: f.viewMode || 'all', shiftWanted: f.shiftWanted || '', notesCatWanted: f.notesCatWanted || '' };
            } catch (e) { return { viewMode: 'all', shiftWanted: '', notesCatWanted: '' }; }
        }
        function saveMonthFilters(f) {
            try { localStorage.setItem(MONTH_FILTERS_KEY, JSON.stringify(f)); } catch (e) { }
        }
        function initMonthFilters() {
            const selView = document.getElementById('monthViewMode');
            const selShift = document.getElementById('monthShiftFilter');
            const selCat = document.getElementById('monthNoteCat');
            if (!selView || !selShift) return;
            selShift.innerHTML = '<option value=\"\">Todos los turnos</option>';
            shiftTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id || t.name || '';
                opt.textContent = t.name || t.abbreviation || 'Turno';
                selShift.appendChild(opt);
            });
            if (selCat) {
                selCat.innerHTML = '<option value=\"\">Todas las notas</option>';
                ['Cumplea침os', 'Trabajo', 'Personal', 'Familia', 'Salud'].forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    selCat.appendChild(opt);
                });
            }
            const cur = loadMonthFilters();
            selView.value = cur.viewMode;
            const shiftVals = Array.from(selShift.options).map(o => o.value);
            selShift.value = shiftVals.includes(cur.shiftWanted) ? cur.shiftWanted : '';
            selView.onchange = () => { const f = loadMonthFilters(); f.viewMode = selView.value; saveMonthFilters(f); renderCalendar(); };
            selShift.onchange = () => { const f = loadMonthFilters(); f.shiftWanted = selShift.value; saveMonthFilters(f); renderCalendar(); };
            if (selCat) {
                const catVals = Array.from(selCat.options).map(o => o.value);
                selCat.value = catVals.includes(cur.notesCatWanted) ? cur.notesCatWanted : '';
                selCat.onchange = () => { const f = loadMonthFilters(); f.notesCatWanted = selCat.value; saveMonthFilters(f); renderCalendar(); };
            }
            const clearBtn = document.getElementById('monthFiltersClearBtn');
            if (clearBtn) clearBtn.onclick = () => clearMonthFilters();
            renderMonthFilterChips();
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) undoBtn.onclick = () => undoLastAction();
            const redoBtn = document.getElementById('redoBtn');
            if (redoBtn) redoBtn.onclick = () => redoLastUndo();
        }
        function renderMonthFilterChips() {
            const chips = document.getElementById('monthFilterChips');
            if (!chips) return;
            chips.innerHTML = '';
            const f = loadMonthFilters();
            const addChip = (label) => {
                const c = document.createElement('div');
                c.style.border = '1px solid var(--gold-leaf)';
                c.style.borderRadius = '12px';
                c.style.padding = '4px 8px';
                c.style.fontFamily = "'Cinzel', serif";
                c.style.fontSize = '12px';
                c.style.color = 'var(--cinnabar)';
                c.textContent = label;
                chips.appendChild(c);
            };
            if (f.viewMode === 'shifts') addChip('Solo turnos');
            if (f.viewMode === 'notes') addChip('Solo notas');
            if (f.shiftWanted) {
                const tpl = shiftTemplates.find(t => (t.id || t.name) === f.shiftWanted);
                addChip(`Turno: ${tpl ? (tpl.name || tpl.abbreviation || 'Turno') : f.shiftWanted}`);
            }
            if (f.notesCatWanted) addChip(`Categor칤a: ${f.notesCatWanted}`);
        }
        function clearMonthFilters() {
            saveMonthFilters({ viewMode: 'all', shiftWanted: '', notesCatWanted: '' });
            initMonthFilters();
            renderCalendar();
        }

        function normalizeIcon(s) {
            return s ? s.normalize('NFKC').replace(/\uFE0F/g, '') : '';
        }
        async function performIconSearch() {
            const iconSel = document.getElementById('iconPicker');
            const icon = normalizeIcon(iconSel.value);
            const shiftWanted = document.getElementById('shiftFilter').value;
            const userWanted = document.getElementById('userFilter').value;
            const out = document.getElementById('iconSearchResult');
            const outEmpty = document.getElementById('iconSearchResultEmpty');
            if (!icon) {
                out.style.display = 'none';
                outEmpty.style.display = 'block';
                outEmpty.textContent = 'Selecciona un icono para buscar';
                return;
            }
            saveFilters();
            out.innerHTML = '<div style="text-align:center; padding:10px;">Buscando...</div>';
            out.style.display = 'block';
            outEmpty.style.display = 'none';
            const now = new Date();
            const from = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            const to = new Date(now.getFullYear() + 1, now.getMonth(), now.getDate());
            const map = await getEventsForRange(from, to);
            const hits = [];
            Object.entries(map).forEach(([dateStr, events]) => {
                // Buscamos si hay alguna nota cuya categor칤a coincida exactamente con el filtro
                const note = events.find(e => e.type === 'note' && (e.category === iconSel.value || normalizeIcon(e.category) === iconSel.value));
                if (!note) return;

                if (userWanted) {
                    const authorOk = note.authorId ? String(note.authorId) === String(userWanted) : false;
                    const visibleOk = Array.isArray(note.visibleTo) ? note.visibleTo.includes(userWanted) : false;
                    if (!(authorOk || visibleOk)) return;
                }
                if (shiftWanted) {
                    const hasShift = events.some(ev => ev.type === 'shift' && (ev.shiftId === shiftWanted || ev.text === shiftWanted));
                    if (!hasShift) return;
                }
                hits.push({ dateKey: dateStr, events, note });
            });
            if (hits.length === 0) {
                out.style.display = 'none';
                outEmpty.style.display = 'block';
                outEmpty.textContent = 'No se han encontrado coincidencias.';
                return;
            }
            out.innerHTML = '';
            hits.sort((a, b) => a.dateKey.localeCompare(b.dateKey));
            hits.forEach(({ dateKey, events, note }) => {
                const d = new Date(dateKey);
                const dateStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getFullYear()).slice(-2)}`;
                const item = document.createElement('div');
                item.className = 'medieval-section';
                item.style.padding = '8px';
                item.style.marginBottom = '8px';
                item.style.cursor = 'pointer';
                item.onclick = () => { currentDate = new Date(dateKey); showTab('calendar'); openDayModal(currentDate); };
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.marginBottom = '4px';
                const dateDiv = document.createElement('div');
                dateDiv.style.fontFamily = "'Cinzel', serif";
                dateDiv.style.fontWeight = 'bold';
                dateDiv.style.color = 'var(--cinnabar)';
                dateDiv.textContent = dateStr;
                const shiftsDiv = document.createElement('div');
                const shiftEvents = events.filter(e => e.type === 'shift');
                shiftEvents.forEach(s => {
                    const span = document.createElement('span');
                    span.textContent = s.text || 'T';
                    span.style.marginLeft = '4px';
                    span.style.fontSize = '12px';
                    span.style.color = 'var(--lapis-lazuli)';
                    shiftsDiv.appendChild(span);
                });
                header.appendChild(dateDiv);
                header.appendChild(shiftsDiv);
                item.appendChild(header);
                const body = document.createElement('div');
                body.style.fontFamily = "'Almendra', serif";
                body.style.fontSize = '14px';
                body.textContent = stripHTML(note.text || '(Sin texto)');
                try {
                    const users = getUsers();
                    const u = users.find(x => String(x.id) === String(note.authorId));
                    if (u && u.color) body.style.color = u.color;
                } catch (e) { }
                item.appendChild(body);
                out.appendChild(item);
            });
        }
        // Pintar d칤a con turno
        async function paintDay(date, shift) {
            const events = await getEventsForDate(date);
            pushUndoSnapshot(date, events);
            const shiftEvent = {
                type: 'shift',
                text: shift.name || shift.abbreviation,
                shiftId: shift.id,
                backgroundColor: shift.backgroundColor || shift.colorHex || shift.color,
                userId: getCurrentUserId() || null,
                createdAt: new Date().toISOString()
            };
            events.push(shiftEvent);
            await saveEvents(date, events);
            renderCalendar();
            showToast(`九 Turno "${shift.name || shift.abbreviation}" asignado`);
        }

        // Borrar turnos de un d칤a con selecci칩n si hay varios
        async function deleteDayShifts(date) {
            const events = await getEventsForDate(date);
            const notes = events.filter(e => e.type === 'note');
            const shifts = events.filter(e => e.type === 'shift');

            if (shifts.length === 0) {
                showToast('游닆 No hay turnos que borrar en este d칤a');
                return;
            }

            let toDelete = [];
            if (shifts.length === 1) {
                toDelete = [shifts[0]];
            } else {
                // Si hay varios, preguntar al usuario
                const options = shifts.map((s, i) => `${i + 1}. ${s.text}`).join('\n');
                const choice = prompt(`M칰ltiples turnos encontrados el ${formatDate(date)}:\n${options}\n\nEscribe el n칰mero del turno a borrar, o escribe "todos" para limpiar los turnos:`);

                if (choice === null) return; // Cancelado
                if (choice.toLowerCase() === 'todos') {
                    toDelete = shifts;
                } else {
                    const idx = parseInt(choice) - 1;
                    if (shifts[idx]) {
                        toDelete = [shifts[idx]];
                    } else {
                        showToast('仇 Selecci칩n no v치lida');
                        return;
                    }
                }
            }

            pushUndoSnapshot(date, events);
            const finalEvents = events.filter(e => !toDelete.includes(e));
            await saveEvents(date, finalEvents);
            renderCalendar();
            showToast(toDelete.length > 1 ? '游딈勇 Turnos eliminados' : `游딈勇 Turno "${toDelete[0].text}" eliminado`);
        }

        async function renderYear() {
            const year = currentDate.getFullYear();
            document.getElementById('yearTitle').textContent = year;
            const grid = document.getElementById('yearGrid');
            grid.innerHTML = '';

            for (let m = 0; m < 12; m++) {
                const monthBox = document.createElement('div');
                monthBox.className = 'year-month';

                const header = document.createElement('div');
                header.className = 'year-month-header';
                header.textContent = monthNames[m].toUpperCase();
                monthBox.appendChild(header);

                const monthGrid = document.createElement('div');
                monthGrid.className = 'year-month-grid';

                // Encabezados
                weekDays.forEach(day => {
                    const wEl = document.createElement('div');
                    wEl.className = 'year-day';
                    wEl.textContent = day;
                    monthGrid.appendChild(wEl);
                });

                const firstDay = new Date(year, m, 1);
                const lastDay = new Date(year, m + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();
                const adjustedStart = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1;

                // Relleno inicial
                for (let i = 0; i < adjustedStart; i++) {
                    const dEl = document.createElement('div');
                    dEl.className = 'year-day other-month';
                    monthGrid.appendChild(dEl);
                }

                // D칤as del mes
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, m, d);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'year-day';

                    const num = document.createElement('div');
                    num.className = 'year-day-number';
                    num.textContent = d;
                    dayEl.appendChild(num);

                    // Cargar eventos y mostrar color de turnos
                    getEventsForDate(date).then(events => {
                        if (events.length > 0) {
                            const shift = events.find(e => e.type === 'shift');
                            if (shift) {
                                dayEl.style.backgroundColor = shift.backgroundColor || shift.userColor || 'var(--accent-red)';
                                dayEl.style.color = '#fff';
                                dayEl.style.opacity = '0.7';
                            } else {
                                dayEl.style.backgroundColor = 'var(--accent-gold)';
                                dayEl.style.opacity = '0.3';
                            }
                        }
                    });

                    dayEl.onclick = () => {
                        currentDate = new Date(year, m, d);
                        showTab('calendar');
                    };

                    monthGrid.appendChild(dayEl);
                }

                // Completar hasta m칰ltiplo de 7
                const used = adjustedStart + daysInMonth;
                const rest = (7 - (used % 7)) % 7;
                for (let i = 0; i < rest; i++) {
                    const dEl = document.createElement('div');
                    dEl.className = 'year-day other-month';
                    monthGrid.appendChild(dEl);
                }

                monthBox.appendChild(monthGrid);
                grid.appendChild(monthBox);
            }
        }

        // ============================================
        // FUNCIONES DE EVENTOS
        // ============================================
        let undoStack = [];
        let redoStack = [];
        function getDateKeyStr(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        function pushUndoSnapshot(date, prevEvents) {
            const key = getDateKeyStr(date);
            undoStack.push({ prev: { [key]: JSON.parse(JSON.stringify(prevEvents)) } });
            redoStack = [];
        }
        function pushUndoSnapshots(mapPrev) {
            // mapPrev: { key: eventsArray }
            const cloned = {};
            Object.entries(mapPrev).forEach(([k, v]) => cloned[k] = JSON.parse(JSON.stringify(v)));
            undoStack.push({ prev: cloned });
            redoStack = [];
        }
        async function undoLastAction() {
            if (undoStack.length === 0) { showToast('뾆잺 Nada que deshacer'); return; }
            const entry = undoStack.pop();
            const keys = Object.keys(entry.prev || {});
            const curMap = {};
            for (const k of keys) {
                const [yy, mm, dd] = k.split('-').map(Number);
                const d = new Date(yy, mm - 1, dd);
                curMap[k] = await getEventsForDate(d);
            }
            redoStack.push({ next: curMap });
            for (const k of keys) {
                const [yy, mm, dd] = k.split('-').map(Number);
                const d = new Date(yy, mm - 1, dd);
                const prev = entry.prev[k] || [];
                await saveEvents(d, prev);
            }
            renderCalendar();
            showToast('뾆잺 Acci칩n deshecha');
        }
        async function redoLastUndo() {
            if (redoStack.length === 0) { showToast('쀮잺 Nada que rehacer'); return; }
            const entry = redoStack.pop();
            const keys = Object.keys(entry.next || {});
            const prevMap = {};
            for (const k of keys) {
                const [yy, mm, dd] = k.split('-').map(Number);
                const d = new Date(yy, mm - 1, dd);
                prevMap[k] = await getEventsForDate(d);
            }
            undoStack.push({ prev: prevMap });
            for (const k of keys) {
                const [yy, mm, dd] = k.split('-').map(Number);
                const d = new Date(yy, mm - 1, dd);
                const next = entry.next[k] || [];
                await saveEvents(d, next);
            }
            renderCalendar();
            showToast('쀮잺 Acci칩n rehecha');
        }
        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function toggleQuickMenu(e) {
            const menu = document.getElementById('quickMenu');
            if (!menu) return;
            const isOpen = menu.style.display === 'block';
            menu.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) {
                const header = document.querySelector('.header');
                if (header) {
                    const r = header.getBoundingClientRect();
                    menu.style.top = `${r.bottom}px`;
                    menu.style.right = '8px';
                    menu.style.left = '';
                }
            }
            e.stopPropagation();
        }
        function toggleLeftActionsMenu(e) {
            const menu = document.getElementById('leftActionsMenu');
            if (!menu) return;
            const isOpen = menu.style.display === 'block';
            menu.style.display = isOpen ? 'none' : 'block';
            if (!isOpen) {
                const header = document.querySelector('.header');
                if (header) {
                    const r = header.getBoundingClientRect();
                    menu.style.top = `${r.bottom}px`;
                    menu.style.left = '8px';
                    menu.style.right = '';
                }
            }
            e.stopPropagation();
        }
        document.addEventListener('click', function () {
            const menu = document.getElementById('quickMenu');
            if (menu) menu.style.display = 'none';
            const left = document.getElementById('leftActionsMenu');
            if (left) left.style.display = 'none';
        });
        document.addEventListener('keydown', function (ev) {
            if (ev.key === 'Escape') {
                const menu = document.getElementById('quickMenu');
                if (menu) menu.style.display = 'none';
                const left = document.getElementById('leftActionsMenu');
                if (left) left.style.display = 'none';
            }
        });

        const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi칠rcoles', 'Jueves', 'Viernes', 'S치bado'];
        function formatDate(date) {
            const day = date.getDate();
            const dayName = dayNames[date.getDay()];
            const month = monthNames[date.getMonth()];
            return `${dayName}, ${day} de ${month}`;
        }

        // =========================
        // Vista Semanal / Recurrentes
        // =========================
        let editingRecurringId = null;

        function matchesRecurring(def, date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dTime = d.getTime();

            const startStr = def.startDate || def.start;
            if (!startStr) return false;

            const parts = String(startStr).split('-').map(Number);
            const start = parts.length === 3 ? new Date(parts[0], parts[1] - 1, parts[2]) : new Date(startStr);
            start.setHours(0, 0, 0, 0);
            const startTime = start.getTime();

            if (dTime < startTime) return false;

            // Si hay fecha de fin y ya pas칩, no aplica
            if (def.endDate) {
                const end = new Date(def.endDate);
                end.setHours(23, 59, 59, 999);
                if (dTime > end.getTime()) return false;
            }

            const freq = def.frequency;

            if (freq === 'daily') return true;

            if (freq === 'weekly') {
                if (def.daysOfWeek && def.daysOfWeek.length > 0) {
                    return def.daysOfWeek.includes(d.getDay());
                }
                return d.getDay() === start.getDay();
            }

            if (freq === 'monthly') {
                return d.getDate() === start.getDate();
            }

            if (freq === 'yearly') {
                return d.getDate() === start.getDate() && d.getMonth() === start.getMonth();
            }

            if (freq === 'custom') {
                const interval = parseInt(def.interval || '1');
                const unit = def.unit || 'day';

                if (unit === 'day') {
                    const diffDays = Math.floor((dTime - startTime) / (1000 * 60 * 60 * 24));
                    if (diffDays % interval !== 0) return false;
                    // Filtro opcional por d칤as de la semana
                    if (def.daysOfWeek && def.daysOfWeek.length > 0) {
                        return def.daysOfWeek.includes(d.getDay());
                    }
                    return true;
                }

                if (unit === 'week') {
                    const diffWeeks = Math.floor((dTime - startTime) / (1000 * 60 * 60 * 24 * 7));
                    if (diffWeeks % interval !== 0) return false;

                    // Si se especificaron d칤as de la semana
                    if (def.daysOfWeek && def.daysOfWeek.length > 0) {
                        return def.daysOfWeek.includes(d.getDay());
                    }
                    // Si no, por el mismo d칤a de la semana que el inicio
                    return d.getDay() === start.getDay();
                }

                if (unit === 'month') {
                    const dYear = d.getFullYear();
                    const dMonth = d.getMonth();
                    const sYear = start.getFullYear();
                    const sMonth = start.getMonth();
                    const diffMonths = (dYear - sYear) * 12 + (dMonth - sMonth);
                    if (diffMonths % interval !== 0) return false;

                    // Filtro opcional por d칤as de la semana (poco com칰n en mensual pero posible)
                    if (def.daysOfWeek && def.daysOfWeek.length > 0) {
                        return def.daysOfWeek.includes(d.getDay());
                    }
                    return d.getDate() === start.getDate();
                }
            }
            return false;
        }

        // =========================
        // L칩gica de UI Recurrentes
        // =========================
        function updateRecUI() {
            const freq = document.getElementById('recFrequency').value;
            const customDiv = document.getElementById('recCustomSettings');
            const weekDaysDiv = document.getElementById('recWeekDays');
            const unit = document.getElementById('recUnit').value;

            customDiv.style.display = freq === 'custom' ? 'block' : 'none';
            weekDaysDiv.style.display = (freq === 'weekly' || freq === 'custom') ? 'block' : 'none';
        }

        document.addEventListener('change', (e) => {
            if (e.target.id === 'recUnit') updateRecUI();
        });

        async function openRecurringModal() {
            document.getElementById('recurringModal').classList.add('show');
            renderActiveRecurringList();
        }

        function renderActiveRecurringList() {
            const list = document.getElementById('activeRecurringList');
            if (!list) return;
            list.innerHTML = '';

            if (recurringEventsDefinitions.length === 0) {
                list.innerHTML = '<div style="font-size:11px; color:#999; text-align:center; padding: 10px;">No hay eventos recurrentes activos</div>';
                return;
            }

            // Funci칩n interna para formatear fecha (evita el error de Timestamp)
            const fmtDate = (val) => {
                if (!val) return '';
                let d;
                if (typeof val === 'string') {
                    if (val.includes('-')) {
                        const [y, m, da] = val.split('-').map(Number);
                        d = new Date(y, m - 1, da);
                    } else {
                        d = new Date(val);
                    }
                } else if (val.seconds) {
                    d = new Date(val.seconds * 1000);
                } else if (val instanceof Date) {
                    d = val;
                } else {
                    return String(val);
                }

                if (isNaN(d.getTime())) return String(val);
                return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            };

            recurringEventsDefinitions.forEach(def => {
                const card = document.createElement('div');
                card.style.background = 'white';
                card.style.border = '1px solid #ddd';
                card.style.borderRadius = '4px';
                card.style.padding = '8px';
                card.style.fontSize = '12px';
                card.style.position = 'relative';
                card.style.marginBottom = '8px';
                card.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';

                const title = document.createElement('div');
                title.style.fontWeight = 'bold';
                title.style.color = 'var(--midnight-blue)';
                title.textContent = def.title || 'Sin t칤tulo';

                const subtitle = document.createElement('div');
                subtitle.style.color = '#777';
                subtitle.style.fontSize = '10px';
                subtitle.style.marginTop = '4px';
                const sDate = fmtDate(def.startDate || def.start);
                const eDate = fmtDate(def.endDate);
                const rangeStr = `${sDate} ${eDate ? '- ' + eDate : ''}`;
                subtitle.innerHTML = `游늰 ${rangeStr} | 낋 ${def.time || '--:--'}`;

                const actions = document.createElement('div');
                actions.style.position = 'absolute';
                actions.style.top = '5px';
                actions.style.right = '5px';
                actions.style.display = 'flex';
                actions.style.gap = '8px';

                const btnEdit = document.createElement('button');
                btnEdit.innerHTML = '九勇';
                btnEdit.style.background = 'none';
                btnEdit.style.border = 'none';
                btnEdit.style.cursor = 'pointer';
                btnEdit.style.fontSize = '14px';
                btnEdit.title = 'Editar';
                btnEdit.onclick = () => editRecurringEvent(def);

                const btnDel = document.createElement('button');
                btnDel.innerHTML = '游딈勇';
                btnDel.style.background = 'none';
                btnDel.style.border = 'none';
                btnDel.style.cursor = 'pointer';
                btnDel.style.fontSize = '14px';
                btnDel.title = 'Eliminar';
                btnDel.onclick = () => deleteRecurringEvent(def.id);

                actions.appendChild(btnEdit);
                actions.appendChild(btnDel);

                card.appendChild(title);
                card.appendChild(subtitle);
                card.appendChild(actions);
                list.appendChild(card);
            });
        }

        function editRecurringEvent(def) {
            editingRecurringId = def.id;

            // Funci칩n interna para formatear fecha (evita el error de Timestamp)
            const fmtDate = (val) => {
                if (!val) return '';
                if (typeof val === 'string') return val;
                if (val.seconds) {
                    const d = new Date(val.seconds * 1000);
                    return d.toISOString().split('T')[0];
                }
                return '';
            };

            document.getElementById('recTitle').value = def.title || '';
            document.getElementById('recDesc').value = def.description || '';
            document.getElementById('recStartDate').value = fmtDate(def.startDate || def.start);
            document.getElementById('recEndDate').value = fmtDate(def.endDate);
            document.getElementById('recTime').value = def.time || '';
            document.getElementById('recFrequency').value = def.frequency || 'daily';
            document.getElementById('recInterval').value = def.interval || '1';
            document.getElementById('recUnit').value = def.unit || 'day';

            // D칤as de la semana
            const days = def.daysOfWeek || [];
            const checkboxes = document.querySelectorAll('input[name="recDay"]');
            checkboxes.forEach(cb => {
                cb.checked = days.includes(parseInt(cb.value));
            });

            updateRecUI();

            // Cambiar bot칩n
            const btn = document.querySelector('#recurringModal .btn-accept');
            if (btn) btn.textContent = '游 Guardar Cambios';

            // Scroll al inicio del modal
            document.querySelector('#recurringModal .modal-body').scrollTop = 0;

            showToast('九勇 Editando: ' + def.title);
        }

        function cancelEditRecurring() {
            editingRecurringId = null;
            document.getElementById('recTitle').value = '';
            document.getElementById('recDesc').value = '';
            document.getElementById('recStartDate').value = '';
            document.getElementById('recEndDate').value = '';
            document.getElementById('recTime').value = '';
            document.getElementById('recFrequency').value = 'daily';
            document.getElementById('recInterval').value = '1';
            document.getElementById('recUnit').value = 'day';
            const checkboxes = document.querySelectorAll('input[name="recDay"]');
            checkboxes.forEach(cb => cb.checked = false);

            updateRecUI();
            const btn = document.querySelector('#recurringModal .btn-accept');
            if (btn) btn.textContent = '+ Crear Evento';
        }

        async function addRecurringEvent() {
            const title = document.getElementById('recTitle').value;
            const desc = document.getElementById('recDesc').value;
            const startDate = document.getElementById('recStartDate').value;
            const endDate = document.getElementById('recEndDate').value;
            const time = document.getElementById('recTime').value;
            const frequency = document.getElementById('recFrequency').value;
            const interval = document.getElementById('recInterval').value;
            const unit = document.getElementById('recUnit').value;

            const days = [];
            document.querySelectorAll('input[name="recDay"]:checked').forEach(cb => {
                days.push(parseInt(cb.value));
            });

            if (!title || !startDate) {
                showToast('仇 T칤tulo y fecha de inicio requeridos');
                return;
            }

            const data = {
                title,
                description: desc,
                startDate,
                endDate,
                time,
                frequency,
                interval,
                unit,
                daysOfWeek: days,
                userId: getCurrentUserId() || '1'
            };

            try {
                if (editingRecurringId) {
                    if (isFirebaseConfigured && db && !editingRecurringId.startsWith('local_')) {
                        await db.collection('recurring_events').doc(editingRecurringId).update(data);
                    } else {
                        const idx = recurringEventsDefinitions.findIndex(d => d.id === editingRecurringId);
                        if (idx !== -1) {
                            recurringEventsDefinitions[idx] = { ...recurringEventsDefinitions[idx], ...data };
                            localStorage.setItem('local_recurring_events', JSON.stringify(recurringEventsDefinitions));
                        }
                    }
                    showToast('九 Cambios guardados');
                } else {
                    if (isFirebaseConfigured && db) {
                        await db.collection('recurring_events').add(data);
                    } else {
                        const id = 'local_' + Date.now();
                        recurringEventsDefinitions.push({ id, ...data });
                        localStorage.setItem('local_recurring_events', JSON.stringify(recurringEventsDefinitions));
                    }
                    showToast('游닆 Evento recurrente creado');
                }

                cancelEditRecurring();
                renderCalendar();
                renderActiveRecurringList();
            } catch (e) {
                console.error(e);
                showToast('仇 Error al guardar');
            }
        }

        async function deleteRecurringEvent(id) {
            if (!confirm('쮻ese치is eliminar este evento recurrente?')) return;

            try {
                if (isFirebaseConfigured && db && !id.startsWith('local_')) {
                    await db.collection('recurring_events').doc(id).delete();
                } else {
                    recurringEventsDefinitions = recurringEventsDefinitions.filter(d => d.id !== id);
                    localStorage.setItem('local_recurring_events', JSON.stringify(recurringEventsDefinitions));
                    renderCalendar();
                    renderActiveRecurringList();
                }
                showToast('游딈勇 Evento eliminado');
            } catch (e) {
                showToast('仇 Error al eliminar');
            }
        }

        async function getEventsForDate(date) {
            try {
                const dateKey = formatDateKey(date);
                let rawEvents = [];

                // 1. Intentar Cach칠 (incluyendo arreglos vac칤os para evitar re-hits)
                if (eventsCache[dateKey] !== undefined) {
                    rawEvents = eventsCache[dateKey];
                } else if (useLocalStorage || !isFirebaseConfigured) {
                    // 2. Modo demo / Local
                    try {
                        const stored = localStorage.getItem('medieval_calendar_events');
                        const allEvents = stored ? JSON.parse(stored) : {};
                        rawEvents = allEvents[dateKey] || [];
                    } catch (e) { }
                } else {
                    // 3. Firebase Directo (si no hay en cach칠 a칰n)
                    try {
                        const doc = await db.collection('calendar_events').doc(dateKey).get();
                        if (doc.exists) {
                            rawEvents = doc.data().events || [];
                            eventsCache[dateKey] = rawEvents;
                        }
                    } catch (e) {
                        console.error('Error cargando eventos:', e);
                    }
                }

                // Normalizaci칩n de datos existentes
                let finalEvents = rawEvents.map(e => {
                    const normalized = { ...e };
                    if (!normalized.type) {
                        if (normalized.shiftId || normalized.startTime || normalized.userColor) normalized.type = 'shift';
                        else if (normalized.text) normalized.type = 'note';
                    }
                    if (normalized.type === 'shift' && !normalized.backgroundColor) {
                        normalized.backgroundColor = normalized.userColor || normalized.colorHex || normalized.color || '#9E9E9E';
                    }
                    return normalized;
                });

                // INYECTAR RECURRENTES AL VUELO (Virtuales)
                if (recurringEventsDefinitions && recurringEventsDefinitions.length > 0) {
                    recurringEventsDefinitions.forEach(def => {
                        if (matchesRecurring(def, date)) {
                            // Evitar duplicados si ya se guard칩 como flat event
                            const exists = finalEvents.some(e => e.recurringId === def.id || e.text === def.title);
                            if (!exists) {
                                // Si el t칤tulo coincide con un turno (p.ej. "Vag", "Pino"), lo tratamos como turno para estad칤sticas
                                const lowerTitle = (def.title || '').toLowerCase();
                                const isLikeShift = shiftTemplates.some(t =>
                                    (t.name || '').toLowerCase() === lowerTitle ||
                                    (t.abbreviation || '').toLowerCase() === lowerTitle
                                );

                                finalEvents.push({
                                    type: isLikeShift ? 'shift' : 'note',
                                    text: def.title,
                                    description: def.description || '',
                                    time: def.time || '',
                                    isRecurring: true,
                                    recurringId: def.id,
                                    category: def.category || (isLikeShift ? 'Turno Recurrente' : 'Recurrente'),
                                    userId: def.userId,
                                    backgroundColor: isLikeShift ? (shiftTemplates.find(t => (t.name || '').toLowerCase() === lowerTitle || (t.abbreviation || '').toLowerCase() === lowerTitle)?.backgroundColor || '#9E9E9E') : null
                                });
                            }
                        }
                    });
                }

                return finalEvents || [];
            } catch (error) {
                console.error('Error en getEventsForDate:', error);
                return [];
            }
        }


        async function saveEvents(date, events) {
            const dateKey = formatDateKey(date);

            // Actualizar cach칠 local inmediatamente para consistencia t치ctica
            eventsCache[dateKey] = events;

            // Modo demo: usar localStorage
            if (useLocalStorage || !isFirebaseConfigured) {
                try {
                    const stored = localStorage.getItem('medieval_calendar_events');
                    const allEvents = stored ? JSON.parse(stored) : {};
                    allEvents[dateKey] = events;
                    localStorage.setItem('medieval_calendar_events', JSON.stringify(allEvents));
                    showToast('游닆 Nota guardada en el pergamino local');
                    return;
                } catch (error) {
                    console.error('Error guardando en localStorage:', error);
                    showMessage('Error', 'No se pudo guardar la nota.');
                    return;
                }
            }

            // Modo Firebase
            try {
                await db.collection('calendar_events').doc(dateKey).set({
                    events: events,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                showToast('游닆 Cr칩nicas enviadas al reino (Firebase)');
            } catch (error) {
                console.error('Error guardando eventos:', error);
                // Fallback a localStorage si Firebase falla en combate
                try {
                    const stored = localStorage.getItem('medieval_calendar_events');
                    const allEvents = stored ? JSON.parse(stored) : {};
                    allEvents[dateKey] = events;
                    localStorage.setItem('medieval_calendar_events', JSON.stringify(allEvents));
                    showToast('游닆 Guardado en modo local (Firebase fall칩)');
                } catch (e) {
                    showMessage('Error', 'No se pudieron guardar los eventos.');
                }
            }
        }

        // ============================================
        // SINCRONIZACI칍N EN TIEMPO REAL
        // ============================================
        function setupRealtimeListener() {
            if (!isFirebaseConfigured || !db) return;

            // Listener para cronicas de eventos
            db.collection('calendar_events').onSnapshot((snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const dateKey = change.doc.id;
                    const data = change.doc.data();
                    if (change.type === 'removed') {
                        delete eventsCache[dateKey];
                    } else {
                        eventsCache[dateKey] = data?.events || [];
                    }
                });
                renderCalendar();
            }, (error) => console.error('Error en listener de cr칩nicas:', error));

            // Listener para perfiles de usuarios
            db.collection('users').onSnapshot((snapshot) => {
                const refreshedUsers = snapshot.docs.map(doc => ({
                    id: String(doc.id),
                    ...doc.data()
                }));
                localStorage.setItem(USER_KEY, JSON.stringify(refreshedUsers));
                populateFilters();
                renderCalendar();
            });

            // Listener para plantillas de turnos
            db.collection('shifts').onSnapshot((snapshot) => {
                shiftTemplates = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })).sort((a, b) => (a.order || 0) - (b.order || 0));
                localStorage.setItem('shift_templates', JSON.stringify(shiftTemplates));
                renderShiftsForPainting();
                renderCalendar();
            });

            // Listener para recurrentes
            db.collection('recurring_events').onSnapshot((snapshot) => {
                recurringEventsDefinitions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCalendar();
                // Refrescar lista si el modal est치 abierto
                if (document.getElementById('recurringModal').classList.contains('show')) {
                    renderActiveRecurringList();
                }
            });
        }

        // ============================================
        // FUNCIONES DE MODAL Y VISTAS
        // ============================================
        function showModalDashboard() {
            document.getElementById('modalDashboardView').style.display = 'flex';
            document.getElementById('modalEditorView').style.display = 'none';
            document.getElementById('dashboardFooter').style.display = 'grid';
        }

        function showModalEditor() {
            document.getElementById('modalDashboardView').style.display = 'none';
            document.getElementById('modalEditorView').style.display = 'flex';
            document.getElementById('dashboardFooter').style.display = 'none';
        }

        async function openDayModal(date) {
            selectedDate = date;
            document.getElementById('modalDate').textContent = formatDate(date);

            const events = await getEventsForDate(date);

            // ASEGURAR IDs 칔NICOS
            let modified = false;
            events.forEach(e => {
                if (e.type === 'note' && !e.id) {
                    e.id = 'note_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    modified = true;
                }
            });
            if (modified) await saveEvents(date, events);

            const notes = events.filter(e => e.type === 'note');
            const shifts = events.filter(e => e.type === 'shift');

            // Renderizar Cr칩nicas en el Dashboard
            const dashboardNotes = document.getElementById('dashboardNotesList');
            dashboardNotes.innerHTML = '';
            if (notes.length === 0) {
                dashboardNotes.innerHTML = '<div style="text-align:center; color: var(--sepia); font-size: 11px; padding: 10px;">No hay cr칩nicas registradas.</div>';
            } else {
                notes.forEach(n => {
                    const item = document.createElement('div');
                    item.className = 'medieval-section';
                    item.style.padding = '8px 12px';
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    item.style.alignItems = 'center';
                    item.style.background = 'white';
                    item.style.border = '1px solid rgba(0,0,0,0.1)';
                    item.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';

                    const left = document.createElement('div');
                    left.style.display = 'flex';
                    left.style.alignItems = 'center';
                    left.style.gap = '10px';
                    left.style.overflow = 'hidden';

                    const icon = document.createElement('span');
                    icon.textContent = '游닆';
                    icon.style.opacity = '0.6';

                    const content = document.createElement('div');
                    content.style.display = 'flex';
                    content.style.flexDirection = 'column';
                    content.style.overflow = 'hidden';

                    const title = document.createElement('span');
                    title.style.fontFamily = 'Cinzel';
                    title.style.fontSize = '15px';
                    title.style.fontWeight = '700';
                    title.style.whiteSpace = 'nowrap';
                    title.style.overflow = 'hidden';
                    title.style.textOverflow = 'ellipsis';
                    title.textContent = n.text.replace(/<[^>]*>/g, '').trim() || 'Sin texto';

                    const meta = document.createElement('span');
                    meta.style.fontSize = '14px';
                    meta.style.color = 'var(--sepia)';
                    meta.style.marginTop = '2px';
                    meta.textContent = n.time ? `游뎷 ${n.time}` : 'Sin hora';
                    if (n.category) meta.textContent += `  ${n.category}`;

                    content.appendChild(title);
                    content.appendChild(meta);
                    left.appendChild(icon);
                    left.appendChild(content);

                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '游둚勇';
                    editBtn.style.background = 'none';
                    editBtn.style.border = 'none';
                    editBtn.style.cursor = 'pointer';
                    editBtn.style.fontSize = '14px';
                    editBtn.onclick = () => {
                        loadNoteIntoEditor(n);
                        showModalEditor();
                    };

                    item.appendChild(left);
                    item.appendChild(editBtn);
                    dashboardNotes.appendChild(item);
                });
            }

            // Renderizar Secci칩n de Alarma (Recordatorios, Citas o marcados Manualmente)
            const alarms = notes.filter(n => n.category === 'Recordatorio' || n.category === 'Cita' || n.isAlarm);
            const alarmCounter = document.getElementById('alarmCounter');
            const dashboardAlarms = document.getElementById('dashboardAlarmsList');

            alarmCounter.textContent = alarms.length;
            dashboardAlarms.innerHTML = '';

            if (alarms.length > 0) {
                alarms.forEach(a => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.alignItems = 'center';
                    row.style.gap = '8px';
                    row.style.padding = '8px';
                    row.style.background = 'white';
                    row.style.borderRadius = '4px';
                    row.style.border = '1px solid rgba(139,38,53,0.1)';
                    row.style.marginBottom = '4px';

                    const timeInfo = a.time ? `<span style="font-size: 11px; font-weight: bold; color: var(--cinnabar);">[${a.time}]</span>` : '';
                    const plainText = a.text.replace(/<[^>]*>/g, '').trim();

                    row.innerHTML = `
                        <span style="font-size: 12px;">낋</span>
                        <span style="font-size: 13px; font-family: 'Almendra'; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${timeInfo} ${plainText}
                        </span>
                    `;
                    dashboardAlarms.appendChild(row);
                });
            } else {
                dashboardAlarms.innerHTML = '<div style="font-size: 11px; text-align: center; opacity: 0.5; padding: 5px;">No hay alarmas activas</div>';
            }

            // Renderizar Turnos en el Dashboard
            const dashboardShifts = document.getElementById('dashboardShiftsList');
            dashboardShifts.innerHTML = '';
            if (shifts.length === 0) {
                dashboardShifts.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px; opacity: 0.5;">
                <div style="width:40px; height:40px; border-radius:50%; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 20px;">游</div>
                <div style="font-size: 11px;">No hay turnos asignados</div>
            </div>
        `;
            } else {
                shifts.forEach(s => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.justifyContent = 'space-between';
                    row.style.padding = '6px 10px';
                    row.style.border = '1px solid rgba(212,175,55,0.3)';
                    row.style.borderRadius = '6px';
                    row.style.alignItems = 'center';
                    row.style.background = 'rgba(212,175,55,0.05)';

                    row.innerHTML = `
                <div style="display:flex; align-items:center; gap: 8px;">
                    <div style="width:10px; height:10px; border-radius:50%; background:${s.backgroundColor || '#9E9E9E'};"></div>
                    <span style="font-family:'Cinzel', serif; font-weight:bold; font-size: 12px;">${s.text}</span>
                </div>
            `;
                    dashboardShifts.appendChild(row);
                });
            }

            // Preparar el editor (por si acaso se abre)
            const myId = getCurrentUserId();
            const note = notes.find(e => String(e.authorId) === String(myId)) || notes[0];
            if (note) {
                loadNoteIntoEditor(note);
            } else {
                resetEditorFields();
            }

            showModalDashboard();
            document.getElementById('dayModal').classList.add('show');
        }

        function loadNoteIntoEditor(note) {
            currentEditingNoteId = note.id || null;
            document.getElementById('medievalEditor').innerHTML = note.text || '';
            document.getElementById('editorTime').value = note.time || '';
            document.getElementById('editorCategory').value = note.category || '';

            const alarmCheck = document.getElementById('editorAlarm');
            if (alarmCheck) {
                alarmCheck.checked = note.isAlarm || false;
                updateAlarmIcon(note.isAlarm);
            }

            document.getElementById('cellSizeSlider').value = note.fontSize || 11;
            document.getElementById('cellSizeValue').textContent = note.fontSize || 11;
            const fontSelect = document.getElementById('editorFontFamily');
            if (fontSelect) fontSelect.value = note.fontFamily || "'Almendra', serif";

            // Renderizar Visibilidad (Solo en el editor)
            renderVisibilityList(note);
        }

        function resetEditorFields() {
            currentEditingNoteId = null;
            document.getElementById('medievalEditor').innerHTML = '';
            document.getElementById('editorTime').value = '';
            document.getElementById('editorCategory').value = '';
            const alarmCheck = document.getElementById('editorAlarm');
            if (alarmCheck) {
                alarmCheck.checked = false;
                updateAlarmIcon(false);
            }
            document.getElementById('cellSizeSlider').value = 11;
            document.getElementById('cellSizeValue').textContent = 11;
            if (document.getElementById('editorFontFamily')) {
                document.getElementById('editorFontFamily').value = "'Almendra', serif";
            }
            renderVisibilityList(null);
        }

        function renderVisibilityList(note) {
            const visList = document.getElementById('visibilityList');
            visList.innerHTML = '';
            const users = getUsers();
            users.forEach(u => {
                const item = document.createElement('div');
                item.className = 'visibility-item';
                const isChecked = !note || (note.sharedWith && note.sharedWith.includes(u.id));
                const isSelf = String(u.id) === String(getCurrentUserId());

                item.innerHTML = `
            <input type="checkbox" class="visibility-checkbox" ${isChecked || isSelf ? 'checked' : ''} ${isSelf ? 'disabled' : ''} data-user-id="${u.id}">
            <div class="user-dot" style="background:${u.color}"></div>
            <span style="font-size: 0.85em;">${u.name}</span>
        `;
                visList.appendChild(item);
            });
        }

        // Funci칩n centralizada para preparar nueva cr칩nica
        function prepareNewNote() {
            resetEditorFields();
            showModalEditor();

            // Aseguramos el foco en el editor
            const editor = document.getElementById('medievalEditor');
            if (editor) {
                editor.focus();
            }

            showToast('游둚勇 Nueva cr칩nica iniciada');
        }

        function execCmd(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('medievalEditor').focus();
            updateFormatButtonsState();
        }

        function updateFormatButtonsState() {
            const b = document.getElementById('boldBtn');
            const i = document.getElementById('italicBtn');
            const u = document.getElementById('underlineBtn');
            if (!b || !i || !u) return;

            document.queryCommandState('bold') ? b.classList.add('active') : b.classList.remove('active');
            document.queryCommandState('italic') ? i.classList.add('active') : i.classList.remove('active');
            document.queryCommandState('underline') ? u.classList.add('active') : u.classList.remove('active');
        }

        // Listener para actualizar botones al hacer clic o escribir en el editor
        document.addEventListener('selectionchange', () => {
            const activeEl = document.activeElement;
            if (activeEl && activeEl.id === 'medievalEditor') {
                updateFormatButtonsState();
            }
        });

        function updateCellSize(val) {
            document.getElementById('cellSizeValue').textContent = val;
        }

        // Listener para el icono de alarma en el editor
        document.addEventListener('change', (e) => {
            if (e.target.id === 'editorAlarm') {
                updateAlarmIcon(e.target.checked);
            }
        });

        function updateAlarmIcon(active) {
            const icon = document.getElementById('alarmIcon');
            if (icon) {
                icon.style.opacity = active ? '1' : '0.3';
                icon.style.filter = active ? 'drop-shadow(0 0 5px var(--cinnabar))' : 'none';
            }
        }

        let currentEditingNoteId = null; // Variable global para rastrear qu칠 nota estamos editando

        async function saveDayNote() {
            if (!selectedDate) return;
            const editor = document.getElementById('medievalEditor');
            const text = editor.innerHTML.trim();
            if (!text) {
                showToast('丘멆잺 La cr칩nica est치 vac칤a');
                return;
            }
            const time = document.getElementById('editorTime').value;
            const category = document.getElementById('editorCategory').value;
            const isAlarm = document.getElementById('editorAlarm').checked;
            const fontSize = parseInt(document.getElementById('cellSizeSlider').value);
            const fontFamily = document.getElementById('editorFontFamily').value;

            const sharedWith = [];
            document.querySelectorAll('#visibilityList input:checked').forEach(cb => {
                sharedWith.push(cb.getAttribute('data-user-id'));
            });

            const events = await getEventsForDate(selectedDate);
            pushUndoSnapshot(selectedDate, events);

            const myId = getCurrentUserId();

            // Si tenemos un ID estamos editando una nota espec칤fica, si no, es nueva
            let noteIdx = -1;
            if (currentEditingNoteId) {
                noteIdx = events.findIndex(e => e.id === currentEditingNoteId);
            } else {
                // Fallback: si no hay ID pero el autor ya tiene una nota y no puls칩 "Nueva", editamos la suya
                noteIdx = events.findIndex(e => e.type === 'note' && String(e.authorId) === String(myId));
            }

            const noteData = {
                type: 'note',
                text: text,
                time: time,
                category: category,
                isAlarm: isAlarm,
                fontSize: fontSize,
                fontFamily: fontFamily,
                sharedWith: sharedWith,
                authorId: myId || null,
                updatedAt: new Date().toISOString()
            };

            if (noteIdx !== -1) {
                events[noteIdx] = { ...events[noteIdx], ...noteData };
            } else {
                noteData.id = 'note_' + Date.now(); // Generamos un ID 칰nico para la nueva nota
                noteData.createdAt = new Date().toISOString();
                events.push(noteData);
            }

            await saveEvents(selectedDate, events);
            closeModal();
            renderCalendar();
            showToast('游닆 Cr칩nica guardada');
        }

        async function deleteDayNote() {
            if (!selectedDate || !currentEditingNoteId) {
                showToast('丘멆잺 No hay una cr칩nica seleccionada para borrar');
                return;
            }
            const events = await getEventsForDate(selectedDate);
            pushUndoSnapshot(selectedDate, events);

            // Filtrar SOLO la nota con el ID actual
            const filtered = events.filter(e => e.id !== currentEditingNoteId);

            await saveEvents(selectedDate, filtered);
            closeModal();
            renderCalendar();
            showToast('游딈勇 Cr칩nica eliminada');
        }

        async function addShiftToSelectedDay() {
            if (!selectedDate) return;
            const sel = document.getElementById('dayShiftSelect');
            const val = sel?.value;
            const tpl = shiftTemplates.find(t => (t.id || t.name) === val);
            if (!tpl) { showToast('丘멆잺 Selecciona un turno'); return; }
            const events = await getEventsForDate(selectedDate);
            pushUndoSnapshot(selectedDate, events);
            events.push({
                type: 'shift',
                text: tpl.name || tpl.abbreviation || 'Turno',
                shiftId: tpl.id || tpl.name,
                startTime: tpl.startTime || '',
                endTime: tpl.endTime || '',
                backgroundColor: tpl.backgroundColor || tpl.colorHex || tpl.color || '#9E9E9E',
                userId: getCurrentUserId() || null,
                createdAt: new Date().toISOString()
            });
            await saveEvents(selectedDate, events);
            await openDayModal(selectedDate);
            renderCalendar();
            showToast('九 Turno agregado');
        }

        let currentShiftEdit = null;
        function editShiftEvent(date, shift) {
            currentShiftEdit = { date, shift };
            document.getElementById('shiftEditName').value = shift.text || '';
            document.getElementById('shiftEditColor').value = shift.backgroundColor || '#9E9E9E';
            document.getElementById('shiftEditStart').value = shift.startTime || '';
            document.getElementById('shiftEditEnd').value = shift.endTime || '';
            document.getElementById('shiftEditModal').classList.add('show');
        }
        function closeShiftEditModal() {
            document.getElementById('shiftEditModal').classList.remove('show');
            currentShiftEdit = null;
        }
        function findShiftIndex(events, fingerprint) {
            let idx = -1;
            if (fingerprint.createdAt) {
                idx = events.findIndex(e => e.type === 'shift' && e.createdAt === fingerprint.createdAt);
                if (idx !== -1) return idx;
            }
            idx = events.findIndex(e => e.type === 'shift' &&
                (e.text || '') === (fingerprint.text || '') &&
                (e.startTime || '') === (fingerprint.startTime || '') &&
                (e.endTime || '') === (fingerprint.endTime || '') &&
                (e.backgroundColor || '') === (fingerprint.backgroundColor || '')
            );
            return idx;
        }
        async function saveShiftEdit() {
            if (!currentShiftEdit) return;
            const name = document.getElementById('shiftEditName').value.trim();
            const color = document.getElementById('shiftEditColor').value;
            const start = document.getElementById('shiftEditStart').value;
            const end = document.getElementById('shiftEditEnd').value;
            const events = await getEventsForDate(currentShiftEdit.date);
            pushUndoSnapshot(currentShiftEdit.date, events);
            const fp = {
                text: currentShiftEdit.shift.text || '',
                startTime: currentShiftEdit.shift.startTime || '',
                endTime: currentShiftEdit.shift.endTime || '',
                backgroundColor: currentShiftEdit.shift.backgroundColor || '',
                createdAt: currentShiftEdit.shift.createdAt
            };
            const idx = findShiftIndex(events, fp);
            if (idx === -1) { closeShiftEditModal(); return; }
            events[idx] = {
                ...events[idx],
                type: 'shift',
                text: name || 'Turno',
                startTime: start || '',
                endTime: end || '',
                backgroundColor: color || events[idx].backgroundColor,
                updatedAt: new Date().toISOString()
            };
            await saveEvents(currentShiftEdit.date, events);
            closeShiftEditModal();
            await openDayModal(currentShiftEdit.date);
            renderCalendar();
        }
        async function deleteShiftEvent(date, shift) {
            const events = await getEventsForDate(date);
            pushUndoSnapshot(date, events);
            const fp = {
                text: shift.text || '',
                startTime: shift.startTime || '',
                endTime: shift.endTime || '',
                backgroundColor: shift.backgroundColor || '',
                createdAt: shift.createdAt
            };
            const idx = findShiftIndex(events, fp);
            if (idx === -1) return;
            events.splice(idx, 1);
            await saveEvents(date, events);
            await openDayModal(date);
            renderCalendar();
            showToast('游딈勇 Turno eliminado');
        }
        let shiftDupSource = null;
        let shiftDupSourceDate = null;
        function openShiftDuplicate(date, shift) {
            shiftDupSource = shift;
            shiftDupSourceDate = date;
            const input = document.getElementById('shiftDupDate');
            if (input) {
                const next = new Date(date);
                next.setDate(next.getDate() + 1);
                input.value = next.toISOString().slice(0, 10);
            }
            const status = document.getElementById('shiftDupStatus');
            if (status) status.textContent = '';
            const modeSel = document.getElementById('shiftDupMode');
            if (modeSel) { modeSel.value = 'single'; }
            const avoid = document.getElementById('shiftDupAvoidDup');
            if (avoid) avoid.checked = true;
            updateShiftDupModeUI();
            document.getElementById('shiftDuplicateModal').style.display = 'block';
        }
        function closeShiftDuplicateModal() {
            document.getElementById('shiftDuplicateModal').style.display = 'none';
            shiftDupSource = null;
            shiftDupSourceDate = null;
        }
        async function performShiftDuplicate() {
            const input = document.getElementById('shiftDupDate');
            const modeSel = document.getElementById('shiftDupMode');
            if (!shiftDupSource || !input || !input.value || !modeSel) return;
            const parts = input.value.split('-');
            const start = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            const mode = modeSel.value || 'single';
            const avoidDup = !!document.getElementById('shiftDupAvoidDup')?.checked;
            let targets = [];
            if (mode === 'single') {
                targets = [start];
            } else if (mode === 'daily_count') {
                const n = Math.max(1, parseInt(document.getElementById('shiftDupCountDays')?.value || '1', 10));
                for (let i = 0; i < n; i++) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + i);
                    targets.push(d);
                }
            } else if (mode === 'every_x_repeats') {
                const interval = Math.max(1, parseInt(document.getElementById('shiftDupIntervalDays')?.value || '1', 10));
                const reps = Math.max(1, parseInt(document.getElementById('shiftDupRepeats')?.value || '1', 10));
                for (let k = 0; k < reps; k++) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + k * interval);
                    targets.push(d);
                }
            } else if (mode === 'weekly_until') {
                const endInput = document.getElementById('shiftDupEndDate');
                if (!endInput || !endInput.value) return;
                const p2 = endInput.value.split('-');
                const end = new Date(Number(p2[0]), Number(p2[1]) - 1, Number(p2[2]));
                const selected = [];
                for (let wd = 0; wd <= 6; wd++) {
                    const el = document.getElementById('wd' + wd);
                    if (el && el.checked) selected.push(wd);
                }
                if (selected.length === 0) return;
                const d = new Date(start);
                while (d <= end) {
                    if (selected.includes(d.getDay())) {
                        targets.push(new Date(d));
                    }
                    d.setDate(d.getDate() + 1);
                }
            }
            let count = 0;
            const prevMap = {};
            for (const target of targets) {
                const key = getDateKeyStr(target);
                const prev = await getEventsForDate(target);
                prevMap[key] = prev;
            }
            pushUndoSnapshots(prevMap);
            for (const target of targets) {
                const events = await getEventsForDate(target);
                if (avoidDup) {
                    const fp = {
                        text: shiftDupSource.text || '',
                        startTime: shiftDupSource.startTime || '',
                        endTime: shiftDupSource.endTime || '',
                        backgroundColor: shiftDupSource.backgroundColor || ''
                    };
                    const existsIdx = findShiftIndex(events, fp);
                    if (existsIdx !== -1) continue;
                }
                events.push({
                    type: 'shift',
                    text: shiftDupSource.text || 'Turno',
                    shiftId: shiftDupSource.shiftId || '',
                    startTime: shiftDupSource.startTime || '',
                    endTime: shiftDupSource.endTime || '',
                    backgroundColor: shiftDupSource.backgroundColor || '#9E9E9E',
                    createdAt: new Date().toISOString()
                });
                await saveEvents(target, events);
                count++;
            }
            const status = document.getElementById('shiftDupStatus');
            if (status) status.textContent = `九 Duplicado en ${count} d칤a(s)`;
            renderCalendar();
        }
        function updateShiftDupModeUI() {
            const modeSel = document.getElementById('shiftDupMode');
            const m = modeSel ? modeSel.value : 'single';
            const daily = document.getElementById('dupDailyCount');
            const everyx = document.getElementById('dupEveryX');
            const weekly = document.getElementById('dupWeekly');
            if (daily) daily.style.display = (m === 'daily_count') ? 'block' : 'none';
            if (everyx) everyx.style.display = (m === 'every_x_repeats') ? 'block' : 'none';
            if (weekly) weekly.style.display = (m === 'weekly_until') ? 'block' : 'none';
        }
        async function moveShiftEvent(date, shift, dir) {
            const events = await getEventsForDate(date);
            pushUndoSnapshot(date, events);
            const fp = {
                text: shift.text || '',
                startTime: shift.startTime || '',
                endTime: shift.endTime || '',
                backgroundColor: shift.backgroundColor || '',
                createdAt: shift.createdAt
            };
            const idx = findShiftIndex(events, fp);
            if (idx === -1) return;
            const shiftEventsIdxs = events.map((e, i) => e.type === 'shift' ? i : -1).filter(i => i !== -1);
            const posInShifts = shiftEventsIdxs.indexOf(idx);
            const targetPos = posInShifts + dir;
            if (targetPos < 0 || targetPos >= shiftEventsIdxs.length) return;
            const targetIdx = shiftEventsIdxs[targetPos];
            const tmp = events[idx];
            events[idx] = events[targetIdx];
            events[targetIdx] = tmp;
            await saveEvents(date, events);
            await openDayModal(date);
            renderCalendar();
        }
        function findNoteIndex(events, fingerprint) {
            let idx = -1;
            if (fingerprint.createdAt) {
                idx = events.findIndex(e => e.type === 'note' && e.createdAt === fingerprint.createdAt);
                if (idx !== -1) return idx;
            }
            idx = events.findIndex(e => e.type === 'note' &&
                (e.text || '') === (fingerprint.text || '') &&
                (e.time || '') === (fingerprint.time || '') &&
                (e.category || '') === (fingerprint.category || '')
            );
            return idx;
        }
        async function saveWeeklyNoteEdit(date, note, newText) {
            const events = await getEventsForDate(date);
            const fp = {
                text: note.text || '',
                time: note.time || '',
                category: note.category || '',
                createdAt: note.createdAt
            };
            const idx = findNoteIndex(events, fp);
            if (idx === -1) return;
            events[idx] = {
                ...events[idx],
                text: newText || events[idx].text,
                updatedAt: new Date().toISOString()
            };
            await saveEvents(date, events);
            await renderWeeklyAgenda(getWeekStart(date));
            showToast('九 Nota actualizada');
        }

        function closeModal() {
            document.getElementById('dayModal').classList.remove('show');
            selectedDate = null;
        }

        function openNotesModal(note = null, index = null) {
            currentNote = { note, index };
            document.getElementById('notesTextarea').value = note?.text || '';
            document.getElementById('notesTimeInput').value = note?.time || '';
            document.getElementById('notesCategorySelect').value = note?.category || '';
            document.getElementById('notesModal').classList.add('show');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentNote = null;
            document.getElementById('notesTextarea').value = '';
            document.getElementById('notesTimeInput').value = '';
            document.getElementById('notesCategorySelect').value = '';
        }

        function editNote(note, index) {
            openNotesModal(note, index);
        }

        async function saveNote() {
            if (!selectedDate) return;

            const text = document.getElementById('notesTextarea').value.trim();
            if (!text) {
                showMessage('Atenci칩n', 'Por favor, escribe algo en la nota.');
                return;
            }

            const time = document.getElementById('notesTimeInput').value;
            const category = document.getElementById('notesCategorySelect').value;

            const events = await getEventsForDate(selectedDate);

            if (currentNote && currentNote.index !== null) {
                // Editar nota existente
                events[currentNote.index] = {
                    type: 'note',
                    text: text,
                    time: time,
                    category: category,
                    authorId: events[currentNote.index].authorId || getCurrentUserId() || null,
                    createdAt: events[currentNote.index].createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
            } else {
                // Nueva nota
                events.push({
                    type: 'note',
                    text: text,
                    time: time,
                    category: category,
                    authorId: getCurrentUserId() || null,
                    createdAt: new Date().toISOString()
                });
            }

            await saveEvents(selectedDate, events);
            closeNotesModal();
            await openDayModal(selectedDate);
            renderCalendar();
            if (currentView === 'year') renderYear();
        }

        // ============================================
        // FUNCIONES DE MENSAJES
        // ============================================
        function showMessage(title, text) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageText').textContent = text;
            document.getElementById('messageContainer').classList.add('show');
        }

        function closeMessage() {
            document.getElementById('messageContainer').classList.remove('show');
        }

        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // FUNCIONES ADICIONALES
        // ============================================
        // Variables globales para modo pintar
        let selectedShiftForPainting = null;
        let isDeleteMode = false;
        let shiftTemplates = [];
        let isEditMode = false;

        // Activar modo pintar
        function activatePaintMode() {
            console.log('游꿛 Activando modo pintar...');
            openShiftsPopup();
        }

        // Abrir pop-up de turnos
        async function openShiftsPopup() {
            const popup = document.getElementById('shiftsPopup');
            if (!popup) {
                console.error('仇 No se encontr칩 el elemento shiftsPopup');
                return;
            }
            popup.classList.add('show');
            await renderShiftsForPainting();
        }

        // Cerrar pop-up de turnos
        function closeShiftsPopup() {
            const popup = document.getElementById('shiftsPopup');
            if (popup) {
                popup.classList.remove('show');
            }
            exitPaintMode();
        }

        // Renderizar turnos en el pop-up
        async function renderShiftsForPainting() {
            const container = document.getElementById('shiftsScroll');
            if (!container) return;
            container.innerHTML = '';

            // Cargar turnos desde localStorage o Firebase
            await loadShiftTemplates();

            if (shiftTemplates.length === 0) {
                container.innerHTML = '<div style="padding: 16px; color: var(--sepia); text-align: center; width: 100%; font-family: Almendra, serif;">No hay turnos disponibles<br/>Crea turnos en la secci칩n "TURNOS"</div>';
                return;
            }

            // Renderizar cada turno
            shiftTemplates.forEach((shift, index) => {
                const button = document.createElement('button');
                button.className = 'shift-button-paint';
                button.draggable = true;
                button.dataset.index = index;

                const backgroundColor = shift.backgroundColor || shift.colorHex || shift.color || '#9E9E9E';
                button.style.backgroundColor = backgroundColor;
                button.style.borderColor = '#D4AF37';
                const contrastColor = getContrastColor(backgroundColor);
                button.style.color = contrastColor;

                const displayText = shift.abbreviation || shift.name || 'Turno';
                button.textContent = displayText;

                // Evento click para pintar con este turno
                button.onclick = () => selectShiftForPainting(shift);

                // Drag and drop
                button.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', index);
                    button.classList.add('dragging');
                });

                button.addEventListener('dragend', () => {
                    button.classList.remove('dragging');
                });

                button.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                button.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const targetIndex = parseInt(button.dataset.index);
                    if (draggedIndex !== targetIndex) {
                        // Reordenar
                        const dragged = shiftTemplates[draggedIndex];
                        shiftTemplates.splice(draggedIndex, 1);
                        shiftTemplates.splice(targetIndex, 0, dragged);
                        saveShiftTemplates();
                        renderShiftsForPainting();
                    }
                });

                container.appendChild(button);
            });

            // A침adir bot칩n de borrar al final
            const deleteButton = document.createElement('button');
            deleteButton.className = 'shift-button-delete';
            deleteButton.innerHTML = '游딈勇 BORRAR';
            deleteButton.title = 'Borrar turnos del d칤a seleccionado';
            deleteButton.onclick = () => selectDeleteMode();
            container.appendChild(deleteButton);
        }

        async function loadShiftTemplates() {
            // Si hay Firebase, cargar desde ah칤 primero
            if (isFirebaseConfigured && db) {
                try {
                    const snapshot = await db.collection('shifts').orderBy('order').get();
                    if (!snapshot.empty) {
                        shiftTemplates = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        // Guardar en localStorage para pr칩xima vez
                        localStorage.setItem('shift_templates', JSON.stringify(shiftTemplates));
                        return; // Exitoso de Firebase
                    }
                } catch (error) {
                    console.error('Error cargando turnos de Firebase (shifts):', error);
                }
            }

            // Intentar cargar desde localStorage si Firebase fall칩 o no dio nada
            try {
                const stored = localStorage.getItem('shift_templates');
                if (stored) {
                    shiftTemplates = JSON.parse(stored);
                    return;
                }
            } catch (e) {
                console.error('Error cargando turnos de localStorage:', e);
            }
        }

        // Seleccionar turno para pintar
        function selectShiftForPainting(shift) {
            selectedShiftForPainting = shift;
            isDeleteMode = false;
            document.body.style.cursor = 'crosshair';
            showToast(`游꿛 Modo PINTAR: ${shift.name || shift.abbreviation}`);
            // Recargar calendario inmediatamente para que los clicks funcionen sin modal
            renderCalendar();
        }

        // Seleccionar modo borrar
        function selectDeleteMode() {
            selectedShiftForPainting = null;
            isDeleteMode = true;
            document.body.style.cursor = 'not-allowed';
            showToast('游딈勇 Modo ELIMINAR activo');
            renderCalendar();
        }

        // Salir del modo pintura
        function exitPaintMode() {
            document.body.style.cursor = 'default';
            selectedShiftForPainting = null;
            isDeleteMode = false;
            renderCalendar();
        }

        // Activar modo editar (renderizar calendario en modo edici칩n)
        function activateEditMode() {
            isEditMode = !isEditMode;
            if (isEditMode) {
                showToast('九勇 Modo Edici칩n activado');
            } else {
                showToast('游녜勇 Modo Visual activado');
            }
            renderCalendar();
        }

        // Mostrar p치gina de turnos
        function showShifts() {
            openShiftsManage();
        }

        function openShiftsManage() {
            document.getElementById('shiftsManageModal').classList.add('show');
            renderShiftTemplatesList();
        }
        function closeShiftsManage() {
            document.getElementById('shiftsManageModal').classList.remove('show');
        }
        function renderShiftTemplatesList() {
            const list = document.getElementById('shiftTemplatesList');
            list.innerHTML = '';
            if (shiftTemplates.length === 0) {
                list.innerHTML = '<div style="text-align:center; color: var(--sepia); padding: 20px;">Sin turnos configurados</div>';
                return;
            }
            shiftTemplates.forEach((t, i) => {
                const row = document.createElement('div');
                row.className = 'medieval-section';
                row.style.marginBottom = '12px';
                row.style.padding = '10px';

                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.marginBottom = '8px';

                const nameGroup = document.createElement('div');
                nameGroup.style.display = 'flex';
                nameGroup.style.alignItems = 'center';
                nameGroup.style.gap = '8px';

                const color = document.createElement('div');
                color.style.width = '18px';
                color.style.height = '18px';
                color.style.border = '1px solid var(--gold-leaf)';
                color.style.background = t.backgroundColor || t.colorHex || t.color || '#9E9E9E';

                const name = document.createElement('div');
                name.style.fontFamily = "Cinzel";
                name.style.fontWeight = "700";
                name.textContent = `${t.name || 'Turno'} (${t.abbreviation || '?'})`;

                nameGroup.appendChild(color);
                nameGroup.appendChild(name);
                header.appendChild(nameGroup);

                // Botones de Ordenaci칩n
                const orderGroup = document.createElement('div');
                orderGroup.style.display = 'flex';
                orderGroup.style.gap = '4px';

                if (i > 0) {
                    const up = document.createElement('button');
                    up.className = 'btn';
                    up.style.padding = '4px 8px';
                    up.innerHTML = '';
                    up.onclick = () => moveShiftTemplate(i, -1);
                    orderGroup.appendChild(up);
                }
                if (i < shiftTemplates.length - 1) {
                    const down = document.createElement('button');
                    down.className = 'btn';
                    down.style.padding = '4px 8px';
                    down.innerHTML = '';
                    down.onclick = () => moveShiftTemplate(i, 1);
                    orderGroup.appendChild(down);
                }
                header.appendChild(orderGroup);

                const actions = document.createElement('div');
                actions.style.display = 'flex';
                actions.style.gap = '8px';

                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn btn-accept';
                btnEdit.style.flex = '1';
                btnEdit.textContent = 'Editar';
                btnEdit.onclick = () => {
                    document.getElementById('shiftNameInput').value = t.name || '';
                    document.getElementById('shiftAbbrevInput').value = t.abbreviation || '';
                    document.getElementById('shiftColorInput').value = t.backgroundColor || t.colorHex || t.color || '#9E9E9E';
                    document.getElementById('shiftStartInput').value = t.startTime || '';
                    document.getElementById('shiftEndInput').value = t.endTime || '';
                    document.getElementById('shiftNameInput').dataset.index = i;

                    // Desplazar el contenido del modal hacia arriba para ver el formulario
                    const modalContent = document.getElementById('shiftsManageModal').querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.scrollTo({ top: 0, behavior: 'smooth' });
                    }

                    showToast(`九勇 Editando: ${t.name}`);
                };

                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-cancel';
                btnDelete.style.flex = '1';
                btnDelete.textContent = 'Borrar';
                btnDelete.onclick = () => deleteShiftTemplate(i);

                actions.appendChild(btnEdit);
                actions.appendChild(btnDelete);

                row.appendChild(header);
                row.appendChild(actions);
                list.appendChild(row);
            });
        }

        async function moveShiftTemplate(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= shiftTemplates.length) return;
            const temp = shiftTemplates[index];
            shiftTemplates[index] = shiftTemplates[newIndex];
            shiftTemplates[newIndex] = temp;
            await saveShiftTemplates();
            renderShiftTemplatesList();
            // Actualizar tambi칠n la barra de pintura si est치 abierta
            if (document.getElementById('shiftsPopup').classList.contains('show')) {
                renderShiftsForPainting();
            }
        }
        function resetShiftForm() {
            document.getElementById('shiftNameInput').value = '';
            document.getElementById('shiftAbbrevInput').value = '';
            document.getElementById('shiftColorInput').value = '#9E9E9E';
            document.getElementById('shiftStartInput').value = '';
            document.getElementById('shiftEndInput').value = '';
            delete document.getElementById('shiftNameInput').dataset.index;
        }
        async function saveShiftTemplates() {
            try { localStorage.setItem('shift_templates', JSON.stringify(shiftTemplates)); } catch (e) { }

            // Sincronizar con Firebase si est치 disponible
            if (isFirebaseConfigured && db) {
                try {
                    const batch = db.batch();
                    shiftTemplates.forEach(t => {
                        // Crear un ID si no tiene uno
                        const id = t.id || t.name;
                        const ref = db.collection('shifts').doc(String(id));
                        batch.set(ref, {
                            name: t.name || '',
                            abbreviation: t.abbreviation || '',
                            backgroundColor: t.backgroundColor || '',
                            startTime: t.startTime || '',
                            endTime: t.endTime || '',
                            order: shiftTemplates.indexOf(t)
                        });
                    });
                    await batch.commit();
                } catch (e) {
                    console.error('Error sincronizando turnos con Firebase:', e);
                }
            }
        }
        function saveShiftTemplate() {
            const name = document.getElementById('shiftNameInput').value.trim();
            const abbr = document.getElementById('shiftAbbrevInput').value.trim();
            const color = document.getElementById('shiftColorInput').value;
            const start = document.getElementById('shiftStartInput').value;
            const end = document.getElementById('shiftEndInput').value;
            const idxRaw = document.getElementById('shiftNameInput').dataset.index;
            const tpl = { name, abbreviation: abbr, backgroundColor: color, startTime: start, endTime: end };
            if (idxRaw !== undefined) {
                const i = parseInt(idxRaw);
                shiftTemplates[i] = { ...(shiftTemplates[i] || {}), ...tpl };
            } else {
                shiftTemplates.push(tpl);
            }
            saveShiftTemplates();
            resetShiftForm();
            renderShiftTemplatesList();
            renderShiftsForPainting();
            showToast('九 Turno guardado');
        }
        function deleteShiftTemplate(i) {
            shiftTemplates.splice(i, 1);
            saveShiftTemplates();
            renderShiftTemplatesList();
            renderShiftsForPainting();
            showToast('游딈勇 Turno eliminado');
        }

        // Funci칩n auxiliar para obtener color de contraste
        function getContrastColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }



        // ============================================
        // INICIALIZACI칍N
        // ============================================
        async function init() {
            // Cargar datos vitales
            await loadUsersData();
            await loadShiftTemplates();
            loadSavedTheme();

            // Iniciar sincronizaci칩n real si estamos en l칤nea
            if (isFirebaseConfigured && db) {
                setupRealtimeListener();
                showToast('游닆 Chronicon conectado a las Cr칩nicas Reales');
            } else {
                showToast('游닆 Chronicon cargado en Modo Demo');
            }

            renderHome();
            updateMonthTitle();
            renderCalendar();
            updateHomeAvatar();
        }

        // Inicializar cuando cargue la p치gina
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // Cerrar modales al hacer clic fuera
        document.getElementById('dayModal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('notesModal').addEventListener('click', function (e) {
            if (e.target === this) closeNotesModal();
        });
    </script>
</body>

</html>